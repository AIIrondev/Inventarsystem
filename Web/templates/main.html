<!--
   Copyright 2025 Maximilian Gründinger

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
{% extends "base.html" %}

{% block title %}Inventarsystem{% endblock %}

{% block content %}
<div class="container">
    <div class="content">
        <h1>Inventar Objekte</h1>
        <div class="filter-container">
            <div class="filter-group">
                <div class="filter-header">
                    <label>Filter 1:</label>
                    <button type="button" class="filter-toggle" onclick="toggleFilterDropdown('filter1-dropdown')">▼</button>
                    <button type="button" class="clear-filter" onclick="clearFilter(1)">Clear</button>
                </div>
                <div class="selected-filters" id="selected-filter1"></div>
                <div class="filter-dropdown" id="filter1-dropdown">
                    <div class="filter-options" id="filter1-options">
                        <!-- Filter options will be dynamically loaded here -->
                    </div>
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-header">
                    <label>Filter 2:</label>
                    <button type="button" class="filter-toggle" onclick="toggleFilterDropdown('filter2-dropdown')">▼</button>
                    <button type="button" class="clear-filter" onclick="clearFilter(2)">Clear</button>
                </div>
                <div class="selected-filters" id="selected-filter2"></div>
                <div class="filter-dropdown" id="filter2-dropdown">
                    <div class="filter-options" id="filter2-options">
                        <!-- Filter options will be dynamically loaded here -->
                    </div>
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-header">
                    <label>Filter 3:</label>
                    <button type="button" class="filter-toggle" onclick="toggleFilterDropdown('filter3-dropdown')">▼</button>
                    <button type="button" class="clear-filter" onclick="clearFilter(3)">Clear</button>
                </div>
                <div class="selected-filters" id="selected-filter3"></div>
                <div class="filter-dropdown" id="filter3-dropdown">
                    <div class="filter-options" id="filter3-options">
                        <!-- Filter options will be dynamically loaded here -->
                    </div>
                </div>
            </div>
        </div>
        <div class="qr-container">
            <button id="scanButton" class="scan-button">QR-Code scannen</button>
            <div id="qr-reader" style="width: 500px; display: none;"></div>
        </div>
        <div id="items-container" class="items-container">
            <!-- Items will be dynamically loaded here -->
        </div>
        <div class="navigation-buttons">
            <button class="prev-button" onclick="scrollPrev()">&#10094;</button>
            <button class="next-button" onclick="scrollNext()">&#10095;</button>
        </div>
    </div>
    </div>
    <div id="item-modal" class="item-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="modal-content-wrapper">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>
</div>
<script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
<script>
    // Initialize QR Code scanner
    // TODO: only allow one Back camera only
    let html5QrcodeScanner = null;
    
    document.getElementById('scanButton').addEventListener('click', function() {
        const qrReader = document.getElementById('qr-reader');
        
        if (qrReader.style.display === 'none') {
            qrReader.style.display = 'block';
            
            html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader", { fps: 10, qrbox: 250 }
            );
            
            html5QrcodeScanner.render((decodedText) => {
                html5QrcodeScanner.clear();
                qrReader.style.display = 'none';
                
                // Navigate to the item
                window.location.href = decodedText;
            });
            
            this.textContent = 'Scanner schließen';
        } else {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
            }
            qrReader.style.display = 'none';
            this.textContent = 'QR-Code scannen';
        }
    });

    // Check if a new item was just created to show download link
    const urlParams = new URLSearchParams(window.location.search);
    const newItemId = urlParams.get('new_item_id');
    const highlightItemId = "{{ highlight_item }}" || '';
    
    if (newItemId) {
        const notification = document.createElement('div');
        notification.className = 'qr-notification';
        notification.innerHTML = `
            <p>QR-Code für neues Item:</p>
            <a href="{{ url_for('get_qr_code', id='') }}${newItemId}" class="qr-download">QR-Code herunterladen</a>
        `;
        document.querySelector('.container').prepend(notification);
        
        // Auto-remove notification after 10 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 1000);
        }, 10000);
    }

    // Add this variable to store the current username
    let currentUsername = '';

    document.addEventListener('DOMContentLoaded', function() {
        // Fetch user status to get current username
        fetch('/user_status')
            .then(response => response.json())
            .then(data => {
                currentUsername = data.username;
                // Now load items with username information
                loadItems();
            })
            .catch(error => {
                console.error('Error fetching user status:', error);
                loadItems(); // Load items anyway in case of error
            });
    });

    // Global variables to store active filters
    let activeFilters = {
        filter1: [],
        filter2: [],
        filter3: []
    };

    function loadItems() {
        fetch("{{ url_for('get_items') }}")
            .then(response => response.json())
            .then(data => {
                const itemsContainer = document.querySelector('#items-container');
                // Creating a Set to store unique filter values
                const filter1Values = new Set();
                const filter2Values = new Set();
                const filter3Values = new Set();
                
                // Clear the container first
                itemsContainer.innerHTML = '';
                
                data.items.forEach(item => {
                    const card = document.createElement('div');
                    card.classList.add('item-card');
                    
                    // Add class to make card clickable 
                    card.classList.add('clickable-card');
                    
                    // Add highlight class if this is the item we're looking for
                    if (item._id === highlightItemId) {
                        card.classList.add('highlight-item');
                        setTimeout(() => {
                            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 500);
                    }
                    
                    // Process and store filter values with consistent handling
                    const filter1Array = Array.isArray(item.Filter) ? item.Filter : (item.Filter ? [item.Filter] : []);
                    const filter2Array = Array.isArray(item.Filter2) ? item.Filter2 : (item.Filter2 ? [item.Filter2] : []);
                    const filter3Array = Array.isArray(item.Filter3) ? item.Filter3 : (item.Filter3 ? [item.Filter3] : []);
                    
                    // Store arrays on the card as data attributes
                    card.dataset.filter1 = JSON.stringify(filter1Array);
                    card.dataset.filter2 = JSON.stringify(filter2Array);
                    card.dataset.filter3 = JSON.stringify(filter3Array);
                    
                    // Add filter values to their respective sets - all values should be strings
                    filter1Array.forEach(value => {
                        if (value && typeof value === 'string' && value.trim() !== '') {
                            filter1Values.add(value);
                        }
                    });
                    
                    filter2Array.forEach(value => {
                        if (value && typeof value === 'string' && value.trim() !== '') {
                            filter2Values.add(value);
                        }
                    });
                    
                    filter3Array.forEach(value => {
                        if (value && typeof value === 'string' && value.trim() !== '') {
                            filter3Values.add(value);
                        }
                    });

                    // Display first filter value or dash if none exist
                    const filter1Display = filter1Array.length > 0 ? filter1Array[0] : '-';
                    const filter2Display = filter2Array.length > 0 ? filter2Array[0] : '-';
                    const filter3Display = filter3Array.length > 0 ? filter3Array[0] : '-';
                    
                    // Additional filter values indicator
                    const filter1More = filter1Array.length > 1 ? ` (+${filter1Array.length - 1} mehr)` : '';
                    const filter2More = filter2Array.length > 1 ? ` (+${filter2Array.length - 1} mehr)` : '';
                    const filter3More = filter3Array.length > 1 ? ` (+${filter3Array.length - 1} mehr)` : '';

                    const imagesHtml = item.Images.map((image, index) => `<img src="{{ url_for('uploaded_file', filename='') }}${image}" alt="${item.Name}" class="item-image" data-index="${index}" style="display: ${index === 0 ? 'block' : 'none'};">`).join('');
                    
                    // Check if item is borrowed by current user
                    const isBorrowedByMe = !item.Verfuegbar && item.User === currentUsername;
                    
                    // Add borrower info badge if item is borrowed
                    let borrowerBadge = '';
                    if (!item.Verfuegbar && item.BorrowerInfo) {
                        borrowerBadge = `
                            <div class="borrower-badge">
                                Ausgeliehen von: <strong>${item.BorrowerInfo.username}</strong>
                                ${item.BorrowerInfo.borrowTime ? '<br><span class="borrow-time">Seit: ' + item.BorrowerInfo.borrowTime + '</span>' : ''}
                            </div>`;
                    }

                    card.innerHTML = `
                        <div class="card-content" data-item-id="${item._id}">
                            <h3>${item.Name}</h3>
                            <p><strong>Ort:</strong> ${item.Ort || '-'}</p>
                            <p><strong>Filter 1:</strong> ${filter1Display}${filter1More}</p>
                            <p><strong>Filter 2:</strong> ${filter2Display}${filter2More}</p>
                            <p><strong>Filter 3:</strong> ${filter3Display}${filter3More}</p>
                            <div class="image-container">
                                ${imagesHtml}
                                <button class="prev-image-button" onclick="prevImage(event)">&#10094;</button>
                                <button class="next-image-button" onclick="nextImage(event)">&#10095;</button>
                            </div>
                            ${borrowerBadge}
                        </div>
                        <div class="actions">
                            ${item.Verfuegbar ? 
                                `<form method="POST" action="{{ url_for('ausleihen', id='') }}${item._id}">
                                    <button class="ausleihen" type="submit">Ausleihen</button>
                                </form>` 
                            : isBorrowedByMe ?
                                `<form method="POST" action="{{ url_for('zurueckgeben', id='') }}${item._id}">
                                    <button class="ausleihen" type="submit">Zurückgeben</button>
                                </form>`
                            :
                                `<button class="ausleihen disabled-button" disabled>Ausgeliehen</button>`
                            }
                        </div>
                    `;
                    itemsContainer.appendChild(card);

                    // Add click event to open modal
                    card.addEventListener('click', () => {
                        openItemModal(item);
                    });
                });
                // Populate filter options
                populateFilterOptions('filter1-options', [...filter1Values].sort(), 1);
                populateFilterOptions('filter2-options', [...filter2Values].sort(), 2);
                populateFilterOptions('filter3-options', [...filter3Values].sort(), 3);
                
                // Center the first card
                const cardWidth = itemsContainer.querySelector('.item-card')?.offsetWidth || 0;
                if (cardWidth > 0) {
                    itemsContainer.scrollLeft = (itemsContainer.scrollWidth - cardWidth) / 2;
                }
                
                // Nach dem Laden der Items Filter anwenden
                applyFilters();
            })
            .catch(error => console.error('Error fetching items:', error));
    }

    function checkFilterMatch(activeFilterValues, itemFilterValuesJSON) {
        // If no filters are selected, all items pass
        if (activeFilterValues.length === 0) {
            return true;
        }
        
        try {
            // Parse the JSON array of filter values from the item
            const itemFilterValues = JSON.parse(itemFilterValuesJSON);
            
            // Extract the values from each active filter (after the ":" if present)
            const matchingValues = activeFilterValues.map(filter => {
                if (filter.includes(':')) {
                    return filter.split(':')[1];
                }
                return filter;
            });
            
            
            // Check if ANY of the item's filter values match ANY of the active filters
            for (const itemValue of itemFilterValues) {
                if (matchingValues.includes(itemValue)) {
                    return true;
                }
            }
            
            // No match found
            return false;
        } catch (e) {
            console.error("Error parsing filter values:", e);
            if (typeof itemFilterValuesJSON === 'string' && activeFilterValues.includes(itemFilterValuesJSON)) {
                // Fallback for string comparisons
                return true;
            }
            return false;
        }
    }

    function populateFilterOptions(containerId, filterValues, filterNum) {
        const container = document.getElementById(containerId);
        container.innerHTML = ''; // Clear previous options
        
        // Group values to create option groups
        const groupedValues = {};
        
        // Process filter values to group them
        filterValues.forEach(filterName => {
            if (!filterName) return; // Skip empty values
            
            // Check if the value contains a ":" to separate option group from value
            if (filterName.includes(":")) {
                const [groupName, value] = filterName.split(":", 2);
                if (!groupedValues[groupName]) {
                    groupedValues[groupName] = [];
                }
                groupedValues[groupName].push(value);
            } else {
                // Default group for values without a group prefix
                if (!groupedValues["Option1"]) {
                    groupedValues["Option1"] = [];
                }
                groupedValues["Option1"].push(filterName);
            }
        });
        
        // Create option groups
        Object.keys(groupedValues).sort().forEach(groupName => {
            // Create option group container
            const optionGroup = document.createElement('div');
            optionGroup.className = 'filter-option-group';
            
            // Create group header
            const groupHeader = document.createElement('div');
            groupHeader.className = 'filter-group-header';
            groupHeader.textContent = groupName;
            optionGroup.appendChild(groupHeader);
            
            // Create options within this group
            const values = groupedValues[groupName].sort();
            values.forEach(value => {
                const option = document.createElement('div');
                option.className = 'filter-option';
                
                // Create unique ID for the checkbox (avoid spaces and special characters)
                const safeValue = value.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-_]/g, '');
                const safeGroup = groupName.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-_]/g, '');
                const checkboxId = `filter${filterNum}-${safeGroup}-${safeValue}`;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = checkboxId;
                checkbox.value = value;
                checkbox.dataset.group = groupName;
                
                // Check if this value is already active
                const fullValue = `${groupName}:${value}`;
                checkbox.checked = activeFilters[`filter${filterNum}`].includes(fullValue);
                
                checkbox.onchange = () => updateFilter(filterNum, value, checkbox.checked, groupName);
                
                const label = document.createElement('label');
                label.htmlFor = checkboxId;
                label.textContent = value;
                
                option.appendChild(checkbox);
                option.appendChild(label);
                optionGroup.appendChild(option);
            });
            
            container.appendChild(optionGroup);
        });
    }

    // Updated function to apply filters to items
    function applyFilters() {
        const itemsContainer = document.querySelector('#items-container');
        const items = itemsContainer.querySelectorAll('.item-card');
        
        let visibleCount = 0;
        items.forEach(item => {
            const itemFilter1 = item.dataset.filter1;
            const itemFilter2 = item.dataset.filter2;
            const itemFilter3 = item.dataset.filter3;
            
            // Check if item matches the active filters
            const matchesFilter1 = checkFilterMatch(activeFilters.filter1, itemFilter1);
            const matchesFilter2 = checkFilterMatch(activeFilters.filter2, itemFilter2);
            const matchesFilter3 = checkFilterMatch(activeFilters.filter3, itemFilter3);
            
            // All three filter categories must match (AND operation between categories)
            if (matchesFilter1 && matchesFilter2 && matchesFilter3) {
                item.style.display = 'block';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        
        // After filtering, reset scroll position to show the first visible card
        const firstVisibleCard = itemsContainer.querySelector('.item-card[style="display: block"]');
        if (firstVisibleCard) {
            firstVisibleCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
        }
    }

    // Function to close the edit modal
    function closeEditModal() {
        document.getElementById('edit-modal').style.display = 'none';
    }

    // Function to open modal with item details - completely rewritten
    function openItemModal(itemData) {
        
        const modalContent = document.getElementById('modal-content-wrapper');
        const modal = document.getElementById('item-modal');
        
        // Get filter values - handle arrays properly, join with commas and handle missing values
        const filter1Value = Array.isArray(itemData.Filter) ? itemData.Filter.filter(Boolean).join(", ") : 
                            (itemData.Filter || '-');
        const filter2Value = Array.isArray(itemData.Filter2) ? itemData.Filter2.filter(Boolean).join(", ") : 
                            (itemData.Filter2 || '-');
        const filter3Value = Array.isArray(itemData.Filter3) ? itemData.Filter3.filter(Boolean).join(", ") : 
                            (itemData.Filter3 || '-');
        
        // Create image gallery - fix image URLs by ensuring they're complete URLs
        let imagesHtml = '';
        if (itemData.Images && itemData.Images.length > 0) {
            imagesHtml = `
                <div class="modal-image-container">
                    ${itemData.Images.map((image, index) => {
                        // Check if image is a full URL or just a path
                        const imageUrl = image.startsWith('http') || image.startsWith('/uploads/') ? 
                            image : `/uploads/${image}`;
                        
                        return `<img src="${imageUrl}" alt="${itemData.Name}" class="modal-image" 
                         data-index="${index}" style="display: ${index === 0 ? 'block' : 'none'};">`;
                    }).join('')}
                    ${itemData.Images.length > 1 ? `
                        <button class="modal-image-nav modal-prev-image" onclick="prevModalImage()">&#10094;</button>
                        <button class="modal-image-nav modal-next-image" onclick="nextModalImage()">&#10095;</button>
                    ` : ''}
                </div>
            `;
        }
        
        // Check if item is borrowed by current user
        const isBorrowedByMe = !itemData.Verfuegbar && itemData.User === currentUsername;
        
        // Create borrower info section
        let borrowerInfo = '';
        if (!itemData.Verfuegbar && itemData.BorrowerInfo) {
            borrowerInfo = `
                <div class="borrower-info-panel">
                    <h4>Ausgeliehen von</h4>
                    <div class="borrower-details">
                        <p class="borrower-name">${itemData.BorrowerInfo.username}</p>
                        <p class="borrow-time">Seit: ${itemData.BorrowerInfo.borrowTime || 'Unbekannt'}</p>
                    </div>
                </div>
            `;
        }
        
        // Build complete modal content
        modalContent.innerHTML = `
            <h2>${itemData.Name}</h2>
            ${imagesHtml}
            <div class="modal-details">
                <div class="detail-section">
                    <div class="detail-group">
                        <div class="detail-label">Ort:</div>
                        <div class="detail-value">${itemData.Ort || '-'}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Filter 1:</div>
                        <div class="detail-value">${filter1Value}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Filter 2:</div>
                        <div class="detail-value">${filter2Value}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Filter 3:</div>
                        <div class="detail-value">${filter3Value}</div>
                    </div>
                </div>
                <div class="detail-section">
                    <div class="detail-group">
                        <div class="detail-label">Anschaffungsjahr:</div>
                        <div class="detail-value">${itemData.Anschaffungsjahr || '-'}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Anschaffungskosten:</div>
                        <div class="detail-value">${itemData.Anschaffungskosten ? itemData.Anschaffungskosten + ' €' : '-'}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Status:</div>
                        <div class="detail-value ${!itemData.Verfuegbar ? 'status-borrowed' : ''}">${itemData.Verfuegbar ? 'Verfügbar' : 'Ausgeliehen'}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Code:</div>
                        <div class="detail-value">${itemData.Code_4 || '-'}</div>
                    </div>
                </div>
            </div>
            ${borrowerInfo}
            <div class="detail-group full-width">
                <div class="detail-label">Beschreibung:</div>
                <div class="detail-value">${itemData.Beschreibung || '-'}</div>
            </div>
            <div class="modal-actions">
                ${itemData.Verfuegbar ? 
                    `<form method="POST" action="/ausleihen/${itemData._id}">
                        <button class="ausleihen" type="submit">Ausleihen</button>
                    </form>` 
                : isBorrowedByMe ?
                    `<form method="POST" action="/zurueckgeben/${itemData._id}">
                        <button class="ausleihen" type="submit">Zurückgeben</button>
                    </form>`
                :
                    `<button class="ausleihen disabled-button" disabled>Ausgeliehen</button>`
                }
            </div>
        `;
        
        // Add event listener for the close button
        const closeBtn = modal.querySelector('.close-modal');
        if (closeBtn) {
            closeBtn.onclick = function() {
                closeModal(modal);
            };
        }
        
        // Make sure the modal is visible
        modal.style.display = 'block';
    }
    
    // Function to close modal
    function closeModal(modal) {
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // Add event listener to close modal when clicking outside
    window.addEventListener('click', function(event) {
        const modals = document.querySelectorAll('.item-modal');
        modals.forEach(function(modal) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
    
    // Image navigation in modal - make sure these functions exist
    function prevModalImage() {
        const images = document.querySelectorAll('.modal-image');
        if (images.length <= 1) return;
        
        let currentIndex = Array.from(images).findIndex(img => img.style.display === 'block');
        if (currentIndex === -1) currentIndex = 0;
        
        images[currentIndex].style.display = 'none';
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        images[currentIndex].style.display = 'block';
    }

    function nextModalImage() {
        const images = document.querySelectorAll('.modal-image');
        if (images.length <= 1) return;
        
        let currentIndex = Array.from(images).findIndex(img => img.style.display === 'block');
        if (currentIndex === -1) currentIndex = 0;
        
        images[currentIndex].style.display = 'none';
        currentIndex = (currentIndex + 1) % images.length;
        images[currentIndex].style.display = 'block';
    }

    // Add missing filter toggle function
    function toggleFilterDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        
        // Close all other dropdowns first
        document.querySelectorAll('.filter-dropdown').forEach(dd => {
            if (dd.id !== dropdownId) {
                dd.style.display = 'none';
            }
        });
        
        // Toggle this dropdown
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }
    
    // Add missing filter clear function
    function clearFilter(filterNum) {
        // Reset the active filters for this category
        activeFilters[`filter${filterNum}`] = [];
        
        // Clear the selected filters display
        document.getElementById(`selected-filter${filterNum}`).innerHTML = '';
        
        // Uncheck all checkboxes
        const checkboxes = document.querySelectorAll(`#filter${filterNum}-options input[type="checkbox"]`);
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // Apply the updated filters
        applyFilters();
    }
    
    // Add function to update filter when checkbox changes
    function updateFilter(filterNum, value, isChecked, group = '') {
        const filterKey = `filter${filterNum}`;
        // Add group prefix if provided
        const filterValue = group ? `${group}:${value}` : value;
        
        if (isChecked) {
            // Add filter value if not already present
            if (!activeFilters[filterKey].includes(filterValue)) {
                activeFilters[filterKey].push(filterValue);
            }
        } else {
            // Remove filter value
            activeFilters[filterKey] = activeFilters[filterKey].filter(v => v !== filterValue);
        }
        
        // Update the filter display
        updateSelectedFilters(filterNum);
        
        // Apply the filters
        applyFilters();
    }
    
    // Add function to display selected filters
    function updateSelectedFilters(filterNum) {
        const container = document.getElementById(`selected-filter${filterNum}`);
        container.innerHTML = '';
        
        activeFilters[`filter${filterNum}`].forEach(filter => {
            // Extract display value from filter
            let displayValue = filter;
            let groupName = '';
            
            // Handle group:value format
            if (filter.includes(':')) {
                [groupName, displayValue] = filter.split(':');
            }
            
            // Create filter tag
            const tag = document.createElement('div');
            tag.className = 'filter-tag';
            
            // Show group if present
            let tagContent = '';
            if (groupName) {
                tagContent += `<span class="filter-tag-group">${groupName}:</span>`;
            }
            
            // Add filter value and remove button
            tagContent += displayValue;
            tagContent += `<button class="filter-tag-remove" onclick="removeFilter(${filterNum}, '${filter}')">&times;</button>`;
            
            tag.innerHTML = tagContent;
            container.appendChild(tag);
        });
    }
    
    // Add function to remove filter when clicking X
    function removeFilter(filterNum, filter) {
        const filterKey = `filter${filterNum}`;
        
        // Remove from active filters
        activeFilters[filterKey] = activeFilters[filterKey].filter(f => f !== filter);
        
        // Update UI
        updateSelectedFilters(filterNum);
        
        // Uncheck corresponding checkbox if exists
        let value = filter;
        let group = '';
        
        if (filter.includes(':')) {
            [group, value] = filter.split(':');
        }
        
        // Find and uncheck the checkbox
        const checkboxes = document.querySelectorAll(`#filter${filterNum}-options input[type="checkbox"]`);
        checkboxes.forEach(checkbox => {
            if ((checkbox.value === value) && 
                ((!group && !checkbox.dataset.group) || 
                 (group && checkbox.dataset.group === group))) {
                checkbox.checked = false;
            }
        });
        
        // Apply the filters
        applyFilters();
    }

    // Fix populateFilterOptions to correctly set up filter checkboxes
    function populateFilterOptions(containerId, filterValues, filterNum) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        // Check for option groups in values
        const optionGroups = {};
        filterValues.forEach(value => {
            if (!value) return;
            
            // Check if value contains a group separator
            if (value.includes(':')) {
                const [group, val] = value.split(':', 2);
                if (!optionGroups[group]) {
                    optionGroups[group] = [];
                }
                optionGroups[group].push(val);
            } else {
                // Default group for ungrouped values
                if (!optionGroups['Werte']) {
                    optionGroups['Werte'] = [];
                }
                optionGroups['Werte'].push(value);
            }
        });
        
        // If no groups were found, create simple checkbox list
        if (Object.keys(optionGroups).length === 0) {
            filterValues.forEach(value => {
                if (!value) return;
                
                const option = document.createElement('div');
                option.className = 'filter-option';
                
                const id = `filter${filterNum}-${value.replace(/\s+/g, '_')}`;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = id;
                checkbox.value = value;
                checkbox.checked = activeFilters[`filter${filterNum}`].includes(value);
                checkbox.onchange = () => updateFilter(filterNum, value, checkbox.checked);
                
                const label = document.createElement('label');
                label.htmlFor = id;
                label.textContent = value;
                
                option.appendChild(checkbox);
                option.appendChild(label);
                container.appendChild(option);
            });
        } else {
            // Create grouped options
            Object.keys(optionGroups).sort().forEach(group => {
                const values = optionGroups[group];
                if (!values.length) return;
                
                const groupDiv = document.createElement('div');
                groupDiv.className = 'filter-option-group';
                
                const header = document.createElement('div');
                header.className = 'filter-group-header';
                header.textContent = group;
                groupDiv.appendChild(header);
                
                values.sort().forEach(value => {
                    const option = document.createElement('div');
                    option.className = 'filter-option';
                    
                    const id = `filter${filterNum}-${group}-${value.replace(/\s+/g, '_')}`;
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = id;
                    checkbox.value = value;
                    checkbox.dataset.group = group;
                    
                    // Check if this value is already active
                    const filterValue = group === 'Werte' ? value : `${group}:${value}`;
                    checkbox.checked = activeFilters[`filter${filterNum}`].includes(filterValue);
                    
                    checkbox.onchange = () => updateFilter(filterNum, value, checkbox.checked, 
                        group === 'Werte' ? '' : group);
                    
                    const label = document.createElement('label');
                    label.htmlFor = id;
                    label.textContent = value;
                    
                    option.appendChild(checkbox);
                    option.appendChild(label);
                    groupDiv.appendChild(option);
                });
                
                container.appendChild(groupDiv);
            });
        }
        
        // Update the selected filters display
        updateSelectedFilters(filterNum);
    }
    
    // Fix check filter match function to properly handle multiple filter values
    function checkFilterMatch(activeFilterValues, itemFilterValuesJSON) {
        // If no active filters, all items match
        if (!activeFilterValues || activeFilterValues.length === 0) {
            return true;
        }
        
        try {
            // Parse item filter values
            const itemFilterValues = JSON.parse(itemFilterValuesJSON || '[]');
            
            // If item has no values, it can't match any filters
            if (!itemFilterValues || itemFilterValues.length === 0) {
                return false;
            }
            
            // Check if ANY active filter values match ANY item filter values
            for (const activeFilter of activeFilterValues) {
                // Extract value from activeFilter (remove group prefix if exists)
                const activeValue = activeFilter.includes(':') 
                    ? activeFilter.split(':')[1] 
                    : activeFilter;
                
                // Check if any item filter value matches this active filter
                if (itemFilterValues.includes(activeValue)) {
                    return true;
                }
            }
            
            // No match found
            return false;
        } catch (err) {
            console.error("Error in checkFilterMatch:", err);
            return false;
        }
    }
    
    // Update applyFilters to correctly apply all filters
    function applyFilters() {
        const itemsContainer = document.querySelector('#items-container');
        const items = itemsContainer.querySelectorAll('.item-card');
        
        let visibleCount = 0;
        items.forEach(item => {
            const itemFilter1 = item.dataset.filter1;
            const itemFilter2 = item.dataset.filter2;
            const itemFilter3 = item.dataset.filter3;
            
            // Check if item matches the active filters
            const matchesFilter1 = checkFilterMatch(activeFilters.filter1, itemFilter1);
            const matchesFilter2 = checkFilterMatch(activeFilters.filter2, itemFilter2);
            const matchesFilter3 = checkFilterMatch(activeFilters.filter3, itemFilter3);
            
            // All three filter categories must match (AND between categories)
            if (matchesFilter1 && matchesFilter2 && matchesFilter3) {
                item.style.display = 'block';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        // Show first visible card
        if (visibleCount > 0) {
            const firstVisibleCard = itemsContainer.querySelector('.item-card[style="display: block"]');
            if (firstVisibleCard) {
                firstVisibleCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
    }

    // Add missing scroll functions
    function scrollPrev() {
        const container = document.querySelector('#items-container');
        const cardWidth = container.querySelector('.item-card')?.offsetWidth || 300;
        const gap = 20; // Match the gap in CSS
        
        // Scroll one card width to the left + gap
        container.scrollBy({
            left: -1 * (cardWidth + gap),
            behavior: 'smooth'
        });
    }

    function scrollNext() {
        const container = document.querySelector('#items-container');
        const cardWidth = container.querySelector('.item-card')?.offsetWidth || 300;
        const gap = 20; // Match the gap in CSS
        
        // Scroll one card width to the right + gap
        container.scrollBy({
            left: cardWidth + gap,
            behavior: 'smooth'
        });
    }

    // Add functions for image navigation in item cards
    function prevImage(event) {
        event.stopPropagation(); // Prevent card click event
        const container = event.target.closest('.image-container');
        const images = container.querySelectorAll('.item-image');
        let currentIndex = Array.from(images).findIndex(img => img.style.display === 'block');
        
        images[currentIndex].style.display = 'none';
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        images[currentIndex].style.display = 'block';
    }

    function nextImage(event) {
        event.stopPropagation(); // Prevent card click event
        const container = event.target.closest('.image-container');
        const images = container.querySelectorAll('.item-image');
        let currentIndex = Array.from(images).findIndex(img => img.style.display === 'block');
        
        images[currentIndex].style.display = 'none';
        currentIndex = (currentIndex + 1) % images.length;
        images[currentIndex].style.display = 'block';
    }
</script>

<style>
body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    margin: 0;
    padding: 0;
}

.container {
    background-color: #fff;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    width: 80%;
    max-width: 1200px;
    margin: 20px auto;
}

h1, h2 {
    text-align: center;
}

.filter-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    margin-bottom: 20px;
}

.filter-group {
    position: relative;
    min-width: 200px;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
}

.filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.filter-toggle, .clear-filter {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 3px;
    padding: 3px 8px;
    cursor: pointer;
}

.clear-filter {
    font-size: 0.8rem;
    color: #6c757d;
}

.filter-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    max-height: 300px; /* Increased height */
    overflow-y: auto;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 100;
    padding: 8px;
}

.filter-options {
    padding: 10px;
}

.filter-option {
    margin-bottom: 5px;
    display: flex;
    align-items: center;
}

.filter-option input[type="checkbox"] {
    width: 16px;
    height: 16px;
    margin-right: 8px;
    cursor: pointer;
}

.filter-option:hover {
    background-color: #f5f5f5;
}

.filter-option label {
    margin-left: 5px;
    cursor: pointer;
}

.filter-option-group {
    margin-bottom: 12px;
    border-bottom: 1px solid #eee;
    padding-bottom: 8px;
}

.filter-group-header {
    font-weight: bold;
    margin-bottom: 5px;
    color: #495057;
    font-size: 0.9rem;
}

.selected-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    min-height: 30px;
}

.filter-tag {
    display: inline-flex;
    align-items: center;
    background-color: #e9ecef;
    border-radius: 15px;
    padding: 3px 10px;
    font-size: 0.8rem;
}

.filter-tag-group {
    color: #6c757d;
    font-size: 0.8em;
    font-style: italic;
    margin-right: 2px;
}

.filter-tag-remove {
    background: none;
    border: none;
    color: #6c757d;
    margin-left: 5px;
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
}

.items-container {
    display: flex;
    overflow-x: auto; /* Change from hidden to auto */
    gap: 20px;
    padding: 20px 0;
    scroll-snap-type: x mandatory;
}

.item-card {
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    padding: 20px;
    max-width: 300px;
    flex-shrink: 0;
    scroll-snap-align: center;
    cursor: pointer;
    transition: transform 0.2s;
}

.item-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.item-card h3 {
    margin-top: 0;
}

.item-card .description {
    max-height: 100px;
    overflow-y: auto;
}

.item-card .image-container {
    position: relative;
    max-width: 300px;
    margin: 10px 0;
}

.item-card .item-image {
    width: 100%;
    height: auto;
    max-height: 300px; /* Set a maximum height for the images */
    display: none;
    object-fit: cover;
}

.item-card .item-image:first-child {
    display: block;
}

.prev-image-button, .next-image-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background-color: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    cursor: pointer;
    padding: 5px;
    border-radius: 5px;
}

.prev-image-button {
    left: -30px;
}

.next-image-button {
    right: -30px;
}

.actions {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 10px;
}

.actions form, 
.actions a {
    flex: 1 1 calc(33% - 5px);
    min-width: fit-content;
}

.actions form button,
.actions a {
    width: 100%;
    font-size: 0.85rem;
    padding: 8px 5px;
    text-align: center;
}

button.ausleihen {
    flex: 1;
    padding: 10px;
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

button.ausleihen:hover {
    background-color: #0056b3;
}

a.delete-button {
    flex: 1;
    padding: 10px;
    background-color: #dc3545;
    color: #fff;
    text-align: center;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    text-decoration: none;
}

a.delete-button:hover {
    background-color: #c82333;
}

.upload-form {
    margin-top: 20px;
}

.form-group {
    margin-bottom: 15px;
}

label {
    display: block;
    margin-bottom: 5px;
}

input[type="text"],
textarea,
input[type="file"] {
    width: 100%;
    padding: 8px;
    box-sizing: border-box;
}

.flash {
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 5px;
}

.flash.success {
    background-color: #d4edda;
    color: #155724;
}

.flash.error {
    background-color: #f8d7da;
    color: #721c24;
}

.navigation-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
}

.navigation-buttons .prev-button,
 .navigation-buttons .next-button {
    background-color: #007bff;
    color: #fff;
    border: none;
    cursor: pointer;
    padding: 10px;
    border-radius: 5px;
}

.navigation-buttons .prev-button:hover,
.navigation-buttons .next-button:hover {
    background-color: #0056b3;
}

.qr-scanner {
    margin-top: 20px;
    text-align: center;
}

@media (max-width: 768px) {
    .container {
        width: 95%;
    }
    .item-card {
        min-width: 250px;
    }
    .filter-container {
        flex-direction: column;
        align-items: center;
    }
}

@media (max-width: 480px) {
    .container {
        width: 98%;
        padding: 10px;
    }
    .item-card {
        min-width: 200px;
    }
}

.qr-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 20px;
}

.scan-button {
    padding: 10px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-bottom: 10px;
}

.scan-button:hover {
    background-color: #0056b3;
}

#qr-reader {
    margin: 0 auto;
    max-width: 100%;
}

.qr-download-button {
    display: inline-block;
    margin-left: 5px;
    padding: 5px 10px;
    background-color: #28a745;
    color: white;
    text-decoration: none;
    border-radius: 3px;
    font-size: 0.8em;
}

.qr-notification {
    background-color: #d4edda;
    color: #155724;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 5px;
    text-align: center;
    transition: opacity 1s ease;
}

.qr-download {
    display: inline-block;
    padding: 5px 15px;
    background-color: #28a745;
    color: white;
    text-decoration: none;
    border-radius: 3px;
    margin-left: 10px;
}

.highlight-item {
    border: 3px solid #ffc107;
    box-shadow: 0 0 15px rgba(255, 193, 7, 0.5);
    animation: highlight-pulse 2s infinite;
}

@keyframes highlight-pulse {
    0% { box-shadow: 0 0 10px rgba(255, 193, 7, 0.5); }
    50% { box-shadow: 0 0 20px rgba(255, 193, 7, 0.8); }
    100% { box-shadow: 0 0 10px rgba(255, 193, 7, 0.5); }
}

.disabled-button {
    background-color: #6c757d;
    cursor: not-allowed;
    opacity: 0.65;
}

.borrow-limit-banner {
    background-color: #ffc107;
    color: #212529;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 5px;
    text-align: center;
}

/* Modal Styles */
.item-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    overflow-y: auto;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
}

.modal-content {
    position: relative;
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border-radius: 8px;
    width: 80%;
    max-width: 900px;
    animation: slideIn 0.3s ease;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    overflow: hidden;
}

@keyframes slideIn {
    from {transform: translateY(-20px); opacity: 0;}
    to {transform: translateY(0); opacity: 1;}
}

.close-modal {
    position: absolute;
    top: 15px;
    right: 20px;
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    z-index: 10;
}

.close-modal:hover {
    color: #000;
}

/* Enhanced image navigation */
.modal-image-container {
    text-align: center;
    margin: 20px 0;
    position: relative;
    max-height: 500px;
    overflow: hidden;
}

.modal-image {
    max-width: 100%;
    max-height: 450px;
    border-radius: 5px;
    object-fit: contain;
}

.modal-image-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    padding: 15px;
    background-color: rgba(0,0,0,0.5);
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 50%;
    font-size: 18px;
    opacity: 0.8;
    transition: opacity 0.3s;
}

.modal-image-nav:hover {
    opacity: 1;
    background-color: rgba(0,0,0,0.7);
}

.modal-prev-image {
    left: 15px;
}

.modal-next-image {
    right: 15px;
}

.modal-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.detail-group {
    margin-bottom: 15px;
}

.detail-label {
    font-weight: bold;
    margin-bottom: 5px;
}

.detail-value {
    padding: 5px 0;
}

.modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    justify-content: flex-end;
}

.modal-actions .ausleihen,
.modal-actions .delete-button,
.modal-actions .qr-download-button {
    padding: 10px 20px;
}

.full-width {
    grid-column: 1 / -1;
}

/* Borrower badge on item cards */
.borrower-badge {
    background-color: #fff3cd;
    color: #856404;
    border-left: 4px solid #ffc107;
    padding: 8px;
    margin: 10px 0;
    font-size: 0.85em;
    border-radius: 4px;
}

.borrow-time {
    font-size: 0.9em;
    color: #6c757d;
    font-style: italic;
    display: block;
    margin-top: 3px;
}

/* Borrower panel in modal view */
.borrower-info-panel {
    margin: 15px 0;
    padding: 15px;
    background-color: #fff3cd;
    border-left: 4px solid #ffc107;
    border-radius: 4px;
}

.borrower-info-panel h4 {
    color: #856404;
    margin-top: 0;
    margin-bottom: 10px;
    font-size: 1.1em;
}

.borrower-name {
    font-weight: bold;
    margin-bottom: 5px;
}

.status-borrowed {
    color: #dc3545;
    font-weight: bold;
}

/* Borrowing details modal styles */
#borrowing-details-modal .modal-content {
    max-width: 600px;
}

.borrowing-details {
    padding: 20px 0;
    line-height: 1.6;
}

.borrowing-details p {
    margin: 10px 0;
}

.borrowing-details-btn {
    padding: 10px 20px;
    background-color: #17a2b8;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9em;
}

.borrowing-details-btn:hover {
    background-color: #138496;
}

/* Add this CSS for the edit button */
.edit-button {
    flex: 1;
    padding: 10px;
    background-color: #ffc107;
    color: #212529;
    text-align: center;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    text-decoration: none;
}

.edit-button:hover {
    background-color: #e0a800;
}

/* Edit form modal styles */
.form-row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}

.form-row .form-group {
    flex: 1;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

.save-button {
    padding: 10px 20px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.save-button:hover {
    background-color: #218838;
}

.cancel-button {
    padding: 10px 20px;
    background-color: #6c757d;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.cancel-button:hover {
    background-color: #5a6268;
}

/* Modal improvements for better responsiveness */
@media (max-width: 768px) {
    .form-row {
        flex-direction: column;
        gap: 10px;
    }
    
    .modal-content {
        width: 95%;
        padding: 15px;
    }
}

/* Styles for image management in edit form */
.existing-images-container {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 10px;
    margin-bottom: 15px;
}

.existing-image-item {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 10px;
    text-align: center;
    width: 150px;
}

.edit-thumbnail {
    width: 120px;
    height: 120px;
    object-fit: cover;
    margin-bottom: 8px;
    border-radius: 4px;
}

.image-keep-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.image-keep-controls label {
    font-size: 0.9em;
}

/* Updated styles for multi-filter inputs */
.multi-filter {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 15px;
}

.filter-inputs h3 {
    margin-top: 20px;
    margin-bottom: 10px;
    font-size: 16px;
    color: #495057;
}

/* Add styles for clickable cards */
.clickable-card {
    cursor: pointer;
    position: relative;
    transition: transform 0.2s, box-shadow 0.2s;
}

.clickable-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 20px rgba(0, 123, 255, 0.3);
}

.card-content {
    cursor: pointer;
    z-index: 1;
    position: relative;
}
</style>
{% endblock %}