{% extends "base.html" %}

{% block title %}Terminplan - Inventarsystem{% endblock %}

{% block content %}
<div class="calendar-container">
    <div class="calendar-header">
        <h1>Schulstunden-Terminplan für Ausleihen</h1>
        <div class="calendar-actions">
            <button id="prev-day">Vorheriger Tag</button>
            <span id="current-day-display"></span>
            <button id="next-day">Nächster Tag</button>
            <button id="today">Heute</button>
            <button id="new-booking" class="primary-button">Neue Reservierung</button>
            <button id="toggle-debug" class="debug-button">Debug</button>
        </div>
        <div class="calendar-legend">
            <span class="legend-item"><span class="legend-color current"></span> Aktuelle Ausleihungen</span>
            <span class="legend-item"><span class="legend-color planned"></span> Geplante Ausleihungen</span>
            <span class="legend-item"><span class="legend-color completed"></span> Abgeschlossene Ausleihungen</span>
            <span class="legend-item"><span class="legend-color your-bookings"></span> Ihre Ausleihungen</span>
        </div>
    </div>
    
    <!-- Debug panel - hidden by default -->
    <div id="debug-panel" class="debug-panel" style="display: none;">
        <h3>Debug Information</h3>
        <div class="debug-tabs">
            <button class="debug-tab-btn active" data-tab="actions">Actions</button>
            <button class="debug-tab-btn" data-tab="events">Events</button>
            <button class="debug-tab-btn" data-tab="network">Network</button>
        </div>
        <div class="debug-content">
            <div id="debug-actions" class="debug-tab active">
                <div class="debug-log" id="action-log"></div>
                <button id="clear-actions" class="small-button">Clear</button>
            </div>
            <div id="debug-events" class="debug-tab">
                <div class="debug-log" id="events-log"></div>
                <button id="clear-events" class="small-button">Clear</button>
            </div>
            <div id="debug-network" class="debug-tab">
                <div class="debug-log" id="network-log"></div>
                <button id="clear-network" class="small-button">Clear</button>
            </div>
        </div>
    </div>
    
    <div class="calendar-options">
        <label class="checkbox-container">
            <input type="checkbox" id="show-completed-bookings"> 
            Abgeschlossene Ausleihungen anzeigen
        </label>
    </div>
    
    <div id="calendar"></div>
    
    <!-- Notification area for alerts -->
    <div id="notification-area" class="notification-area"></div>
    
    <!-- Modal for new bookings -->
    <div id="booking-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Neue Reservierung</h2>
            <form id="booking-form">
                <div class="form-group">
                    <label for="booking-date">Datum:</label>
                    <input type="date" id="booking-date" name="booking_date" required>
                </div>
                <div class="form-group">
                    <label for="period-select">Schulstunde:</label>
                    <select id="period-select" name="period" required>
                        <option value="">-- Bitte wählen --</option>
                        <option value="1">1. Stunde (08:00 - 08:45)</option>
                        <option value="2">2. Stunde (08:45 - 09:30)</option>
                        <option value="3">3. Stunde (09:45 - 10:30)</option>
                        <option value="4">4. Stunde (10:30 - 11:15)</option>
                        <option value="5">5. Stunde (11:30 - 12:15)</option>
                        <option value="6">6. Stunde (12:15 - 13:00)</option>
                        <option value="7">7. Stunde (13:30 - 14:15)</option>
                        <option value="8">8. Stunde (14:15 - 15:00)</option>
                        <option value="9">9. Stunde (15:15 - 16:00)</option>
                        <option value="10">10. Stunde (16:00 - 16:45)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="item-select">Objekt:</label>
                    <select id="item-select" name="item_id" required>
                        <option value="">-- Bitte wählen --</option>
                        <!-- Items will be loaded dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="booking-notes">Notizen:</label>
                    <textarea id="booking-notes" name="notes"></textarea>
                </div>
                <button type="submit" class="primary-button">Ausleihung speichern</button>
            </form>
        </div>
    </div>
    
    <!-- Modal for event details -->
    <div id="event-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Ausleihungs Details</h2>
            <div id="event-details">
                <!-- Event details will be loaded dynamically -->
            </div>
            <div id="event-actions">
                <button id="cancel-booking" class="danger-button">Ausleihung stornieren</button>
            </div>
        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales/de.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize variables
    const calendarEl = document.getElementById('calendar');
    const bookingModal = document.getElementById('booking-modal');
    const eventModal = document.getElementById('event-modal');
    const newBookingBtn = document.getElementById('new-booking');
    const notificationArea = document.getElementById('notification-area');
    const debugPanel = document.getElementById('debug-panel');
    const toggleDebugBtn = document.getElementById('toggle-debug');
    const actionLog = document.getElementById('action-log');
    const eventsLog = document.getElementById('events-log');
    const networkLog = document.getElementById('network-log');
    let currentEventId = null;
    let calendar;
    let showCompletedBookings = false;
    let isDebugMode = false;
    
    // School period times (for reference)
    const schoolPeriods = {
        1: { start: '08:00', end: '08:45', label: '1. Stunde (08:00 - 08:45)' },
        2: { start: '08:45', end: '09:30', label: '2. Stunde (08:45 - 09:30)' },
        3: { start: '09:45', end: '10:30', label: '3. Stunde (09:45 - 10:30)' },
        4: { start: '10:30', end: '11:15', label: '4. Stunde (10:30 - 11:15)' },
        5: { start: '11:30', end: '12:15', label: '5. Stunde (11:30 - 12:15)' },
        6: { start: '12:15', end: '13:00', label: '6. Stunde (12:15 - 13:00)' },
        7: { start: '13:30', end: '14:15', label: '7. Stunde (13:30 - 14:15)' },
        8: { start: '14:15', end: '15:00', label: '8. Stunde (14:15 - 15:00)' },
        9: { start: '15:15', end: '16:00', label: '9. Stunde (15:15 - 16:00)' },
        10: { start: '16:00', end: '16:45', label: '10. Stunde (16:00 - 16:45)' }
    };
    
    // Convert period to start/end times
    function getPeriodTimes(date, period) {
        const periodInfo = schoolPeriods[period];
        if (!periodInfo) return null;
        
        // Get the date part only without time
        const dateStr = date.toISOString().split('T')[0];
        
        // Create dates with the correct time zone handling
        const [startHours, startMinutes] = periodInfo.start.split(':').map(Number);
        const [endHours, endMinutes] = periodInfo.end.split(':').map(Number);
        
        // Create dates in the browser's local time zone
        const startDate = new Date(date);
        startDate.setHours(startHours, startMinutes, 0, 0);
        
        const endDate = new Date(date);
        endDate.setHours(endHours, endMinutes, 0, 0);
        
        return {
            start: startDate,
            end: endDate
        };
    }
    
    // Get period from a time
    function getPeriodFromTime(date) {
        const hours = date.getHours();
        const minutes = date.getMinutes();
        const timeStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        
        for (const [period, times] of Object.entries(schoolPeriods)) {
            if (timeStr >= times.start && timeStr <= times.end) {
                return parseInt(period);
            }
        }
        return null;
    }

    // Enhanced Debugging Functions
    function logAction(message) {
        const now = new Date();
        const timestamp = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit', millisecond: true });
        console.log(`[ACTION] ${timestamp}: ${message}`);
        
        if (actionLog) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">${timestamp}</span> ${message}`;
            actionLog.appendChild(entry);
            actionLog.scrollTop = actionLog.scrollHeight;
        }
    }

    function logEvent(event, details = {}) {
        const now = new Date();
        const timestamp = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        console.log(`[EVENT] ${timestamp}: ${event}`, details);
        
        if (eventsLog) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">${timestamp}</span> <strong>${event}</strong>: ${JSON.stringify(details)}`;
            eventsLog.appendChild(entry);
            eventsLog.scrollTop = eventsLog.scrollHeight;
        }
    }

    function logNetwork(method, url, status, data = {}) {
        const now = new Date();
        const timestamp = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        console.log(`[NETWORK] ${timestamp}: ${method} ${url} ${status}`, data);
        
        if (networkLog) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const statusClass = status >= 400 ? 'error' : (status >= 300 ? 'warning' : 'success');
            entry.innerHTML = `<span class="log-time">${timestamp}</span> <span class="${statusClass}">${method} ${url} ${status}</span><pre>${JSON.stringify(data, null, 2)}</pre>`;
            networkLog.appendChild(entry);
            networkLog.scrollTop = networkLog.scrollHeight;
        }
    }

    // Toggle debug mode
    toggleDebugBtn.addEventListener('click', function() {
        isDebugMode = !isDebugMode;
        debugPanel.style.display = isDebugMode ? 'block' : 'none';
        logAction(`Debug mode ${isDebugMode ? 'enabled' : 'disabled'}`);
    });

    // Clear log buttons
    document.getElementById('clear-actions').addEventListener('click', () => {
        actionLog.innerHTML = '';
    });
    document.getElementById('clear-events').addEventListener('click', () => {
        eventsLog.innerHTML = '';
    });
    document.getElementById('clear-network').addEventListener('click', () => {
        networkLog.innerHTML = '';
    });

    // Debug tab switching
    document.querySelectorAll('.debug-tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            
            // Update active button
            document.querySelectorAll('.debug-tab-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Show selected tab
            document.querySelectorAll('.debug-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`debug-${tabName}`).classList.add('active');
            
            logAction(`Switched to debug tab: ${tabName}`);
        });
    });
    
    // Enhanced notification with debug info
    function showNotification(message, type = 'info', debugData = null) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = message;
        
        if (debugData && isDebugMode) {
            const debugInfo = document.createElement('div');
            debugInfo.className = 'debug-info';
            debugInfo.innerHTML = `<pre>${JSON.stringify(debugData, null, 2)}</pre>`;
            notification.appendChild(debugInfo);
        }
        
        notificationArea.appendChild(notification);
        
        // Auto-remove after 8 seconds (increased from 5)
        setTimeout(() => {
            notification.classList.add('fade-out');
            setTimeout(() => {
                notification.remove();
            }, 500);
        }, 8000);
        
        logAction(`Notification (${type}): ${message}`);
    }
    
    // Initialize calendar with enhanced debugging
    logAction('Initializing calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridDay',
        locale: 'de',
        headerToolbar: false, // We're using our custom header
        navLinks: true,
        editable: false,
        dayMaxEvents: true,
        allDaySlot: false,
        slotMinTime: '08:00:00',
        slotMaxTime: '17:00:00',
        slotDuration: '00:45:00',
        snapDuration: '00:45:00',
        nowIndicator: true,
        now: new Date(),
        timeZone: 'local', // Use browser's local time zone
        displayEventTime: true, // Make sure times are displayed
        eventTimeFormat: {  // Customize the time format
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        },
        events: function(info, successCallback, failureCallback) {
            const startStr = info.startStr;
            const endStr = info.endStr;
            
            logAction(`Fetching events from ${startStr} to ${endStr}`);
            logNetwork('GET', '/get_bookings', 'PENDING', { start: startStr, end: endStr });
            
            // Load events from the server
            fetch('/get_bookings?start=' + startStr + '&end=' + endStr)
                .then(response => {
                    logNetwork('GET', '/get_bookings', response.status);
                    return response.json();
                })
                .then(data => {
                    // Log the raw data received
                    logEvent('receivedEvents', { 
                        count: data.bookings ? data.bookings.length : 0,
                        rawData: isDebugMode ? data.bookings : 'Enable debug mode to see raw data'
                    });
                    
                    // Extract bookings from response
                    const bookingsArray = Array.isArray(data) ? data : (data.bookings || []);
                    
                    // Process events to add colors based on status
                    let processedEvents = bookingsArray.map(event => {
                        let eventColor = '#3788d8'; // Default color
                        
                        if (event.isCurrentUser) {
                            eventColor = '#8e44ad'; // Purple for current user's bookings
                        } else if (event.status === 'completed') {
                            eventColor = '#7f8c8d'; // Gray for completed bookings
                        } else if (event.status === 'current') {
                            eventColor = '#e74c3c'; // Red for current bookings
                        } else if (event.status === 'planned') {
                            eventColor = '#2ecc71'; // Green for planned bookings
                        }
                        
                        // Create Date objects from ISO strings with proper time zone handling
                        const startTime = new Date(event.start);
                        const endTime = new Date(event.end);
                        
                        // For debug - log both raw and processed times
                        if (isDebugMode) {
                            logAction(`Event: ${event.title}, Raw start: ${event.start}, Processed: ${startTime.toLocaleTimeString()}`);
                            logAction(`Period: ${event.period}, status: ${event.status}`);
                        }
                        
                        return {
                            id: event.id,
                            title: event.title,
                            start: startTime,
                            end: endTime,
                            extendedProps: {
                                itemId: event.itemId,
                                userName: event.userName,
                                notes: event.notes,
                                status: event.status,
                                isCurrentUser: event.isCurrentUser,
                                period: event.period
                            },
                            backgroundColor: eventColor,
                            borderColor: eventColor,
                            textColor: '#ffffff',
                            display: 'block',
                            // Add class based on status for additional styling
                            classNames: [
                                event.status + '-event',
                                event.isCurrentUser ? 'user-event' : ''
                            ]
                        };
                    });
                    
                    // Filter out completed bookings if toggle is off
                    const filteredEvents = showCompletedBookings 
                        ? processedEvents 
                        : processedEvents.filter(event => event.extendedProps.status !== 'completed');
                    
                    logAction(`Processed ${processedEvents.length} events, displaying ${filteredEvents.length}`);
                    successCallback(filteredEvents);
                    
                    // Visual confirmation that events are loaded
                    showNotification(`${filteredEvents.length} Ausleihungen geladen`, 'info');
                })
                .catch(error => {
                    console.error('Error loading bookings:', error);
                    logNetwork('GET', '/get_bookings', 'ERROR', { error: error.toString() });
                    failureCallback(error);
                    showNotification('Fehler beim Laden der Ausleihungen', 'error');
                });
        }
    });
    
    logAction('Rendering calendar');
    calendar.render();
    updateCurrentDayDisplay();
    
    // Custom navigation buttons
    document.getElementById('prev-day').addEventListener('click', function() {
        calendar.prev();
        updateCurrentDayDisplay();
    });
    
    document.getElementById('next-day').addEventListener('click', function() {
        calendar.next();
        updateCurrentDayDisplay();
    });
    
    document.getElementById('today').addEventListener('click', function() {
        calendar.today();
        updateCurrentDayDisplay();
    });
    
    // Update the current day display
    function updateCurrentDayDisplay() {
        const dateStr = calendar.view.title;
        document.getElementById('current-day-display').textContent = dateStr;
    }
    
    // Load available items for the booking form
    function loadAvailableItems() {
        const itemSelect = document.getElementById('item-select');
        itemSelect.innerHTML = '<option value="">-- Bitte wählen --</option>';
        
        fetch('/get_items?available_only=true')
            .then(response => response.json())
            .then(data => {
                // Access the items array in the response
                const items = data.items || [];
                
                items.forEach(item => {
                    // Include all items, even if not immediately available
                    // Availability will be checked when booking
                    const option = document.createElement('option');
                    const itemId = item._id.$oid || item._id || item.id;
                    option.value = itemId;
                    option.textContent = item.Name;
                    itemSelect.appendChild(option);
                });
                
                if (items.length === 0) {
                    itemSelect.innerHTML += '<option value="" disabled>Keine Objekte gefunden</option>';
                    console.log('No items found');
                } else {
                    console.log(`Loaded ${items.length} items into dropdown`);
                }
            })
            .catch(error => console.error('Error loading items:', error));
    }
    
    // Open booking modal
    function openBookingModal(date = null) {
        // Set date to today if not provided
        if (!date) {
            date = calendar.getDate();
        }
        
        // Format the date for the date picker
        const formatDate = (date) => {
            return date.toISOString().split('T')[0];
        };
        
        document.getElementById('booking-date').value = formatDate(date);
        
        // Load available items
        loadAvailableItems();
        
        // Show modal
        bookingModal.style.display = 'block';
    }
    
    // Show event details
    function showEventDetails(event) {
        const details = document.getElementById('event-details');
        const actions = document.getElementById('event-actions');
        
        // Set current event ID
        currentEventId = event.id;
        
        // Get status text based on status value
        let statusText = 'Unbekannt';
        if (event.extendedProps.status === 'current') {
            statusText = 'Aktuell ausgeliehen';
        } else if (event.extendedProps.status === 'planned') {
            statusText = 'Geplant';
        } else if (event.extendedProps.status === 'completed') {
            statusText = 'Abgeschlossen';
        }
        
        // Get period information if available
        let periodText = '';
        if (event.extendedProps.period) {
            const period = event.extendedProps.period;
            periodText = `<p><strong>Schulstunde:</strong> ${schoolPeriods[period].label}</p>`;
        }
        
        // Populate details
        details.innerHTML = `
            <p><strong>Objekt:</strong> ${event.title}</p>
            <p><strong>Datum:</strong> ${new Date(event.start).toLocaleDateString('de-DE')}</p>
            <p><strong>Von:</strong> ${new Date(event.start).toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'})}</p>
            <p><strong>Bis:</strong> ${new Date(event.end).toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'})}</p>
            ${periodText}
            <p><strong>Ausgeliehen von:</strong> ${event.extendedProps.userName}</p>
            ${event.extendedProps.notes ? `<p><strong>Notizen:</strong> ${event.extendedProps.notes}</p>` : ''}
            <p><strong>Status:</strong> ${statusText}</p>
        `;
        
        // Show/hide cancel button based on ownership and status
        // Only allow cancellation for planned bookings that belong to the current user
        if (event.extendedProps.isCurrentUser && event.extendedProps.status === 'planned') {
            actions.style.display = 'block';
        } else {
            actions.style.display = 'none';
        }
        
        // Show modal
        eventModal.style.display = 'block';
    }
    
    // New booking button
    newBookingBtn.addEventListener('click', function() {
        openBookingModal();
    });
    
    // Close modals when clicking X
    document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.addEventListener('click', function() {
            bookingModal.style.display = 'none';
            eventModal.style.display = 'none';
        });
    });
    
    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === bookingModal) {
            bookingModal.style.display = 'none';
        }
        if (event.target === eventModal) {
            eventModal.style.display = 'none';
        }
    });
    
    // Enhanced booking form submission
    document.getElementById('booking-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // Log form data for debugging
        const formDebugData = {};
        for (let [key, value] of formData.entries()) {
            formDebugData[key] = value;
        }
        logAction('Booking form submitted');
        logEvent('bookingFormData', formDebugData);
        
        // Add period information to the form data
        const bookingDate = new Date(formData.get('booking_date'));
        const periodNum = formData.get('period');
        const periodTimes = getPeriodTimes(bookingDate, periodNum);
        
        if (!periodTimes) {
            showNotification('Ungültige Schulstunde ausgewählt!', 'error');
            logEvent('invalidPeriod', { period: periodNum, date: bookingDate });
            return;
        }
        
        // Log raw times for debugging
        logAction(`Time data: 
            - Raw start: ${periodTimes.start}
            - ISO start: ${periodTimes.start.toISOString()}
            - Local start: ${periodTimes.start.toLocaleTimeString()}
            - Raw end: ${periodTimes.end}
            - ISO end: ${periodTimes.end.toISOString()}
            - Local end: ${periodTimes.end.toLocaleTimeString()}
        `);
        
        // Format dates for backend
        formData.set('start_date', periodTimes.start.toISOString());
        formData.set('end_date', periodTimes.end.toISOString());
        formData.set('period', periodNum);
        
        const itemId = formData.get('item_id');
        const notes = formData.get('notes');
        
        // Show loading notification
        showNotification('Reservierung wird geprüft...', 'info', {
            item_id: itemId,
            period: periodNum,
            date: bookingDate.toISOString().split('T')[0],
            start: periodTimes.start.toISOString(),
            end: periodTimes.end.toISOString()
        });
        
        logNetwork('POST', '/plan_booking', 'PENDING', {
            item_id: itemId,
            period: periodNum,
            start_date: periodTimes.start.toISOString(),
            end_date: periodTimes.end.toISOString()
        });
        
        fetch('/plan_booking', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            logNetwork('POST', '/plan_booking', response.status);
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json().then(data => {
                    return { 
                        status: response.status,
                        data: data
                    };
                });
            }
            throw new Error('Unexpected response format');
        })
        .then(result => {
            const { status, data } = result;
            
            if (data.success) {
                // Close modal and refresh calendar
                bookingModal.style.display = 'none';
                
                logEvent('bookingSuccess', { 
                    booking_id: data.booking_id,
                    item_id: itemId, 
                    period: periodNum
                });
                
                showNotification(
                    'Ausleihe erfolgreich geplant!', 
                    'success',
                    { booking_id: data.booking_id }
                );
                
                // Force-refresh the calendar - use a more reliable method
                setTimeout(() => {
                    logAction('Refreshing calendar after successful booking');
                    // Force a complete refetch with current dates
                    const view = calendar.view;
                    const startDate = view.activeStart;
                    const endDate = view.activeEnd;
                    
                    // Force refetch with explicit date range
                    calendar.refetchEvents();
                    
                    // Also try rerendering the current view
                    calendar.rerenderEvents();
                    
                    // In rare cases, changing the view can help
                    const currentView = calendar.view.type;
                    calendar.changeView('listDay');
                    setTimeout(() => calendar.changeView(currentView), 100);
                }, 1000); // Increased timeout to ensure server data is updated
            } else {
                const errorMsg = data.error || 'Unbekannter Fehler';
                
                logEvent('bookingError', { 
                    status: status,
                    error: errorMsg,
                    item_id: itemId, 
                    period: periodNum
                });
                
                showNotification(
                    'Fehler: ' + errorMsg, 
                    'error',
                    { status_code: status }
                );
            }
        })
        .catch(error => {
            console.error('Error submitting booking:', error);
            
            logNetwork('POST', '/plan_booking', 'ERROR', { 
                error: error.toString() 
            });
            
            showNotification(
                'Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.', 
                'error',
                { error_message: error.toString() }
            );
        });
    });
    
    // Cancel booking
    document.getElementById('cancel-booking').addEventListener('click', function() {
        if (confirm('Möchten Sie diese Ausleihe wirklich stornieren?')) {
            fetch('/cancel_booking/' + currentEventId, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    eventModal.style.display = 'none';
                    calendar.refetchEvents();
                    showNotification('Ausleihe erfolgreich storniert!', 'success');
                } else {
                    showNotification('Fehler: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error canceling booking:', error);
                showNotification('Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.', 'error');
            });
        }
    });

    document.getElementById('show-completed-bookings').addEventListener('change', function() {
        showCompletedBookings = this.checked;
        calendar.refetchEvents();
    });
});
</script>

<style>
.calendar-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.calendar-header {
    margin-bottom: 20px;
}

.calendar-actions {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    flex-wrap: wrap; /* Allow items to wrap on small screens */
    gap: 10px; /* Add gap between items */
}

/* Make booked periods more visible */
.fc-event {
    border-width: 2px !important;
    font-weight: bold !important;
    padding: 2px 4px !important;
    min-height: 24px !important;
}

/* Add shadow to the current user's bookings for better visibility */
.fc-event[data-is-current-user="true"] {
    box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
    z-index: 10 !important; /* Make sure user's events appear on top */
}

/* Period marker within the event */
.fc-event-period-marker {
    font-size: 10px;
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
    padding: 1px 3px;
    margin-top: 2px;
    display: inline-block;
}

/* Add custom colors for event types to make them more distinct */
.fc-event.planned-event {
    background-color: #2ecc71 !important;
    border-color: #27ae60 !important;
}

.fc-event.current-event {
    background-color: #e74c3c !important;
    border-color: #c0392b !important;
}

.fc-event.completed-event {
    background-color: #7f8c8d !important;
    border-color: #34495e !important;
    opacity: 0.8;
}

.fc-event.user-event {
    background-color: #8e44ad !important;
    border-color: #9b59b6 !important;
}

/* Make time slots for school periods more recognizable */
.fc-timegrid-slot:nth-child(odd) {
    background-color: rgba(240, 240, 245, 0.4);
}
</style>
{% endblock %}