<!--
   Copyright 2025 Maximilian Gründinger

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
{% extends "base.html" %}

{% block title %}Inventarsystem{% endblock %}

{% block content %}
<div class="container">
    <div class="content">
        <h1>Inventar Objekte</h1>
        <div class="filter-container">
            <div class="filter-group">
                <div class="filter-header">
                    <label>Unterrichtsfach:</label>
                    <button type="button" class="filter-toggle" onclick="toggleFilterDropdown('filter1-dropdown')">▼</button>
                    <button type="button" class="clear-filter" onclick="clearFilter(1)">Clear</button>
                </div>
                <div class="selected-filters" id="selected-filter1"></div>
                <div class="filter-dropdown" id="filter1-dropdown">
                    <div class="filter-options" id="filter1-options">
                        <!-- Filter options will be dynamically loaded here -->
                    </div>
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-header">
                    <label>Jahrgangsstufe:</label>
                    <button type="button" class="filter-toggle" onclick="toggleFilterDropdown('filter2-dropdown')">▼</button>
                    <button type="button" class="clear-filter" onclick="clearFilter(2)">Clear</button>
                </div>
                <div class="selected-filters" id="selected-filter2"></div>
                <div class="filter-dropdown" id="filter2-dropdown">
                    <div class="filter-options" id="filter2-options">
                        <!-- Filter options will be dynamically loaded here -->
                    </div>
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-header">
                    <label>Thema:</label>
                    <button type="button" class="filter-toggle" onclick="toggleFilterDropdown('filter3-dropdown')">▼</button>
                    <button type="button" class="clear-filter" onclick="clearFilter(3)">Clear</button>
                </div>
                <div class="selected-filters" id="selected-filter3"></div>
                <div class="filter-dropdown" id="filter3-dropdown">
                    <div class="filter-options" id="filter3-options">
                        <!-- Filter options will be dynamically loaded here -->
                    </div>
                </div>
            </div>

            <div class="filter-group search-field">
                <div class="filter-header">
                    <label for="code-search">Code suchen:</label>
                    <button type="button" class="clear-filter" onclick="clearCodeSearch()">Clear</button>
                </div>
                <div class="search-container">
                    <input type="text" id="code-search" placeholder="Code eingeben..." autocomplete="off">
                    <button type="button" class="search-button" onclick="searchByCode()">
                        <i class="fas fa-search"></i> Suchen
                    </button>
                </div>
            </div>
        </div>
        <div class="qr-container">
            <button id="scanButton" class="scan-button">Barcode scannen</button>
            <div id="qr-reader" style="width: 500px; display: none;"></div>
        </div>

        <div id="items-container" class="items-container">
            <!-- Items will be dynamically loaded here -->
        </div>
        <div class="navigation-buttons">
            <button class="prev-button" onclick="scrollPrev()">&#10094;</button>
            <button class="next-button" onclick="scrollNext()">&#10095;</button>
        </div>
    </div>
    <div class="upload-form">
        <h2>Upload Item</h2>
        <form method="POST" action="{{ url_for('upload_item') }}" enctype="multipart/form-data">
            <div class="form-group">
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
                <label for="ort">Ort:</label>
                <input type="text" id="ort" name="ort" required>
            </div>
            <div class="form-group">
                <label for="beschreibung">Beschreibung:</label>
                <textarea id="beschreibung" name="beschreibung" required></textarea>
            </div>
            
            <!-- Updated filter inputs with dropdowns for Filter 1 and Filter 2 -->
            <div class="filter-inputs">
                <h3>Unterrichtsfach:</h3>
                <div class="multi-filter">
                    <div class="form-group">
                        <label for="filter1-1">Wert 1:</label>
                        <select id="filter1-1" name="filter" class="filter-dropdown-select" required>
                            <option value="">-- Bitte auswählen --</option>
                            <!-- Options will be loaded by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter1-2">Wert 2:</label>
                        <select id="filter1-2" name="filter" class="filter-dropdown-select">
                            <option value="">-- Optional --</option>
                            <!-- Options will be loaded by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter1-3">Wert 3:</label>
                        <select id="filter1-3" name="filter" class="filter-dropdown-select">
                            <option value="">-- Optional --</option>
                            <!-- Options will be loaded by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter1-4">Wert 4:</label>
                        <select id="filter1-4" name="filter" class="filter-dropdown-select">
                            <option value="">-- Optional --</option>
                            <!-- Options will be loaded by JavaScript -->
                        </select>
                    </div>
                </div>
                
                <h3>Jahrgangsstufe:</h3>
                <div class="multi-filter">
                    <div class="form-group">
                        <label for="filter2-1">Wert 1:</label>
                        <select id="filter2-1" name="filter2" class="filter-dropdown-select" required>
                            <option value="">-- Bitte auswählen --</option>
                            <!-- Options will be loaded by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter2-2">Wert 2:</label>
                        <select id="filter2-2" name="filter2" class="filter-dropdown-select">
                            <option value="">-- Optional --</option>
                            <!-- Options will be loaded by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter2-3">Wert 3:</label>
                        <select id="filter2-3" name="filter2" class="filter-dropdown-select">
                            <option value="">-- Optional --</option>
                            <!-- Options will be loaded by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter2-4">Wert 4:</label>
                        <select id="filter2-4" name="filter2" class="filter-dropdown-select">
                            <option value="">-- Optional --</option>
                            <!-- Options will be loaded by JavaScript -->
                        </select>
                    </div>
                </div>
                
                <h3>Thema:</h3>
                <div class="multi-filter">
                    <div class="form-group">
                        <label for="filter3-1">Wert 1:</label>
                        <input type="text" id="filter3-1" name="filter3" required>
                    </div>
                    <div class="form-group">
                        <label for="filter3-2">Wert 2:</label>
                        <input type="text" id="filter3-2" name="filter3">
                    </div>
                    <div class="form-group">
                        <label for="filter3-3">Wert 3:</label>
                        <input type="text" id="filter3-3" name="filter3">
                    </div>
                    <div class="form-group">
                        <label for="filter3-4">Wert 4:</label>
                        <input type="text" id="filter3-4" name="filter3">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="anschaffungsjahr">Anschaffungsdatum</label>
                <input type="date" id="anschaffungsjahr" name="anschaffungsjahr">
            </div>
            <div class="form-group">
                <label for="anschaffungskosten">Anschaffungskosten</label>
                <input id="anschaffungskosten" name="anschaffungskosten">
            </div>
            <div class="form-group">
                <label for="code_4">Code</label>
                <input id="code_4" name="code_4" required>
            </div>
            <div class="form-group">
                <label for="images">Bilder:</label>
                <input type="file" id="images" name="images" accept="image/*" multiple>
            </div>
            
            <!-- Add ISBN and exemplar count fields to upload form -->
            <div class="form-group">
                <label for="isbn">ISBN:</label>
                <div class="isbn-input-group">
                    <input type="text" id="isbn" name="isbn" placeholder="ISBN eingeben...">
                    <button type="button" class="fetch-isbn-button" onclick="fetchBookInfo('upload')">Buchinformationen abrufen</button>
                </div>
                <div id="book-info-container" class="book-info-container"></div>
            </div>
            
            <div class="form-group">
                <label for="exemplare">Exemplare:</label>
                <input type="number" id="exemplare" name="exemplare" min="1" value="1">
            </div>
            
            <button type="submit">Upload</button>
        </form>
    </div>
    <div id="item-modal" class="item-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="modal-content-wrapper">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Add the edit modal form -->
    <div id="edit-modal" class="item-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeEditModal()">&times;</span>
            <h2>Objekt bearbeiten</h2>
            <form id="edit-item-form" method="POST" enctype="multipart/form-data">
                <input type="hidden" id="edit-item-id" name="id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-name">Name:</label>
                        <input type="text" id="edit-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-ort">Ort:</label>
                        <input type="text" id="edit-ort" name="ort" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-beschreibung">Beschreibung:</label>
                    <textarea id="edit-beschreibung" name="beschreibung" required></textarea>
                </div>
                
                <!-- Updated filter inputs for edit form with dropdowns -->
                <div class="filter-inputs">
                    <h3>Unterrichtsfach:</h3>
                    <div class="multi-filter">
                        <div class="form-group">
                            <label for="edit-filter1-1">Wert 1:</label>
                            <select id="edit-filter1-1" name="filter" class="filter-dropdown-select">
                                <option value="">-- Bitte auswählen --</option>
                                <!-- Options will be loaded by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-filter1-2">Wert 2:</label>
                            <select id="edit-filter1-2" name="filter" class="filter-dropdown-select">
                                <option value="">-- Optional --</option>
                                <!-- Options will be loaded by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-filter1-3">Wert 3:</label>
                            <select id="edit-filter1-3" name="filter" class="filter-dropdown-select">
                                <option value="">-- Optional --</option>
                                <!-- Options will be loaded by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-filter1-4">Wert 4:</label>
                            <select id="edit-filter1-4" name="filter" class="filter-dropdown-select">
                                <option value="">-- Optional --</option>
                                <!-- Options will be loaded by JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <h3>Jahrgangsstufe:</h3>
                    <div class="multi-filter">
                        <div class="form-group">
                            <label for="edit-filter2-1">Wert 1:</label>
                            <select id="edit-filter2-1" name="filter2" class="filter-dropdown-select">
                                <option value="">-- Bitte auswählen --</option>
                                <!-- Options will be loaded by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-filter2-2">Wert 2:</label>
                            <select id="edit-filter2-2" name="filter2" class="filter-dropdown-select">
                                <option value="">-- Optional --</option>
                                <!-- Options will be loaded by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-filter2-3">Wert 3:</label>
                            <select id="edit-filter2-3" name="filter2" class="filter-dropdown-select">
                                <option value="">-- Optional --</option>
                                <!-- Options will be loaded by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-filter2-4">Wert 4:</label>
                            <select id="edit-filter2-4" name="filter2" class="filter-dropdown-select">
                                <option value="">-- Optional --</option>
                                <!-- Options will be loaded by JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <h3>Thema:</h3>
                    <div class="multi-filter">
                        <div class="form-group">
                            <label for="edit-filter3-1">Wert 1:</label>
                            <input type="text" id="edit-filter3-1" name="filter3">
                        </div>
                        <div class="form-group">
                            <label for="edit-filter3-2">Wert 2:</label>
                            <input type="text" id="edit-filter3-2" name="filter3">
                        </div>
                        <div class="form-group">
                            <label for="edit-filter3-3">Wert 3:</label>
                            <input type="text" id="edit-filter3-3" name="filter3">
                        </div>
                        <div class="form-group">
                            <label for="edit-filter3-4">Wert 4:</label>
                            <input type="text" id="edit-filter3-4" name="filter3">
                        </div>
                    </div>
                </div>
                
                <!-- Add ISBN and exemplar count fields -->
                <div class="form-group">
                    <label for="edit-isbn">ISBN:</label>
                    <div class="isbn-input-group">
                        <input type="text" id="edit-isbn" name="isbn" placeholder="ISBN eingeben...">
                        <button type="button" class="fetch-isbn-button" onclick="fetchBookInfo('edit')">Buchinformationen abrufen</button>
                    </div>
                    <div id="edit-book-info-container" class="book-info-container"></div>
                </div>
                
                <div class="form-group">
                    <label for="edit-exemplare">Exemplare:</label>
                    <input type="number" id="edit-exemplare" name="exemplare" min="1" value="1">
                    <div id="edit-exemplare-status" class="exemplare-status"></div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-anschaffungsjahr">Anschaffungsjahr:</label>
                        <input type="date" id="edit-anschaffungsjahr" name="anschaffungsjahr">
                    </div>
                    <div class="form-group">
                        <label for="edit-anschaffungskosten">Anschaffungskosten:</label>
                        <input id="edit-anschaffungskosten" name="anschaffungskosten">
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-code4">Code:</label>
                    <input id="edit-code4" name="code_4">
                </div>
                
                <!-- New section for managing images -->
                <div class="form-group">
                    <label>Vorhandene Bilder:</label>
                    <div id="edit-existing-images" class="existing-images-container">
                        <!-- Existing images will be added here dynamically -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-new-images">
                        <span>Neue Bilder hinzufügen:</span>
                        <span>(Bilder werden vom Original übernommen)</span>
                    </label>
                    <input type="file" id="edit-new-images" name="new_images" accept="image/*" multiple>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="save-button">Speichern</button>
                    <button type="button" class="cancel-button" onclick="closeEditModal()">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Initialize template variables before any JavaScript code -->
<script>
    // Create a global object to hold server-side template values
    window.serverVars = {
        highlightItemId: {% if highlight_item is defined and highlight_item %}"{{ highlight_item }}"{% else %}null{% endif %}
    };
    
    window.isDebug = false; // Set to true only for development environment
</script>
<script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
<script>
    // Initialize QR Code scanner and global variables
    let html5QrcodeScanner = null;
    let codeSearchTerm = '';
    let currentUsername = '';
    let allItems = []; // Cache for all items
    
    // Get the highlight item ID from the pre-processed server variables
    let highlightItemId = window.serverVars.highlightItemId;
    
    // Global variables to store active filters (SINGLE DECLARATION)
    let activeFilters = {
        filter1: [],
        filter2: [],
        filter3: []
    };
    
    // Simplified no-op version of debug function for production
    function debugLog() {
        // No-op in production
        return;
    }
    
    document.getElementById('scanButton').addEventListener('click', function() {
        const qrReader = document.getElementById('qr-reader');
        
        if (qrReader.style.display === 'none') {
            qrReader.style.display = 'block';
            
            html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader", { fps: 10, qrbox: 250 }
            );
            
            html5QrcodeScanner.render((decodedText) => {
                html5QrcodeScanner.clear();
                qrReader.style.display = 'none';
                
                // Instead of navigating to the URL, put the scanned code in the search box
                const searchInput = document.getElementById('code-search');
                if (searchInput) {
                    searchInput.value = decodedText;
                    // Trigger search automatically
                    searchByCode();
                }
                
                // Reset the button text
                document.getElementById('scanButton').textContent = 'Barcode scannen';
            });
            
            this.textContent = 'Barcode Scanner schließen';
        } else {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
            }
            qrReader.style.display = 'none';
            this.textContent = 'Barcode scannen';
        }
    });

    function rebuildFilter3Options() {
        if (!allItems || allItems.length === 0) return;
        
        // Get current filter 1 and filter 2 selections
        const filter1Selections = activeFilters.filter1;
        const filter2Selections = activeFilters.filter2;
        
        // If both filters are empty, show all filter3 values
        if (filter1Selections.length === 0 && filter2Selections.length === 0) {
            // Get all unique filter3 values
            const allFilter3Values = new Set();
            allItems.forEach(item => {
                const filter3Array = Array.isArray(item.Filter3) ? item.Filter3 : 
                                     (item.Filter3 ? [item.Filter3] : []);
                
                filter3Array.forEach(value => {
                    if (value && typeof value === 'string' && value.trim() !== '') {
                        allFilter3Values.add(value);
                    }
                });
            });
            
            // Populate filter 3 dropdown with all values
            populateFilterOptions('filter3-options', [...allFilter3Values].sort(), 3);
            return;
        }
        
        // Filter items based on filter1 and filter2 selections
        const filteredItems = allItems.filter(item => {
            // Check if item passes Filter 1
            const filter1Array = Array.isArray(item.Filter) ? item.Filter : (item.Filter ? [item.Filter] : []);
            const filter1Match = filter1Selections.length === 0 || 
                filter1Selections.some(filter => {
                    // Extract value from filter (remove group prefix if exists)
                    const filterValue = filter.includes(':') ? filter.split(':')[1] : filter;
                    return filter1Array.includes(filterValue);
                });
            
            // Check if item passes Filter 2
            const filter2Array = Array.isArray(item.Filter2) ? item.Filter2 : (item.Filter2 ? [item.Filter2] : []);
            const filter2Match = filter2Selections.length === 0 || 
                filter2Selections.some(filter => {
                    // Extract value from filter (remove group prefix if exists)
                    const filterValue = filter.includes(':') ? filter.split(':')[1] : filter;
                    return filter2Array.includes(filterValue);
                });
            
            return filter1Match && filter2Match;
        });
        
        // Get unique Filter 3 values from filtered items
        const availableFilter3Values = new Set();
        filteredItems.forEach(item => {
            const filter3Array = Array.isArray(item.Filter3) ? item.Filter3 : (item.Filter3 ? [item.Filter3] : []);
            filter3Array.forEach(value => {
                if (value && typeof value === 'string' && value.trim() !== '') {
                    availableFilter3Values.add(value);
                }
            });
        });
        
        // Keep track of current filter 3 selections that are still valid
        const validFilter3Selections = [];
        activeFilters.filter3.forEach(filter => {
            // Extract value from filter (remove group prefix if exists)
            const filterValue = filter.includes(':') ? filter.split(':')[1] : filter;
            if (availableFilter3Values.has(filterValue)) {
                validFilter3Selections.push(filter);
            }
        });
        
        // Update active filter 3 selections (remove invalid ones)
        if (validFilter3Selections.length !== activeFilters.filter3.length) {
            activeFilters.filter3 = validFilter3Selections;
            updateSelectedFiltersDisplay(3);
            // No need to call applyFilters() here as it will be called after this function
        }
        
        // Populate filter 3 dropdown with only available values
        populateFilterOptions('filter3-options', [...availableFilter3Values].sort(), 3);
    }

    function rebuildFilter2Options() {
        if (!allItems || allItems.length === 0) return;
        
        // Get current filter 1 selections
        const filter1Selections = activeFilters.filter1;
        
        // If filter1 is empty, show all filter2 values
        if (filter1Selections.length === 0) {
            // Get all unique filter2 values
            const allFilter2Values = new Set();
            allItems.forEach(item => {
                const filter2Array = Array.isArray(item.Filter2) ? item.Filter2 : 
                                     (item.Filter2 ? [item.Filter2] : []);
                
                filter2Array.forEach(value => {
                    if (value && typeof value === 'string' && value.trim() !== '') {
                        allFilter2Values.add(value);
                    }
                });
            });
            
            // Populate filter 2 dropdown with all values
            populateFilterOptions('filter2-options', [...allFilter2Values].sort(), 2);
            return;
        }
        
        // Filter items based on filter1 selections
        const filteredItems = allItems.filter(item => {
            // Check if item passes Filter 1
            const filter1Array = Array.isArray(item.Filter) ? item.Filter : (item.Filter ? [item.Filter] : []);
            return filter1Selections.some(filter => {
                // Extract value from filter (remove group prefix if exists)
                const filterValue = filter.includes(':') ? filter.split(':')[1] : filter;
                return filter1Array.includes(filterValue);
            });
        });
        
        // Get unique Filter 2 values from filtered items
        const availableFilter2Values = new Set();
        filteredItems.forEach(item => {
            const filter2Array = Array.isArray(item.Filter2) ? item.Filter2 : (item.Filter2 ? [item.Filter2] : []);
            filter2Array.forEach(value => {
                if (value && typeof value === 'string' && value.trim() !== '') {
                    availableFilter2Values.add(value);
                }
            });
        });
        
        // Keep track of current filter 2 selections that are still valid
        const validFilter2Selections = [];
        activeFilters.filter2.forEach(filter => {
            // Extract value from filter (remove group prefix if exists)
            const filterValue = filter.includes(':') ? filter.split(':')[1] : filter;
            if (availableFilter2Values.has(filterValue)) {
                validFilter2Selections.push(filter);
            }
        });
        
        // Update active filter 2 selections (remove invalid ones)
        if (validFilter2Selections.length !== activeFilters.filter2.length) {
            activeFilters.filter2 = validFilter2Selections;
            updateSelectedFiltersDisplay(2);
            // No need to call applyFilters() here as it will be called after this function
        }
        
        // Populate filter 2 dropdown with only available values - FIX HERE
        populateFilterOptions('filter2-options', [...availableFilter2Values].sort(), 2);
    }

    function saveFilterState() {
        localStorage.setItem('inventarSystemFilters', JSON.stringify(activeFilters));
    }
    
    function loadFilterState() {
        const savedFilters = localStorage.getItem('inventarSystemFilters');
        if (savedFilters) {
            try {
                // Parse saved filters
                const parsedFilters = JSON.parse(savedFilters);
                
                // Restore to active filters
                if (parsedFilters.filter1) activeFilters.filter1 = parsedFilters.filter1;
                if (parsedFilters.filter2) activeFilters.filter2 = parsedFilters.filter2;
                if (parsedFilters.filter3) activeFilters.filter3 = parsedFilters.filter3;
                
                // We'll rebuild Filter 3 options after items are loaded
            } catch (e) {
                console.error("Error loading saved filters:", e);
            }
        }
    }
    
    function clearFilterState() {
        localStorage.removeItem('inventarSystemFilters');
        // Reset active filters
        activeFilters = {
            filter1: [],
            filter2: [],
            filter3: []
        };
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Load saved filters
        loadFilterState();
        
        // Load predefined filter values for dropdowns
        loadPredefinedFilterValues(1);
        loadPredefinedFilterValues(2);
        
        // Find and attach event listener to all logout links
        const logoutLinks = document.querySelectorAll('a[href*="logout"]');
        logoutLinks.forEach(link => {
            link.addEventListener('click', function() {
                clearFilterState(); // Clear filters when logging out
            });
        });
        
        // Fetch user status to get current username
        fetch('/user_status')
            .then(response => response.json())
            .then(data => {
                currentUsername = data.username;
                // Now load items with username information
                loadItems();
            })
            .catch(error => {
                console.error('Error fetching user status:', error);
                loadItems(); // Load items anyway in case of error
            });

        // Add event listener for code search input
        const codeSearchInput = document.getElementById('code-search');
        if (codeSearchInput) {
            codeSearchInput.addEventListener('input', function() {
                // Use a small delay to avoid excessive filtering while typing
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    searchByCode();
                }, 300);
            });
        }
    });

    function loadItems() {
        fetch("{{ url_for('get_items') }}")
            .then(response => response.json())
            .then(data => {
                const itemsContainer = document.querySelector('#items-container');
                // Creating a Set to store unique filter values
                const filter1Values = new Set();
                const filter2Values = new Set();
                const filter3Values = new Set();
                
                // Store all items data globally
                allItems = data.items || [];
                
                // Clear the container first
                itemsContainer.innerHTML = '';
                
                if (!data.items || data.items.length === 0) {
                    itemsContainer.innerHTML = '<div class="no-items-message">Keine Objekte gefunden</div>';
                    return;
                }
                
                // Sort items by name in ascending order (A-Z)
                data.items.sort((a, b) => {
                    const nameA = a.Name ? a.Name.toLowerCase() : '';
                    const nameB = b.Name ? b.Name.toLowerCase() : '';
                    return nameA.localeCompare(nameB); // Ascending order
                });
                
                data.items.forEach(item => {
                    try {
                        const card = document.createElement('div');
                        card.classList.add('item-card');
                        
                        // Add class to make card clickable 
                        card.classList.add('clickable-card');
                        
                        // Add highlight class if this is the item we're looking for
                        if (highlightItemId && item._id === highlightItemId) {
                            card.classList.add('highlight-item');
                            setTimeout(() => {
                                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 500);
                        }
                        
                        // Process and store filter values with consistent handling
                        const filter1Array = Array.isArray(item.Filter) ? item.Filter : (item.Filter ? [item.Filter] : []);
                        const filter2Array = Array.isArray(item.Filter2) ? item.Filter2 : (item.Filter2 ? [item.Filter2] : []);
                        const filter3Array = Array.isArray(item.Filter3) ? item.Filter3 : (item.Filter3 ? [item.Filter3] : []);

                        // Add filter values to their respective sets - all values should be strings
                        filter1Array.forEach(value => {
                            if (value && typeof value === 'string' && value.trim() !== '') {
                                filter1Values.add(value);
                            }
                        });
                        
                        filter2Array.forEach(value => {
                            if (value && typeof value === 'string' && value.trim() !== '') {
                                filter2Values.add(value);
                            }
                        });
                        
                        filter3Array.forEach(value => {
                            if (value && typeof value === 'string' && value.trim() !== '') {
                                filter3Values.add(value);
                            }
                        });

                        // Store filter data as attributes on the card
                        card.dataset.filter1 = JSON.stringify(filter1Array);
                        card.dataset.filter2 = JSON.stringify(filter2Array);
                        card.dataset.filter3 = JSON.stringify(filter3Array);
                        card.dataset.code = (item.Code_4 !== undefined && item.Code_4 !== null) ? 
                          String(item.Code_4).trim() : '';
                        
                        // Create formatted display text for filters with "more" indicators if needed
                        const maxDisplayValues = 2; // Maximum number of filter values to display before showing "+X more"
                        
                        // Process filter1 values for display
                        let filter1Display = filter1Array.length > 0 ? filter1Array.slice(0, maxDisplayValues).join(', ') : '-';
                        let filter1More = filter1Array.length > maxDisplayValues ? 
                        ` <span class="more-indicator">+${filter1Array.length - maxDisplayValues} mehr</span>` : '';
                        
                        // Process filter2 values for display
                        let filter2Display = filter2Array.length > 0 ? filter2Array.slice(0, maxDisplayValues).join(', ') : '-';
                        let filter2More = filter2Array.length > maxDisplayValues ? 
                        ` <span class="more-indicator">+${filter2Array.length - maxDisplayValues} mehr</span>` : '';
                        
                        // Process filter3 values for display
                        let filter3Display = filter3Array.length > 0 ? filter3Array.slice(0, maxDisplayValues).join(', ') : '-';
                        let filter3More = filter3Array.length > maxDisplayValues ? 
                        ` <span class="more-indicator">+${filter3Array.length - maxDisplayValues} mehr</span>` : '';
                        
                        // Process image HTML (assuming this is already defined elsewhere)
                        const imagesHtml = item.Images && item.Images.length > 0 ? 
                            item.Images.map((img, idx) => 
                                `<img src="{{ url_for('uploaded_file', filename='') }}${img}" 
                                 alt="${item.Name}" class="item-image" 
                                 style="display: ${idx === 0 ? 'block' : 'none'};" />`
                            ).join('') : 
                            '<div class="no-image">Kein Bild</div>';
                        
                        // Create borrower badge HTML
                        const isBorrowedByMe = item.User === currentUsername;
                        let borrowerBadge = '';
                        
                        if (!item.Verfuegbar) {
                            borrowerBadge = `
                                <div class="borrower-badge">
                                    Ausgeliehen von: ${item.User || 'Unbekannt'}
                                    <span class="borrow-time">${item.BorrowTime || ''}</span>
                                </div>
                            `;
                        }
                        
                        card.innerHTML = `
                            <div class="card-content" data-item-id="${item._id}">
                                <h3>${item.Name}</h3>
                                <p><strong>Ort:</strong> ${item.Ort || '-'}</p>
                                <p><strong>Unterrichtsfach:</strong> ${filter1Display}${filter1More}</p>
                                <p><strong>Jahrgangsstufe:</strong> ${filter2Display}${filter2More}</p>
                                <p><strong>Thema:</strong> ${filter3Display}${filter3More}</p>
                                <p><strong>Barcode:</strong> ${item.Code_4 || '-'}</p>
                                <div class="image-container">
                                    ${imagesHtml}
                                    <button class="prev-image-button" onclick="prevImage(event)">&#10094;</button>
                                    <button class="next-image-button" onclick="nextImage(event)">&#10095;</button>
                                </div>
                                ${borrowerBadge}
                            </div>
                            <div class="actions">
                                ${item.Verfuegbar ? 
                                    `<form method="POST" action="{{ url_for('ausleihen', id='') }}${item._id}">
                                        <button class="ausleihen" type="submit">Ausleihen</button>
                                    </form>` 
                                : isBorrowedByMe ?
                                    `<form method="POST" action="{{ url_for('zurueckgeben', id='') }}${item._id}">
                                        <button class="ausleihen" type="submit">Zurückgeben</button>
                                    </form>`
                                :
                                    `<button class="ausleihen disabled-button" disabled>Ausgeliehen</button>`
                                }
                                <a href="#" class="edit-button" onclick="editItem('${item._id}', event)">Bearbeiten</a>
                                <a href="#" class="duplicate-button" onclick="duplicateItem('${item._id}', event)">Duplizieren</a>
                                <a href="#" class="delete-button" onclick="confirmDelete('${item._id}', '${item.Name}', event)">Delete</a>
                            </div>
                        `;
                        itemsContainer.appendChild(card);

                        // Add direct click event listeners to the card content area
                        const cardContent = card.querySelector('.card-content');
                        if (cardContent) {
                            cardContent.addEventListener('click', function(e) {
                                // Don't trigger if clicking on buttons or form elements
                                if (e.target.tagName === 'BUTTON' || 
                                    e.target.tagName === 'A' || 
                                    e.target.tagName === 'INPUT' ||
                                    e.target.closest('button') || 
                                    e.target.closest('a') || 
                                    e.target.closest('.image-container')) {
                                    return;
                                }
                                
                                // Stop event from bubbling up
                                e.stopPropagation();
                                
                                
                                // Get full item data with correct image paths
                                const modalItemData = {...item};
                                modalItemData.Images = item.Images.map(img => "{{ url_for('uploaded_file', filename='') }}" + img);
                                
                                openItemModal(modalItemData);
                            });
                        }
                    } catch (err) {
                        console.error('Error processing item:', err, item);
                    }
                });
                
                // Populate filter options
                populateFilterOptions('filter1-options', [...filter1Values].sort(), 1);
                populateFilterOptions('filter2-options', [...filter2Values].sort(), 2);
                populateFilterOptions('filter3-options', [...filter3Values].sort(), 3);
                
                // Make sure filters are updated if there are active selections
                if (activeFilters.filter1.length > 0) {
                    rebuildFilter2Options();
                }
                if (activeFilters.filter1.length > 0 || activeFilters.filter2.length > 0) {
                    rebuildFilter3Options();
                }
                
                // Start display from leftmost position (first card, which is now A)
                itemsContainer.scrollLeft = 0;
                
                // Apply filters
                applyFilters();
            })
            .catch(error => {
                console.error('Error fetching items:', error);
                const itemsContainer = document.querySelector('#items-container');
                itemsContainer.innerHTML = 
                    '<div class="error-message">Fehler beim Laden der Objekte. Bitte versuchen Sie es später erneut.</div>';
            });
    }

    // Update the updateFilter function to rebuild Filter 2 when Filter 1 changes
    function updateFilter(filterNum, value, isChecked, group = '') {
        const filterKey = `filter${filterNum}`;
        // Add group prefix if provided
        const filterValue = group ? `${group}:${value}` : value;
        
        if (isChecked) {
            // Add filter value if not already present
            if (!activeFilters[filterKey].includes(filterValue)) {
                activeFilters[filterKey].push(filterValue);
            }
        } else {
            // Remove filter value
            activeFilters[filterKey] = activeFilters[filterKey].filter(v => v !== filterValue);
        }
        
        // Update the filter display
        updateSelectedFiltersDisplay(filterNum);
        
        // If Filter 1 changed, rebuild Filter 2 options, then rebuild Filter 3
        if (filterNum === 1) {
            rebuildFilter2Options();
            rebuildFilter3Options();
        }
        // If Filter 2 changed, rebuild Filter 3 options
        else if (filterNum === 2) {
            rebuildFilter3Options();
        }
        
        // Save and apply the filters
        saveFilterState();
        applyFilters();
    }

    function clearFilter(filterNum) {
        activeFilters[`filter${filterNum}`] = [];
        document.getElementById(`selected-filter${filterNum}`).innerHTML = '';
        
        // Uncheck all checkboxes
        const checkboxes = document.querySelectorAll(`#filter${filterNum}-options input[type="checkbox"]`);
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // If Filter 1 was cleared, rebuild Filter 2 and Filter 3 options
        if (filterNum === 1) {
            rebuildFilter2Options();
            rebuildFilter3Options();
        }
        // If Filter 2 was cleared, rebuild Filter 3 options
        else if (filterNum === 2) {
            rebuildFilter3Options();
        }
        
        // Save and apply the updated filters
        saveFilterState();
        applyFilters();
    }

    function removeFilter(filterNum, filter) {
        const filterKey = `filter${filterNum}`;
        
        // Remove from active filters
        activeFilters[filterKey] = activeFilters[filterKey].filter(f => f !== filter);
        
        // Update UI
        updateSelectedFiltersDisplay(filterNum);
        
        // Uncheck corresponding checkbox if exists
        let value = filter;
        let group = '';
        
        if (filter.includes(':')) {
            [group, value] = filter.split(':');
        }
        
        // Find and uncheck the checkbox
        const checkboxes = document.querySelectorAll(`#filter${filterNum}-options input[type="checkbox"]`);
        checkboxes.forEach(checkbox => {
            if ((checkbox.value === value) && 
                 ((!group && !checkbox.dataset.group) || 
                  (group && checkbox.dataset.group === group))) {
                checkbox.checked = false;
            }
        });
        
        // If Filter 1 was changed, rebuild Filter 2 and Filter 3 options
        if (filterNum === 1) {
            rebuildFilter2Options();
            rebuildFilter3Options();
        }
        // If Filter 2 was changed, rebuild Filter 3 options
        else if (filterNum === 2) {
            rebuildFilter3Options();
        }
        
        // Save and apply the filters
        saveFilterState();
        applyFilters();
    }

    function centerCardInView(card, container) {
        // Make sure the card is visible first
        card.style.display = 'block';
        
        // Get positions and dimensions
        const containerRect = container.getBoundingClientRect();
        const cardRect = card.getBoundingClientRect();
        
        // Calculate scroll position to center the card
        const scrollPosition = card.offsetLeft - (containerRect.width/2) + (cardRect.width/2);
        
        // Debug the centering calculation if in debug mode
        if (window.isDebug) {
            console.log('Card positioning details:', {
                cardName: card.querySelector('h3')?.textContent,
                containerWidth: containerRect.width,
                cardWidth: cardRect.width,
                cardLeft: card.offsetLeft,
                calculatedScrollPosition: scrollPosition
            });
        }
        
        // Smooth scroll to position
        container.scrollTo({
            left: scrollPosition,
            behavior: 'smooth'
        });
    }

    function applyAttentionAnimation(card) {
        // First remove any existing animations
        card.getAnimations().forEach(anim => anim.cancel());
        
        // Apply a more pronounced animation
        card.animate([
            { transform: 'scale(1)', boxShadow: '0 0 15px rgba(40, 167, 69, 0.7)' },
            { transform: 'scale(1.08)', boxShadow: '0 0 25px rgba(40, 167, 69, 1)' },
            { transform: 'scale(1)', boxShadow: '0 0 15px rgba(40, 167, 69, 0.7)' }
        ], {
            duration: 800,
            iterations: 3,
            easing: 'ease-in-out'
        });
        
        // Also flash the background for better visibility
        card.animate([
            { backgroundColor: 'white' },
            { backgroundColor: 'rgba(40, 167, 69, 0.1)' },
            { backgroundColor: 'white' }
        ], {
            duration: 800,
            iterations: 3,
            easing: 'ease-in-out'
        });
    }

    function debugCardData(card) {
        if (!isDebug) return;
        
        const itemName = card.querySelector('h3')?.textContent || 'unknown';
        debugLog(`Card data for "${itemName}":`, {
            code: card.dataset.code,
            filter1: card.dataset.filter1,
            filter2: card.dataset.filter2,
            filter3: card.dataset.filter3,
            isVisible: card.style.display !== 'none'
        });
    }

    function scrollPrev() {
        const container = document.querySelector('#items-container');
        const cardWidth = container.querySelector('.item-card')?.offsetWidth || 300;
        const gap = 20; // Match the gap in CSS
        
        // Scroll one card width to the left + gap
        container.scrollBy({
            left: -1 * (cardWidth + gap),
            behavior: 'smooth'
        });
    }

    function scrollNext() {
        const container = document.querySelector('#items-container');
        const cardWidth = container.querySelector('.item-card')?.offsetWidth || 300;
        const gap = 20; // Match the gap in CSS
        
        // Scroll one card width to the right + gap
        container.scrollBy({
            left: cardWidth + gap,
            behavior: 'smooth'
        });
    }

    function prevImage(event) {
        event.stopPropagation(); // Prevent card click event
        const container = event.target.closest('.image-container');
        const images = container.querySelectorAll('.item-image');
        let currentIndex = Array.from(images).findIndex(img => img.style.display === 'block');
        
        images[currentIndex].style.display = 'none';
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        images[currentIndex].style.display = 'block';
    }

    function nextImage(event) {
        event.stopPropagation(); // Prevent card click event
        const container = event.target.closest('.image-container');
        const images = container.querySelectorAll('.item-image');
        let currentIndex = Array.from(images).findIndex(img => img.style.display === 'block');
        
        images[currentIndex].style.display = 'none';
        currentIndex = (currentIndex + 1) % images.length;
        images[currentIndex].style.display = 'block';
    }

    function confirmDelete(itemId, itemName, event) {
        event.preventDefault();
        
        const confirmMessage = itemName             ? `Sind Sie sicher, dass Sie "${itemName}" löschen möchten?`             : "Sind Sie sicher, dass Sie diesen Artikel löschen möchten?";
        
        if (confirm(confirmMessage)) {
            window.location.href = `{{ url_for('delete_item', id='') }}${itemId}`;
        }
    }

    function duplicateItem(itemId, event) {
        event.preventDefault();
        event.stopPropagation();

        document.getElementById('item-modal').style.display = 'none';

        fetch(`/get_item/${itemId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load item data');
                }
                return response.json();
            })
            .then(data => {
                showEditItemForm(data.item, true);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Fehler beim Laden der Objektdaten');
            });
    }

    function populateFilterOptions(containerId, filterValues, filterNum) {
        const container = document.getElementById(containerId);
        if (!container) {
            debugLog(`Container not found: ${containerId}`);
            return;
        }
        
        container.innerHTML = ''; // Clear previous options
        
        // First group values by category/prefix if they exist
        const groupedValues = {};
        
        // Process filter values to identify groups
        filterValues.forEach(value => {
            if (!value) return; // Skip empty values
            
            let group = 'Default';
            let displayValue = value;
            
            // Check if value contains grouping delimiter
            if (typeof value === 'string' && value.includes(':')) {
                [group, displayValue] = value.split(':', 2);
            }
            
            // Initialize group array if needed
            if (!groupedValues[group]) {
                groupedValues[group] = [];
            }
            
            // Add value to group
            groupedValues[group].push(displayValue);
        });
        
        // Now create DOM elements for each group
        Object.keys(groupedValues).sort().forEach(group => {
            // Skip empty groups
            if (!groupedValues[group].length) return;
            
            // Create option group
            const groupDiv = document.createElement('div');
            groupDiv.className = 'filter-option-group';
            
            // Add group header if not default
            if (group !== 'Default') {
                const header = document.createElement('div');
                header.className = 'filter-group-header';
                header.textContent = group;
                groupDiv.appendChild(header);
            }
            
            // Add each filter option in this group
            groupedValues[group].sort().forEach(value => {
                // Create filter option
                const optionDiv = document.createElement('div');
                optionDiv.className = 'filter-option';
                
                // Create unique ID for checkbox
                const safeValue = value.replace(/[^a-zA-Z0-9]/g, '_');
                const safeGroup = group.replace(/[^a-zA-Z0-9]/g, '_');
                const id = `filter${filterNum}-${safeGroup}-${safeValue}`;
                
                // Create checkbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = id;
                checkbox.value = value;
                
                // Store group info for filtering
                if (group !== 'Default') {
                    checkbox.dataset.group = group;
                }
                
                // Check if this value is already active
                const filterValue = group !== 'Default' ? `${group}:${value}` : value;
                checkbox.checked = activeFilters[`filter${filterNum}`].includes(filterValue);
                
                // Add change handler
                checkbox.onchange = () => {
                    updateFilter(filterNum, value, checkbox.checked, 
                        group !== 'Default' ? group : '');
                };
                
                // Create label
                const label = document.createElement('label');
                label.htmlFor = id;
                label.textContent = value;
                
                // Add to DOM
                optionDiv.appendChild(checkbox);
                optionDiv.appendChild(label);
                groupDiv.appendChild(optionDiv);
            });
            
            // Add group to container
            container.appendChild(groupDiv);
        });
        
        debugLog(`Populated ${filterValues.length} options for filter ${filterNum}`);
    }

    function checkFilterMatch(activeFilterValues, itemFilterValuesJSON) {
        // If no active filters, all items match
        if (!activeFilterValues || activeFilterValues.length === 0) {
            return true;
        }
        
        try {
            // Parse item filter values
            const itemFilterValues = JSON.parse(itemFilterValuesJSON || '[]');
            
            // If item has no values, it can't match any filters
            if (!itemFilterValues || itemFilterValues.length === 0) {
                return false;
            }
            
            // Check if ANY active filter values match ANY item filter values
            for (const activeFilter of activeFilterValues) {
                // Extract value from activeFilter (remove group prefix if exists)
                const activeValue = activeFilter.includes(':') 
                    ? activeFilter.split(':')[1] 
                    : activeFilter;
                
                // Check if any item filter value matches this active filter
                if (itemFilterValues.includes(activeValue)) {
                    return true;
                }
            }
            
            // No match found
            return false;
        } catch (err) {
            console.error("Error in checkFilterMatch:", err);
            debugLog("Error in checkFilterMatch:", {
                error: err.message,
                activeFilters: activeFilterValues,
                itemFilters: itemFilterValuesJSON
            });
            return false;
        }
    }

    function clearCodeSearch() {
        const searchInput = document.getElementById('code-search');
        searchInput.value = '';
        codeSearchTerm = '';
        
        // Reset highlighting
        const itemsContainer = document.querySelector('#items-container');
        const allCards = itemsContainer.querySelectorAll('.item-card');
        allCards.forEach(card => {
            card.classList.remove('highlight-item', 'code-match', 'exact-code-match');
        });
        
        // Apply filters to show all matching items
        applyFilters();
    }

    function openItemModal(item) {
        // Get modal elements
        const modal = document.getElementById('item-modal');
        const modalContent = document.getElementById('modal-content-wrapper');
        
        // Format filter values for display
        const filter1Array = Array.isArray(item.Filter) ? item.Filter : (item.Filter ? [item.Filter] : []);
        const filter2Array = Array.isArray(item.Filter2) ? item.Filter2 : (item.Filter2 ? [item.Filter2] : []);
        const filter3Array = Array.isArray(item.Filter3) ? item.Filter3 : (item.Filter3 ? [item.Filter3] : []);
        
        // Build image HTML
        const imagesHtml = item.Images ? item.Images.map((image, index) => 
            `<img src="${image}" alt="${item.Name}" class="modal-image" id="modal-image-${index}" 
             style="display: ${index === 0 ? 'block' : 'none'};">`).join('') : '';
        
        // Check if item is borrowed
        const isBorrowed = !item.Verfuegbar;
        
        // Build borrower info panel if applicable
        let borrowerInfoHtml = '';
        if (isBorrowed && item.BorrowerInfo) {
            borrowerInfoHtml = `
                <div class="borrower-info-panel">
                    <h4>Ausleihstatus</h4>
                    <p class="borrower-name">Ausgeliehen von: ${item.BorrowerInfo.username}</p>
                    <p class="borrow-time">Seit: ${item.BorrowerInfo.borrowTime || 'Unbekannt'}</p>
                </div>
            `;
        }
        
        // Build modal content HTML
        modalContent.innerHTML = `
            <h2>${item.Name}</h2>
            ${borrowerInfoHtml}
            
            <div class="modal-image-container">
                ${imagesHtml}
                ${item.Images && item.Images.length > 1 ? `
                    <button class="modal-image-nav modal-prev-image" onclick="changeModalImage(-1)">&#10094;</button>
                    <button class="modal-image-nav modal-next-image" onclick="changeModalImage(1)">&#10095;</button>
                    <div class="image-counter">1/${item.Images.length}</div>
                ` : ''}
            </div>
            
            <div class="modal-details">
                <div class="detail-group">
                    <div class="detail-label">Ort:</div>
                    <div class="detail-value">${item.Ort || '-'}</div>
                </div>
                
                <div class="detail-group">
                    <div class="detail-label">Status:</div>
                    <div class="detail-value ${isBorrowed ? 'status-borrowed' : ''}">
                        ${isBorrowed ? 'Ausgeliehen' : 'Verfügbar'}
                    </div>
                </div>
                
                <div class="detail-group">
                    <div class="detail-label">Unterrichtsfach:</div>
                    <div class="detail-value">${filter1Array.join(', ') || '-'}</div>
                </div>
                
                <div class="detail-group">
                    <div class="detail-label">Jahrgangsstufe:</div>
                    <div class="detail-value">${filter2Array.join(', ') || '-'}</div>
                </div>
                
                <div class="detail-group">
                    <div class="detail-label">Thema:</div>
                    <div class="detail-value">${filter3Array.join(', ') || '-'}</div>
                </div>
                
                <div class="detail-group">
                    <div class="detail-label">Code:</div>
                    <div class="detail-value">${item.Code_4 || '-'}</div>
                </div>
                
                <div class="detail-group">
                    <div class="detail-label">Anschaffungsjahr:</div>
                    <div class="detail-value">${item.Anschaffungsjahr || '-'}</div>
                </div>
                
                <div class="detail-group">
                    <div class="detail-label">Anschaffungskosten:</div>
                    <div class="detail-value">${item.Anschaffungskosten || '-'}</div>
                </div>
                
                <div class="detail-group full-width">
                    <div class="detail-label">Beschreibung:</div>
                    <div class="detail-value">${item.Beschreibung || '-'}</div>
                </div>
            </div>
            
            <div class="modal-actions">
                ${item.Verfuegbar ? 
                    `<form method="POST" action="/ausleihen/${item._id}">
                        <button class="ausleihen" type="submit">Ausleihen</button>
                    </form>` 
                    : (item.User === currentUsername) ?
                    `<form method="POST" action="/zurueckgeben/${item._id}">
                        <button class="ausleihen" type="submit">Zurückgeben</button>
                    </form>`
                    : `<button class="ausleihen disabled-button" disabled>Ausgeliehen</button>`
                }
                <a href="#" class="edit-button" onclick="editItem('${item._id}', event)">Bearbeiten</a>
                <a href="#" class="duplicate-button" onclick="duplicateItem('${item._id}', event)">Duplizieren</a>
                <a href="#" class="delete-button" onclick="confirmDelete('${item._id}', '${item.Name}', event)">Löschen</a>
            </div>
        `;
        
        // Show the modal
        modal.style.display = 'block';
        
        // Set up close button
        const closeButton = modal.querySelector('.close-modal');
        closeButton.onclick = function() {
            modal.style.display = 'none';
        };
        
        // Store current image index for navigation
        window.currentModalImageIndex = 0;
        window.totalModalImages = item.Images ? item.Images.length : 0;
        
        // Set up click outside to close
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };
    }

    function changeModalImage(direction) {
        const images = document.querySelectorAll('.modal-image');
        if (images.length === 0) return;
        
        // Hide current image
        images[window.currentModalImageIndex].style.display = 'none';
        
        // Update index
        window.currentModalImageIndex = (window.currentModalImageIndex + direction + images.length) % images.length;
        
        // Show new image
        images[window.currentModalImageIndex].style.display = 'block';
        
        // Update image counter text
        const counterText = document.querySelector('.image-counter');
        if (counterText) {
            counterText.textContent = `${window.currentModalImageIndex + 1}/${images.length}`;
        }
    }

    function editItem(itemId, event) {
        event.preventDefault();
        event.stopPropagation();

        document.getElementById('item-modal').style.display = 'none';

        fetch(`/get_item/${itemId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load item data');
                }
                return response.json();
            })
            .then(data => {
                showEditItemForm(data.item, false);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Fehler beim Laden der Objektdaten');
            });
    }

    function showEditItemForm(item, isDuplicate) {
        // Reset the form
        const form = document.getElementById('edit-item-form');
        form.reset();
        
        // Set form action based on duplicate or edit
        // Fix: Use upload_item endpoint for duplicating and add a hidden field to indicate duplication
        const formAction = isDuplicate 
            ? "{{ url_for('upload_item') }}" 
            : "{{ url_for('edit_item', id='') }}" + item._id;
        form.setAttribute('action', formAction);
        
        // Add a hidden field to indicate this is a duplication if needed
        if (isDuplicate) {
            // Remove any existing is_duplicating field
            const existingField = form.querySelector('input[name="is_duplicating"]');
            if (existingField) {
                existingField.remove();
            }
            
            // Add hidden field to indicate duplication
            const hiddenField = document.createElement('input');
            hiddenField.type = 'hidden';
            hiddenField.name = 'is_duplicating';
            hiddenField.value = 'true';
            form.appendChild(hiddenField);
            
            // Also add duplicate_images fields for any existing images
            if (item.Images && item.Images.length > 0) {
                item.Images.forEach(image => {
                    // Extract just the filename without the path
                    const imageName = image.split('/').pop();
                    const imageField = document.createElement('input');
                    imageField.type = 'hidden';
                    imageField.name = 'duplicate_images';
                    imageField.value = imageName;
                    form.appendChild(imageField);
                });
            }
        }
        
        // Fill in the form fields
        document.getElementById('edit-item-id').value = item._id;
        document.getElementById('edit-name').value = item.Name;
        document.getElementById('edit-ort').value = item.Ort;
        document.getElementById('edit-beschreibung').value = item.Beschreibung;
        document.getElementById('edit-anschaffungsjahr').value = item.Anschaffungsjahr ? item.Anschaffungsjahr.split('T')[0] : '';
        document.getElementById('edit-anschaffungskosten').value = item.Anschaffungskosten;
        document.getElementById('edit-code4').value = item.Code_4;
        
        // Handle filters - split by comma and trim spaces
        const filter1Values = Array.isArray(item.Filter) ? item.Filter : (item.Filter ? [item.Filter] : []);
        const filter2Values = Array.isArray(item.Filter2) ? item.Filter2 : (item.Filter2 ? [item.Filter2] : []);
        const filter3Values = Array.isArray(item.Filter3) ? item.Filter3 : (item.Filter3 ? [item.Filter3] : []);
        
        // Clear existing filter selections
        activeFilters.filter1 = [];
        activeFilters.filter2 = [];
        activeFilters.filter3 = [];
        
        // Set filter values in the form
        setFilterValuesInForm('edit-filter1', filter1Values);
        setFilterValuesInForm('edit-filter2', filter2Values);
        setFilterValuesInForm('edit-filter3', filter3Values);
        
        // Add ISBN and exemplar values if they exist
        document.getElementById('edit-isbn').value = item.ISBN || '';
        document.getElementById('edit-exemplare').value = item.Exemplare || 1;
        
        // Update exemplare status if this is an edit (not duplicate)
        if (!isDuplicate && item.ExemplareStatus) {
            updateExemplareStatus('edit', item.ExemplareStatus);
        }
        
        // Show the edit modal
        document.getElementById('edit-modal').style.display = 'block';
        
        // Center the modal in the viewport
        const modal = document.getElementById('edit-modal');
        modal.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Close modals and reset forms
    function closeEditModal() {
        document.getElementById('edit-modal').style.display = 'none';
    }

    function closeItemModal() {
        document.getElementById('item-modal').style.display = 'none';
    }

    // Update selected filters display function
    function updateSelectedFiltersDisplay(filterNum) {
        const container = document.getElementById(`selected-filter${filterNum}`);
        container.innerHTML = '';
        
        activeFilters[`filter${filterNum}`].forEach(filter => {
            // Extract display value from filter
            let displayValue = filter;
            let groupName = '';
            
            // Handle group:value format
            if (filter.includes(':')) {
                [groupName, displayValue] = filter.split(':');
            }
            
            // Create filter tag
            const tag = document.createElement('div');
            tag.className = 'filter-tag';
            
            // Show group if present
            let tagContent = '';
            if (groupName) {
                tagContent += `<span class="filter-tag-group">${groupName}:</span>`;
            }
            
            // Add filter value and remove button
            tagContent += displayValue;
            tagContent += `<button class="filter-tag-remove" onclick="removeFilter(${filterNum}, '${filter}')">&times;</button>`;
            
            tag.innerHTML = tagContent;
            container.appendChild(tag);
        });
    }

    function searchByCode() {
        const searchInput = document.getElementById('code-search');
        const rawSearchTerm = searchInput.value;
        codeSearchTerm = rawSearchTerm.trim().toLowerCase();
        
        // Add visual feedback when searching
        searchInput.classList.add('searching');
        
        // Reset highlighting
        const itemsContainer = document.querySelector('#items-container');
        const allCards = itemsContainer.querySelectorAll('.item-card');
        allCards.forEach(card => {
            card.classList.remove('highlight-item', 'code-match', 'exact-code-match');
        });
        
        // Apply filters which will handle highlighting
        applyFilters(true); // Pass true to indicate this is a direct search
        
        // Remove visual feedback after a delay
        setTimeout(() => {
            searchInput.classList.remove('searching');
        }, 500);
    }

    function applyFilters(isDirectSearch = false) {
        const itemsContainer = document.querySelector('#items-container');
        const items = itemsContainer.querySelectorAll('.item-card');
        
        let visibleCount = 0;
        let codeMatchCount = 0;
        let exactMatchCount = 0;
        let firstMatchedCard = null;
        let exactMatchCard = null;
        
        // Process search term
        const searchTerm = codeSearchTerm ? codeSearchTerm.trim().toLowerCase() : '';
        const isCodeSearch = searchTerm.length > 0;
        
        items.forEach(item => {
            const itemFilter1 = item.dataset.filter1;
            const itemFilter2 = item.dataset.filter2;
            const itemFilter3 = item.dataset.filter3;
            const rawCode = item.dataset.code || '';
            const itemCode = rawCode.trim().toLowerCase();
            
            // Check if item matches all active filters
            const matchesFilter1 = checkFilterMatch(activeFilters.filter1, itemFilter1);
            const matchesFilter2 = checkFilterMatch(activeFilters.filter2, itemFilter2);
            const matchesFilter3 = checkFilterMatch(activeFilters.filter3, itemFilter3);
            const passesAllFilters = matchesFilter1 && matchesFilter2 && matchesFilter3;
            
            // Check for code match (special logic for exact matches)
            let matchesCodeSearch = !isCodeSearch || itemCode.includes(searchTerm);
            let exactCodeMatch = isCodeSearch && itemCode === searchTerm;
            
            if (passesAllFilters && matchesCodeSearch) {
                // Show item if it matches all filters and code search
                item.style.display = 'block';
                visibleCount++;
                
                // Add appropriate highlight classes for code matches
                if (exactCodeMatch) {
                    item.classList.add('highlight-item', 'exact-code-match');
                    exactMatchCount++;
                    if (!exactMatchCard) {
                        exactMatchCard = item;
                    }
                } else if (isCodeSearch && itemCode.includes(searchTerm)) {
                    item.classList.add('code-match');
                    codeMatchCount++;
                    if (!firstMatchedCard) {
                        firstMatchedCard = item;
                    }
                }
            } else {
                // Hide non-matching items
                item.style.display = 'none';
            }
        });
        
        // Handle scrolling and highlighting for code searches
        if (isCodeSearch && visibleCount > 0 && (codeMatchCount > 0 || exactMatchCount > 0)) {
            setTimeout(() => {
                // Prefer exact match, fallback to partial match
                const cardToHighlight = exactMatchCard || firstMatchedCard;
                
                if (cardToHighlight) {
                    // Center the matched card in view
                    centerCardInView(cardToHighlight, itemsContainer);
                    
                    // Add stronger attention-grabbing animation
                    applyAttentionAnimation(cardToHighlight);
                }
            }, 300);
        } else if (isDirectSearch && isCodeSearch && visibleCount === 0) {
            debugLog(`No matches found for search term "${searchTerm}"`, {
                allCodes: Array.from(items).map(item => item.dataset.code?.trim() || 'empty')
            });
        }
    }

    // Add function to toggle filter dropdowns
    function toggleFilterDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        if (dropdown.style.display === 'block') {
            dropdown.style.display = 'none';
        } else {
            // Close all other dropdowns first
            const dropdowns = document.querySelectorAll('.filter-dropdown');
            dropdowns.forEach(d => d.style.display = 'none');
            
            // Open this dropdown
            dropdown.style.display = 'block';
        }
    }
    
    // Function to load predefined filter values into dropdowns
    function loadPredefinedFilterValues(filterNum) {
        fetch(`/get_predefined_filter_values/${filterNum}`)
            .then(response => response.json())
            .then(data => {
                // Get all dropdowns for this filter
                const selector = filterNum === 1 ? 
                    'select[id^="filter1-"], select[id^="edit-filter1-"]' : 
                    'select[id^="filter2-"], select[id^="edit-filter2-"]';
                const dropdowns = document.querySelectorAll(selector);
                
                // Populate each dropdown
                dropdowns.forEach(dropdown => {
                    // Preserve the first option (placeholder)
                    const firstOption = dropdown.options[0];
                    
                    // Clear existing options except the first one
                    dropdown.innerHTML = '';
                    dropdown.appendChild(firstOption);
                    
                    // Add options for each value
                    data.values.forEach(value => {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        dropdown.appendChild(option);
                    });
                });
            })
            .catch(error => {
                console.error(`Error loading filter ${filterNum} values:`, error);
            });
    }
    
    // Update the setFilterValuesInForm function to handle selects
    function setFilterValuesInForm(prefix, values) {
        values.forEach((value, index) => {
            const input = document.getElementById(`${prefix}-${index + 1}`);
            if (input) {
                if (input.tagName === 'SELECT') {
                    // Find and select the matching option
                    const options = input.options;
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].value === value) {
                            input.selectedIndex = i;
                            break;
                        }
                    }
                    
                    // If not found, try to add it (might be a legacy value)
                    if (input.selectedIndex === 0 && value) {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value + ' (Legacy)';
                        input.appendChild(option);
                        input.selectedIndex = input.options.length - 1;
                    }
                } else {
                    // For regular inputs
                    input.value = value;
                }
            }
        });
    }
    
    // Function to fetch book information by ISBN
    function fetchBookInfo(formType) {
        // Determine which form we're working with (upload or edit)
        const isbnField = formType === 'edit' ? document.getElementById('edit-isbn') : document.getElementById('isbn');
        const infoContainer = formType === 'edit' ? document.getElementById('edit-book-info-container') : document.getElementById('book-info-container');
        const isbn = isbnField.value.trim().replace(/-/g, ''); // Remove hyphens
        
        if (!isbn) {
            alert('Bitte geben Sie eine ISBN ein.');
            return;
        }
        
        // Show loading indicator
        infoContainer.innerHTML = '<div class="loading-spinner">Informationen werden abgerufen...</div>';
        
        // Make API request to fetch book data
        fetch(`/fetch_book_info/${isbn}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Fehler beim Abrufen der Buchinformationen');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    infoContainer.innerHTML = `<div class="error-message">${data.error}</div>`;
                    return;
                }
                
                // Display book information
                infoContainer.innerHTML = `
                    <div class="book-info">
                        <h4>${data.title}</h4>
                        ${data.authors ? `<p><strong>Autor(en):</strong> ${data.authors}</p>` : ''}
                        ${data.publisher ? `<p><strong>Verlag:</strong> ${data.publisher}</p>` : ''}
                        ${data.publishedDate ? `<p><strong>Erscheinungsdatum:</strong> ${data.publishedDate}</p>` : ''}
                        ${data.pageCount ? `<p><strong>Seitenanzahl:</strong> ${data.pageCount}</p>` : ''}
                        ${data.thumbnail ? `<img src="${data.thumbnail}" alt="Buchcover" class="book-thumbnail">` : ''}
                        ${data.description ? `
                            <div class="book-description">
                                <h5>Beschreibung:</h5>
                                <p>${data.description}</p>
                            </div>
                        ` : ''}
                        <button type="button" class="use-book-info-button" onclick="useBookInfo('${formType}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">Informationen übernehmen</button>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error:', error);
                infoContainer.innerHTML = `<div class="error-message">Fehler: ${error.message}</div>`;
            });
    }
    
    // Function to apply fetched book information to the form
    function useBookInfo(formType, bookData) {
        // Determine which form we're updating
        const nameField = formType === 'edit' ? document.getElementById('edit-name') : document.getElementById('name');
        const descField = formType === 'edit' ? document.getElementById('edit-beschreibung') : document.getElementById('beschreibung');
        
        // Update form fields with book data
        nameField.value = bookData.title || '';
        
        // Create a description that includes book metadata and the actual description
        let fullDescription = '';
        if (bookData.authors) fullDescription += `Autor(en): ${bookData.authors}\n`;
        if (bookData.publisher) fullDescription += `Verlag: ${bookData.publisher}\n`;
        if (bookData.publishedDate) fullDescription += `Erscheinungsdatum: ${bookData.publishedDate}\n`;
        if (bookData.pageCount) fullDescription += `Seitenanzahl: ${bookData.pageCount}\n`;
        if (bookData.description) fullDescription += `\nBeschreibung:\n${bookData.description}`;
        
        descField.value = fullDescription;
        
        // Set appropriate filter values for books
        setFilterValuesForBook(formType, 'Buch');
        
        // Show confirmation
        alert('Buchinformationen wurden übernommen!');
    }
    
    // Function to set appropriate filter values for books
    function setFilterValuesForBook(formType, bookType) {
        const prefix = formType === 'edit' ? 'edit-' : '';
        
        // Set filter1 (Unterrichtsfach) to 'Buch' if available in options
        const filter1Select = document.getElementById(`${prefix}filter1-1`);
        if (filter1Select) {
            for (let i = 0; i < filter1Select.options.length; i++) {
                if (filter1Select.options[i].value === bookType) {
                    filter1Select.selectedIndex = i;
                    break;
                }
            }
        }
    }
    
    // Function to update exemplare status display
    function updateExemplareStatus(formType, borrowedData) {
        const statusContainer = formType === 'edit' ? document.getElementById('edit-exemplare-status') : null;
        if (!statusContainer) return;
        
        if (borrowedData && borrowedData.length > 0) {
            let statusHtml = '<h5>Ausleihstatus der Exemplare:</h5><ul>';
            borrowedData.forEach((item, index) => {
                statusHtml += `<li>Exemplar ${index + 1}: ${item.available ? 
                    '<span class="available-status">Verfügbar</span>' : 
                    `<span class="borrowed-status">Ausgeliehen an ${item.user}</span>`}</li>`;
            });
            statusHtml += '</ul>';
            statusContainer.innerHTML = statusHtml;
        } else {
            statusContainer.innerHTML = '';
        }
    }
    
    // Update edit item function to handle exemplare data
    function showEditItemForm(item, isDuplicate) {
        // Reset the form
        const form = document.getElementById('edit-item-form');
        form.reset();
        
        // Set form action based on duplicate or edit
        // Fix: Use upload_item endpoint for duplicating and add a hidden field to indicate duplication
        const formAction = isDuplicate 
            ? "{{ url_for('upload_item') }}" 
            : "{{ url_for('edit_item', id='') }}" + item._id;
        form.setAttribute('action', formAction);
        
        // Add a hidden field to indicate this is a duplication if needed
        if (isDuplicate) {
            // Remove any existing is_duplicating field
            const existingField = form.querySelector('input[name="is_duplicating"]');
            if (existingField) {
                existingField.remove();
            }
            
            // Add hidden field to indicate duplication
            const hiddenField = document.createElement('input');
            hiddenField.type = 'hidden';
            hiddenField.name = 'is_duplicating';
            hiddenField.value = 'true';
            form.appendChild(hiddenField);
            
            // Also add duplicate_images fields for any existing images
            if (item.Images && item.Images.length > 0) {
                item.Images.forEach(image => {
                    // Extract just the filename without the path
                    const imageName = image.split('/').pop();
                    const imageField = document.createElement('input');
                    imageField.type = 'hidden';
                    imageField.name = 'duplicate_images';
                    imageField.value = imageName;
                    form.appendChild(imageField);
                });
            }
        }
        
        // Fill in the form fields
        document.getElementById('edit-item-id').value = item._id;
        document.getElementById('edit-name').value = item.Name;
        document.getElementById('edit-ort').value = item.Ort;
        document.getElementById('edit-beschreibung').value = item.Beschreibung;
        document.getElementById('edit-anschaffungsjahr').value = item.Anschaffungsjahr ? item.Anschaffungsjahr.split('T')[0] : '';
        document.getElementById('edit-anschaffungskosten').value = item.Anschaffungskosten;
        document.getElementById('edit-code4').value = item.Code_4;
        
        // Handle filters - split by comma and trim spaces
        const filter1Values = Array.isArray(item.Filter) ? item.Filter : (item.Filter ? [item.Filter] : []);
        const filter2Values = Array.isArray(item.Filter2) ? item.Filter2 : (item.Filter2 ? [item.Filter2] : []);
        const filter3Values = Array.isArray(item.Filter3) ? item.Filter3 : (item.Filter3 ? [item.Filter3] : []);
        
        // Clear existing filter selections
        activeFilters.filter1 = [];
        activeFilters.filter2 = [];
        activeFilters.filter3 = [];
        
        // Set filter values in the form
        setFilterValuesInForm('edit-filter1', filter1Values);
        setFilterValuesInForm('edit-filter2', filter2Values);
        setFilterValuesInForm('edit-filter3', filter3Values);
        
        // Add ISBN and exemplar values if they exist
        document.getElementById('edit-isbn').value = item.ISBN || '';
        document.getElementById('edit-exemplare').value = item.Exemplare || 1;
        
        // Update exemplare status if this is an edit (not duplicate)
        if (!isDuplicate && item.ExemplareStatus) {
            updateExemplareStatus('edit', item.ExemplareStatus);
        }
        
        // Show the edit modal
        document.getElementById('edit-modal').style.display = 'block';
        
        // Center the modal in the viewport
        const modal = document.getElementById('edit-modal');
        modal.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Close modals and reset forms
    function closeEditModal() {
        document.getElementById('edit-modal').style.display = 'none';
    }

    function closeItemModal() {
        document.getElementById('item-modal').style.display = 'none';
    }

    // Update selected filters display function
    function updateSelectedFiltersDisplay(filterNum) {
        const container = document.getElementById(`selected-filter${filterNum}`);
        container.innerHTML = '';
        
        activeFilters[`filter${filterNum}`].forEach(filter => {
            // Extract display value from filter
            let displayValue = filter;
            let groupName = '';
            
            // Handle group:value format
            if (filter.includes(':')) {
                [groupName, displayValue] = filter.split(':');
            }
            
            // Create filter tag
            const tag = document.createElement('div');
            tag.className = 'filter-tag';
            
            // Show group if present
            let tagContent = '';
            if (groupName) {
                tagContent += `<span class="filter-tag-group">${groupName}:</span>`;
            }
            
            // Add filter value and remove button
            tagContent += displayValue;
            tagContent += `<button class="filter-tag-remove" onclick="removeFilter(${filterNum}, '${filter}')">&times;</button>`;
            
            tag.innerHTML = tagContent;
            container.appendChild(tag);
        });
    }

    function searchByCode() {
        const searchInput = document.getElementById('code-search');
        const rawSearchTerm = searchInput.value;
        codeSearchTerm = rawSearchTerm.trim().toLowerCase();
        
        // Add visual feedback when searching
        searchInput.classList.add('searching');
        
        // Reset highlighting
        const itemsContainer = document.querySelector('#items-container');
        const allCards = itemsContainer.querySelectorAll('.item-card');
        allCards.forEach(card => {
            card.classList.remove('highlight-item', 'code-match', 'exact-code-match');
        });
        
        // Apply filters which will handle highlighting
        applyFilters(true); // Pass true to indicate this is a direct search
        
        // Remove visual feedback after a delay
        setTimeout(() => {
            searchInput.classList.remove('searching');
        }, 500);
    }

    function applyFilters(isDirectSearch = false) {
        const itemsContainer = document.querySelector('#items-container');
        const items = itemsContainer.querySelectorAll('.item-card');
        
        let visibleCount = 0;
        let codeMatchCount = 0;
        let exactMatchCount = 0;
        let firstMatchedCard = null;
        let exactMatchCard = null;
        
        // Process search term
        const searchTerm = codeSearchTerm ? codeSearchTerm.trim().toLowerCase() : '';
        const isCodeSearch = searchTerm.length > 0;
        
        items.forEach(item => {
            const itemFilter1 = item.dataset.filter1;
            const itemFilter2 = item.dataset.filter2;
            const itemFilter3 = item.dataset.filter3;
            const rawCode = item.dataset.code || '';
            const itemCode = rawCode.trim().toLowerCase();
            
            // Check if item matches all active filters
            const matchesFilter1 = checkFilterMatch(activeFilters.filter1, itemFilter1);
            const matchesFilter2 = checkFilterMatch(activeFilters.filter2, itemFilter2);
            const matchesFilter3 = checkFilterMatch(activeFilters.filter3, itemFilter3);
            const passesAllFilters = matchesFilter1 && matchesFilter2 && matchesFilter3;
            
            // Check for code match (special logic for exact matches)
            let matchesCodeSearch = !isCodeSearch || itemCode.includes(searchTerm);
            let exactCodeMatch = isCodeSearch && itemCode === searchTerm;
            
            if (passesAllFilters && matchesCodeSearch) {
                // Show item if it matches all filters and code search
                item.style.display = 'block';
                visibleCount++;
                
                // Add appropriate highlight classes for code matches
                if (exactCodeMatch) {
                    item.classList.add('highlight-item', 'exact-code-match');
                    exactMatchCount++;
                    if (!exactMatchCard) {
                        exactMatchCard = item;
                    }
                } else if (isCodeSearch && itemCode.includes(searchTerm)) {
                    item.classList.add('code-match');
                    codeMatchCount++;
                    if (!firstMatchedCard) {
                        firstMatchedCard = item;
                    }
                }
            } else {
                // Hide non-matching items
                item.style.display = 'none';
            }
        });
        
        // Handle scrolling and highlighting for code searches
        if (isCodeSearch && visibleCount > 0 && (codeMatchCount > 0 || exactMatchCount > 0)) {
            setTimeout(() => {
                // Prefer exact match, fallback to partial match
                const cardToHighlight = exactMatchCard || firstMatchedCard;
                
                if (cardToHighlight) {
                    // Center the matched card in view
                    centerCardInView(cardToHighlight, itemsContainer);
                    
                    // Add stronger attention-grabbing animation
                    applyAttentionAnimation(cardToHighlight);
                }
            }, 300);
        } else if (isDirectSearch && isCodeSearch && visibleCount === 0) {
            debugLog(`No matches found for search term "${searchTerm}"`, {
                allCodes: Array.from(items).map(item => item.dataset.code?.trim() || 'empty')
            });
        }
    }

    // Add function to toggle filter dropdowns
    function toggleFilterDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        if (dropdown.style.display === 'block') {
            dropdown.style.display = 'none';
        } else {
            // Close all other dropdowns first
            const dropdowns = document.querySelectorAll('.filter-dropdown');
            dropdowns.forEach(d => d.style.display = 'none');
            
            // Open this dropdown
            dropdown.style.display = 'block';
        }
    }
    
    // Function to load predefined filter values into dropdowns
    function loadPredefinedFilterValues(filterNum) {
        fetch(`/get_predefined_filter_values/${filterNum}`)
            .then(response => response.json())
            .then(data => {
                // Get all dropdowns for this filter
                const selector = filterNum === 1 ? 
                    'select[id^="filter1-"], select[id^="edit-filter1-"]' : 
                    'select[id^="filter2-"], select[id^="edit-filter2-"]';
                const dropdowns = document.querySelectorAll(selector);
                
                // Populate each dropdown
                dropdowns.forEach(dropdown => {
                    // Preserve the first option (placeholder)
                    const firstOption = dropdown.options[0];
                    
                    // Clear existing options except the first one
                    dropdown.innerHTML = '';
                    dropdown.appendChild(firstOption);
                    
                    // Add options for each value
                    data.values.forEach(value => {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        dropdown.appendChild(option);
                    });
                });
            })
            .catch(error => {
                console.error(`Error loading filter ${filterNum} values:`, error);
            });
    }
    
    // Update the setFilterValuesInForm function to handle selects
    function setFilterValuesInForm(prefix, values) {
        values.forEach((value, index) => {
            const input = document.getElementById(`${prefix}-${index + 1}`);
            if (input) {
                if (input.tagName === 'SELECT') {
                    // Find and select the matching option
                    const options = input.options;
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].value === value) {
                            input.selectedIndex = i;
                            break;
                        }
                    }
                    
                    // If not found, try to add it (might be a legacy value)
                    if (input.selectedIndex === 0 && value) {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value + ' (Legacy)';
                        input.appendChild(option);
                        input.selectedIndex = input.options.length - 1;
                    }
                } else {
                    // For regular inputs
                    input.value = value;
                }
            }
        });
    }
    
    // Function to fetch book information by ISBN
    function fetchBookInfo(formType) {
        // Determine which form we're working with (upload or edit)
        const isbnField = formType === 'edit' ? document.getElementById('edit-isbn') : document.getElementById('isbn');
        const infoContainer = formType === 'edit' ? document.getElementById('edit-book-info-container') : document.getElementById('book-info-container');
        const isbn = isbnField.value.trim().replace(/-/g, ''); // Remove hyphens
        
        if (!isbn) {
            alert('Bitte geben Sie eine ISBN ein.');
            return;
        }
        
        // Show loading indicator
        infoContainer.innerHTML = '<div class="loading-spinner">Informationen werden abgerufen...</div>';
        
        // Make API request to fetch book data
        fetch(`/fetch_book_info/${isbn}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Fehler beim Abrufen der Buchinformationen');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    infoContainer.innerHTML = `<div class="error-message">${data.error}</div>`;
                    return;
                }
                
                // Display book information
                infoContainer.innerHTML = `
                    <div class="book-info">
                        <h4>${data.title}</h4>
                        ${data.authors ? `<p><strong>Autor(en):</strong> ${data.authors}</p>` : ''}
                        ${data.publisher ? `<p><strong>Verlag:</strong> ${data.publisher}</p>` : ''}
                        ${data.publishedDate ? `<p><strong>Erscheinungsdatum:</strong> ${data.publishedDate}</p>` : ''}
                        ${data.pageCount ? `<p><strong>Seitenanzahl:</strong> ${data.pageCount}</p>` : ''}
                        ${data.thumbnail ? `<img src="${data.thumbnail}" alt="Buchcover" class="book-thumbnail">` : ''}
                        ${data.description ? `
                            <div class="book-description">
                                <h5>Beschreibung:</h5>
                                <p>${data.description}</p>
                            </div>
                        ` : ''}
                        <button type="button" class="use-book-info-button" onclick="useBookInfo('${formType}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">Informationen übernehmen</button>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error:', error);
                infoContainer.innerHTML = `<div class="error-message">Fehler: ${error.message}</div>`;
            });
    }
    
    // Function to apply fetched book information to the form
    function useBookInfo(formType, bookData) {
        // Determine which form we're updating
        const nameField = formType === 'edit' ? document.getElementById('edit-name') : document.getElementById('name');
        const descField = formType === 'edit' ? document.getElementById('edit-beschreibung') : document.getElementById('beschreibung');
        
        // Update form fields with book data
        nameField.value = bookData.title || '';
        
        // Create a description that includes book metadata and the actual description
        let fullDescription = '';
        if (bookData.authors) fullDescription += `Autor(en): ${bookData.authors}\n`;
        if (bookData.publisher) fullDescription += `Verlag: ${bookData.publisher}\n`;
        if (bookData.publishedDate) fullDescription += `Erscheinungsdatum: ${bookData.publishedDate}\n`;
        if (bookData.pageCount) fullDescription += `Seitenanzahl: ${bookData.pageCount}\n`;
        if (bookData.description) fullDescription += `\nBeschreibung:\n${bookData.description}`;
        
        descField.value = fullDescription;
        
        // Set appropriate filter values for books
        setFilterValuesForBook(formType, 'Buch');
        
        // Show confirmation
        alert('Buchinformationen wurden übernommen!');
    }
    
    // Function to set appropriate filter values for books
    function setFilterValuesForBook(formType, bookType) {
        const prefix = formType === 'edit' ? 'edit-' : '';
        
        // Set filter1 (Unterrichtsfach) to 'Buch' if available in options
        const filter1Select = document.getElementById(`${prefix}filter1-1`);
        if (filter1Select) {
            for (let i = 0; i < filter1Select.options.length; i++) {
                if (filter1Select.options[i].value === bookType) {
                    filter1Select.selectedIndex = i;
                    break;
                }
            }
        }
    }
    
    // Function to update exemplare status display
    function updateExemplareStatus(formType, borrowedData) {
        const statusContainer = formType === 'edit' ? document.getElementById('edit-exemplare-status') : null;
        if (!statusContainer) return;
        
        if (borrowedData && borrowedData.length > 0) {
            let statusHtml = '<h5>Ausleihstatus der Exemplare:</h5><ul>';
            borrowedData.forEach((item, index) => {
                statusHtml += `<li>Exemplar ${index + 1}: ${item.available ? 
                    '<span class="available-status">Verfügbar</span>' : 
                    `<span class="borrowed-status">Ausgeliehen an ${item.user}</span>`}</li>`;
            });
            statusHtml += '</ul>';
            statusContainer.innerHTML = statusHtml;
        } else {
            statusContainer.innerHTML = '';
        }
    }
</script>

<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
    }

    .container {
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        width: 80%;
        max-width: 1200px;
        margin: 20px auto;
    }

    h1, h2 {
        text-align: center;
    }

    /* Filter styles */
    .filter-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        margin-bottom: 20px;
    }

    .filter-group {
        position: relative;
        min-width: 200px;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
    }

    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .filter-toggle, .clear-filter {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 3px;
        padding: 3px 8px;
        cursor: pointer;
    }

    .clear-filter {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .filter-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        max-height: 300px; /* Increased height */
        overflow-y: auto;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        z-index: 100;
        padding: 8px;
    }

    .filter-options {
        padding: 10px;
    }

    .filter-option {
        margin-bottom: 5px;
        display: flex;
        align-items: center;
    }

    .filter-option input[type="checkbox"] {
        width: 16px;
        height: 16px;
        margin-right: 8px;
        cursor: pointer;
    }

    .filter-option:hover {
        background-color: #f5f5f5;
    }

    .filter-option label {
        margin-left: 5px;
        cursor: pointer;
    }

    .filter-option-group {
        margin-bottom: 12px;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
    }

    .filter-group-header {
        font-weight: bold;
        margin-bottom: 5px;
        color: #495057;
        font-size: 0.9rem;
    }

    .selected-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        min-height: 30px;
    }

    .filter-tag {
        display: inline-flex;
        align-items: center;
        background-color: #e9ecef;
        border-radius: 15px;
        padding: 3px 10px;
        font-size: 0.8rem;
    }

    .filter-tag-group {
        color: #6c757d;
        font-size: 0.8em;
        font-style: italic;
        margin-right: 2px;
    }

    .filter-tag-remove {
        background: none;
        border: none;
        color: #6c757d;
        margin-left: 5px;
        cursor: pointer;
        font-size: 1rem;
        line-height: 1;
    }

    /* Item display styles */
    .items-container {
        display: flex;
        overflow-x: auto; /* Change from hidden to auto */
        gap: 20px;
        padding: 20px 0;
        scroll-snap-type: x mandatory;
        position: relative; /* Added for better scroll positioning */
        scroll-behavior: smooth; /* Added for smoother scrolling */
    }

    .item-card {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        max-width: 300px;
        flex-shrink: 0;
        scroll-snap-align: center;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .item-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .item-card h3 {
        margin-top: 0;
    }

    .item-card .description {
        max-height: 100px;
        overflow-y: auto;
    }

    .item-card .image-container {
        position: relative;
        max-width: 300px;
        margin: 10px 0;
    }

    .item-card .item-image {
        width: 100%;
        height: auto;
        max-height: 300px; /* Set a maximum height for the images */
        display: none;
        object-fit: cover;
    }

    .item-card .item-image:first-child {
        display: block;
    }

    .clickable-card {
        cursor: pointer;
        position: relative;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .clickable-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 123, 255, 0.3);
    }

    .card-content {
        cursor: pointer;
        z-index: 1;
        position: relative;
    }

    .prev-image-button, .next-image-button {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        cursor: pointer;
        padding: 5px;
        border-radius: 5px;
    }

    .prev-image-button {
        left: -30px;
    }

    .next-image-button {
        right: -30px;
    }

    .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 10px;
    }

    .actions form, 
    .actions a {
        flex: 1 1 calc(33% - 5px);
        min-width: fit-content;
    }

    .actions form button,
    .actions a {
        width: 100%;
        font-size: 0.85rem;
        padding: 8px 5px;
        text-align: center;
    }

    button.ausleihen {
flex: 1;
        padding: 10px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
       }

    button.ausleihen:hover {
        background-color: #0056b3;
    }

    a.delete-button {
        flex: 1;
        padding: 10px;
        background-color: #dc3545;
        color: #fff;
        text-align: center;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
    }

    a.delete-button:hover {
        background-color: #c82333;
    }

    .duplicate-button {
        flex: 1;
        padding: 10px;
        background-color: #17a2b8;
        color: white;
        text-align: center;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
    }

    .duplicate-button:hover {
        background-color: #138496;
    }

    /* Form styles */
    .form-group {
        margin-bottom: 15px;
    }

    label {
        display: block;
        margin-bottom: 5px;
    }

    input[type="text"],
    textarea,
    input[type="file"],
    input[type="date"] {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .flash {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
    }

    .flash.success {
        background-color: #d4edda;
        color: #155724;
    }

    .flash.error {
        background-color: #f8d7da;
        color: #721c24;
    }

    /* Navigation and QR code scanning */
    .navigation-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
    }

    .navigation-buttons .prev-button,
    .navigation-buttons .next-button {
        background-color: #007bff;
        color: #fff;
        border: none;
        cursor: pointer;
        padding: 10px;
        border-radius: 5px;
    }

    .navigation-buttons .prev-button:hover,
    .navigation-buttons .next-button:hover {
        background-color: #0056b3;
    }

    .qr-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 20px;
    }

    .scan-button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-bottom: 10px;
    }

    .scan-button:hover {
        background-color: #0056b3;
    }

    #qr-reader {
        margin: 0 auto;
        max-width: 100%;
    }

    /* Search styles */
    .search-container {
        display: flex;
        gap: 5px;
        margin-top: 5px;
    }

    #code-search {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .search-button {
        padding: 8px 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .search-button:hover {
        background-color: #0056b3;
    }

    .search-field {
        min-width: 250px;
    }

    #code-search.searching {
        background-color: #fff3cd;
        transition: background-color 0.3s;
        border: 2px solid #ffc107;
        box-shadow: 0 0 8px rgba(255, 193, 7, 0.5);
    }

    /* Modal styles */
    .item-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        overflow-y: auto;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {opacity: 0;}
        to {opacity: 1;}
    }

    .modal-content {
        position: relative;
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 900px;
        animation: slideIn 0.3s ease;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        overflow: hidden;
    }

    @keyframes slideIn {
        from {transform: translateY(-20px); opacity: 0;}
        to {transform: translateY(0); opacity: 1;}
    }

    .close-modal {
        position: absolute;
        top: 15px;
        right: 20px;
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        z-index: 10;
    }

    .close-modal:hover {
        color: #000;
    }

    .modal-image-container {
        text-align: center;
        margin: 20px 0;
        position: relative;
        max-height: 500px;
        overflow: hidden;
    }

    .modal-image {
        max-width: 100%;
        max-height: 450px;
        border-radius: 5px;
        object-fit: contain;
    }

    .modal-image-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        padding: 15px;
        background-color: rgba(0,0,0,0.5);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 18px;
        opacity: 0.8;
        transition: opacity 0.3s;
    }

    .modal-image-nav:hover {
        opacity: 1;
        background-color: rgba(0,0,0,0.7);
    }

    .modal-prev-image {
        left: 15px;
    }

    .modal-next-image {
        right: 15px;
    }

    .modal-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .detail-group {
        margin-bottom: 15px;
    }

    .detail-label {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .detail-value {
        padding: 5px 0;
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        justify-content: flex-end;
    }

    .modal-actions .ausleihen,
    .modal-actions .delete-button,
    .modal-actions .qr-download-button {
        padding: 10px 20px;
    }

    .full-width {
        grid-column:  1 / -1;
    }

    /* Status indicators */
    .borrower-badge {
        background-color: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
        padding: 8px;
        margin: 10px 0;
        font-size: 0.85em;
        border-radius: 4px;
    }

    .borrow-time {
        font-size: 0.9em;
        color: #6c757d;
        font-style: italic;
        display: block;
        margin-top: 3px;
    }

    .borrower-info-panel {
        margin: 15px 0;
        padding: 15px;
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        border-radius: 4px;
    }

    .borrower-info-panel h4 {
        color: #856404;
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1.1em;
    }

    .borrower-name {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .status-borrowed {
        color: #dc3545;
        font-weight: bold;
    }

    .disabled-button {
        background-color: #6c757d;
        cursor: not-allowed;
        opacity: 0.65;
    }

    .highlight-item {
        border: 3px solid gold !important;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.7) !important;
        position: relative;
        z-index: 10;
        animation: highlight-pulse 2s infinite;
    }

    .code-match {
        border: 2px solid #17a2b8 !important;
        box-shadow: 0 0 15px rgba(23, 162, 184, 0.5) !important;
        position: relative;
        z-index: 5;
    }

    .exact-code-match {
        border: 3px solid #28a745 !important;
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.7) !important;
        animation: highlight-pulse 2s infinite;
        position: relative;
        z-index: 11; /* Higher than regular highlight */
    }

    @keyframes highlight-pulse {
        0% { box-shadow: 0 0 15px rgba(40, 167, 69, 0.7); }
        50% { box-shadow: 0 0 30px rgba(40, 167, 69, 1); transform: scale(1.03); }
        100% { box-shadow: 0 0 15px rgba(40, 167, 69, 0.7); }
    }

    /* Messages */
    .error-message, .no-items-message {
        padding: 20px;
        text-align: center;
        width: 100%;
        color: #721c24;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 5px;
        margin: 20px 0;
    }

    .no-items-message {
        color: #383d41;
        background-color: #e2e3e5;
        border-color: #d6d8db;
    }

    /* Admin-specific styles */
    .upload-form {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        border: 1px solid #dee2e6;
        margin-top: 30px;
    }

    .upload-form h2 {
        color: #495057;
        margin-top: 0;
        margin-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 10px;
    }

    .filter-inputs h3 {
        font-size: 1rem;
        margin: 15px 0 10px;
        color: #495057;
    }

    .multi-filter {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-bottom: 15px;
    }

    .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }

    .form-row .form-group {
        flex: 1 1 calc(50% - 15px);
        min-width: 200px;
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }

    .save-button, .cancel-button {
        padding: 10px 20px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        font-weight: bold;
    }

    .save-button {
        background-color: #28a745;
        color: white;
    }

    .save-button:hover {
        background-color: #218838;
    }

    .cancel-button {
        background-color: #6c757d;
        color: white;
    }

    .cancel-button:hover {
        background-color: #5a6268;
    }

    .edit-button {
        flex: 1;
        padding: 10px;
        background-color: #ffc107;
        color: #212529;
        text-align: center;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
    }

    .edit-button:hover {
        background-color: #e0a800;
    }

    .existing-images-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
    }

    .existing-image-item {
        position: relative;
        width: 100px;
        height: 100px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        overflow: hidden;
    }

    .existing-image-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .existing-image-item .remove-image {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: rgba(220, 53, 69, 0.8);
        color: white;
        border: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        font-size: 12px;
        line-height: 1;
        text-align: center;
        cursor: pointer;
    }

    /* Responsive styles */
    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
            gap: 10px;
        }
        
        .modal-content {
            width: 95%;
            padding: 15px;
        }
        
        .items-container {
            padding: 10px 0;
        }
        
        .item-card {
            max-width: 250px;
        }
        
        .filter-group {
            min-width: 150px;
        }
    }

    @media (max-width: 480px) {
        .container {
            width: 98%;
            padding: 10px;
        }
        
        .item-card {
            min-width: 200px;
            padding: 15px;
        }
        
        .actions {
            flex-direction: column;
        }
        
        .modal-details {
            grid-template-columns: 1fr;
        }
        
        .filter-container {
            flex-direction: column;
        }
        
        .filter-group {
            width: 100%;
        }
    }
</style>
{% endblock %}
--