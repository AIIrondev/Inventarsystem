<!--
   Copyright 2025 Maximilian Gründinger

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
{% extends "base.html" %}

{% block title %}Inventarsystem{% endblock %}

{% block content %}
<div class="container">
    <div class="content">
        <h1>Inventar Objekte</h1>
        <div class="filter-container">
            <div class="filter-group">
                <div class="filter-header">
                    <label>Unterrichtsfach:</label>
                    <button type="button" class="filter-toggle" onclick="toggleFilterDropdown('filter1-dropdown')">▼</button>
                    <button type="button" class="clear-filter" onclick="clearFilter(1)">Clear</button>
                </div>
                <div class="selected-filters" id="selected-filter1"></div>
                <div class="filter-dropdown" id="filter1-dropdown">
                    <div class="filter-options" id="filter1-options">
                        <!-- Filter options will be dynamically loaded here -->
                    </div>
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-header">
                    <label>Jahrgangsstufe:</label>
                    <button type="button" class="filter-toggle" onclick="toggleFilterDropdown('filter2-dropdown')">▼</button>
                    <button type="button" class="clear-filter" onclick="clearFilter(2)">Clear</button>
                </div>
                <div class="selected-filters" id="selected-filter2"></div>
                <div class="filter-dropdown" id="filter2-dropdown">
                    <div class="filter-options" id="filter2-options">
                        <!-- Filter options will be dynamically loaded here -->
                    </div>
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-header">
                    <label>Thema:</label>
                    <button type="button" class="filter-toggle" onclick="toggleFilterDropdown('filter3-dropdown')">▼</button>
                    <button type="button" class="clear-filter" onclick="clearFilter(3)">Clear</button>
                </div>
                <div class="selected-filters" id="selected-filter3"></div>
                <div class="filter-dropdown" id="filter3-dropdown">
                    <div class="filter-options" id="filter3-options">
                        <!-- Filter options will be dynamically loaded here -->
                    </div>
                </div>
            </div>

            <div class="filter-group search-field">
                <div class="filter-header">
                    <label for="code-search">Code suchen:</label>
                    <button type="button" class="clear-filter" onclick="clearCodeSearch()">Clear</button>
                </div>
                <div class="search-container">
                    <input type="text" id="code-search" placeholder="Code eingeben..." autocomplete="off">
                    <button type="button" class="search-button" onclick="searchByCode()">
                        <i class="fas fa-search"></i> Suchen
                    </button>
                </div>
            </div>
        </div>
        <div class="qr-container">
            <button id="scanButton" class="scan-button">QR-Code scannen</button>
            <div id="qr-reader" style="width: 500px; display: none;"></div>
        </div>

        <div id="items-container" class="items-container">
            <!-- Items will be dynamically loaded here -->
        </div>
        <div class="navigation-buttons">
            <button class="prev-button" onclick="scrollPrev()">&#10094;</button>
            <button class="next-button" onclick="scrollNext()">&#10095;</button>
        </div>
    </div>
    <div class="upload-form">
        <h2>Upload Item</h2>
        <form method="POST" action="{{ url_for('upload_item') }}" enctype="multipart/form-data">
            <div class="form-group">
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
                <label for="ort">Ort:</label>
                <input type="text" id="ort" name="ort" required>
            </div>
            <div class="form-group">
                <label for="beschreibung">Beschreibung:</label>
                <textarea id="beschreibung" name="beschreibung" required></textarea>
            </div>
            
            <!-- Updated filter inputs with multiple fields per category -->
            <div class="filter-inputs">
                <h3>Unterrichtsfach:</h3>
                <div class="multi-filter">
                    <div class="form-group">
                        <label for="filter1-1">Wert 1:</label>
                        <input type="text" id="filter1-1" name="filter" required>
                    </div>
                    <div class="form-group">
                        <label for="filter1-2">Wert 2:</label>
                        <input type="text" id="filter1-2" name="filter">
                    </div>
                    <div class="form-group">
                        <label for="filter1-3">Wert 3:</label>
                        <input type="text" id="filter1-3" name="filter">
                    </div>
                    <div class="form-group">
                        <label for="filter1-4">Wert 4:</label>
                        <input type="text" id="filter1-4" name="filter">
                    </div>
                </div>
                
                <h3>Jahrgangsstufe:</h3>
                <div class="multi-filter">
                    <div class="form-group">
                        <label for="filter2-1">Wert 1:</label>
                        <input type="text" id="filter2-1" name="filter2" required>
                    </div>
                    <div class="form-group">
                        <label for="filter2-2">Wert 2:</label>
                        <input type="text" id="filter2-2" name="filter2">
                    </div>
                    <div class="form-group">
                        <label for="filter2-3">Wert 3:</label>
                        <input type="text" id="filter2-3" name="filter2">
                    </div>
                    <div class="form-group">
                        <label for="filter2-4">Wert 4:</label>
                        <input type="text" id="filter2-4" name="filter2">
                    </div>
                </div>
                
                <h3>Thema:</h3>
                <div class="multi-filter">
                    <div class="form-group">
                        <label for="filter3-1">Wert 1:</label>
                        <input type="text" id="filter3-1" name="filter3" required>
                    </div>
                    <div class="form-group">
                        <label for="filter3-2">Wert 2:</label>
                        <input type="text" id="filter3-2" name="filter3">
                    </div>
                    <div class="form-group">
                        <label for="filter3-3">Wert 3:</label>
                        <input type="text" id="filter3-3" name="filter3">
                    </div>
                    <div class="form-group">
                        <label for="filter3-4">Wert 4:</label>
                        <input type="text" id="filter3-4" name="filter3">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="anschaffungsjahr">Anschaffungsdatum</label>
                <input type="date" id="anschaffungsjahr" name="anschaffungsjahr">
            </div>
            <div class="form-group">
                <label for="anschaffungskosten">Anschaffungskosten</label>
                <input id="anschaffungskosten" name="anschaffungskosten">
            </div>
            <div class="form-group">
                <label for="code_4">Code</label>
                <input id="code_4" name="code_4" required>
            </div>
            <div class="form-group">
                <label for="images">Bilder:</label>
                <input type="file" id="images" name="images" accept="image/*" multiple>
            </div>
            <button type="submit">Upload</button>
        </form>
    </div>
    <div id="item-modal" class="item-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="modal-content-wrapper">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Add the edit modal form -->
    <div id="edit-modal" class="item-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeEditModal()">&times;</span>
            <h2>Objekt bearbeiten</h2>
            <form id="edit-item-form" method="POST" enctype="multipart/form-data">
                <input type="hidden" id="edit-item-id" name="id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-name">Name:</label>
                        <input type="text" id="edit-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-ort">Ort:</label>
                        <input type="text" id="edit-ort" name="ort" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-beschreibung">Beschreibung:</label>
                    <textarea id="edit-beschreibung" name="beschreibung" required></textarea>
                </div>
                
                <!-- Updated filter inputs for edit form -->
                <div class="filter-inputs">
                    <h3>Unterrichtsfach:</h3>
                    <div class="multi-filter">
                        <div class="form-group">
                            <label for="edit-filter1-1">Wert 1:</label>
                            <input type="text" id="edit-filter1-1" name="filter">
                        </div>
                        <div class="form-group">
                            <label for="edit-filter1-2">Wert 2:</label>
                            <input type="text" id="edit-filter1-2" name="filter">
                        </div>
                        <div class="form-group">
                            <label for="edit-filter1-3">Wert 3:</label>
                            <input type="text" id="edit-filter1-3" name="filter">
                        </div>
                        <div class="form-group">
                            <label for="edit-filter1-4">Wert 4:</label>
                            <input type="text" id="edit-filter1-4" name="filter">
                        </div>
                    </div>
                    
                    <h3>Jahrgangsstufe:</h3>
                    <div class="multi-filter">
                        <div class="form-group">
                            <label for="edit-filter2-1">Wert 1:</label>
                            <input type="text" id="edit-filter2-1" name="filter2">
                        </div>
                        <div class="form-group">
                            <label for="edit-filter2-2">Wert 2:</label>
                            <input type="text" id="edit-filter2-2" name="filter2">
                        </div>
                        <div class="form-group">
                            <label for="edit-filter2-3">Wert 3:</label>
                            <input type="text" id="edit-filter2-3" name="filter2">
                        </div>
                        <div class="form-group">
                            <label for="edit-filter2-4">Wert 4:</label>
                            <input type="text" id="edit-filter2-4" name="filter2">
                        </div>
                    </div>
                    
                    <h3>Thema:</h3>
                    <div class="multi-filter">
                        <div class="form-group">
                            <label for="edit-filter3-1">Wert 1:</label>
                            <input type="text" id="edit-filter3-1" name="filter3">
                        </div>
                        <div class="form-group">
                            <label for="edit-filter3-2">Wert 2:</label>
                            <input type="text" id="edit-filter3-2" name="filter3">
                        </div>
                        <div class="form-group">
                            <label for="edit-filter3-3">Wert 3:</label>
                            <input type="text" id="edit-filter3-3" name="filter3">
                        </div>
                        <div class="form-group">
                            <label for="edit-filter3-4">Wert 4:</label>
                            <input type="text" id="edit-filter3-4" name="filter3">
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-anschaffungsjahr">Anschaffungsjahr:</label>
                        <input type="date" id="edit-anschaffungsjahr" name="anschaffungsjahr">
                    </div>
                    <div class="form-group">
                        <label for="edit-anschaffungskosten">Anschaffungskosten:</label>
                        <input id="edit-anschaffungskosten" name="anschaffungskosten">
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-code4">Code:</label>
                    <input id="edit-code4" name="code_4">
                </div>
                
                <!-- New section for managing images -->
                <div class="form-group">
                    <label>Vorhandene Bilder:</label>
                    <div id="edit-existing-images" class="existing-images-container">
                        <!-- Existing images will be added here dynamically -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-new-images">
                        <span>Neue Bilder hinzufügen:</span>
                        <span>(Bilder werden vom Original übernommen)</span>
                    </label>
                    <input type="file" id="edit-new-images" name="new_images" accept="image/*" multiple>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="save-button">Speichern</button>
                    <button type="button" class="cancel-button" onclick="closeEditModal()">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Initialize template variables before any JavaScript code -->
<script>
    // Create a global object to hold server-side template values
    window.serverVars = {
        highlightItemId: {% if highlight_item is defined and highlight_item %}"{{ highlight_item }}"{% else %}null{% endif %}
    };
</script>

<script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
<script>
    // Initialize QR Code scanner and global variables
    let html5QrcodeScanner = null;
    let codeSearchTerm = '';
    let currentUsername = '';
    
    // Get the highlight item ID from the pre-processed server variables
    let highlightItemId = window.serverVars.highlightItemId;
    
    // Simplified no-op version of debug function for production
    function debugLog() {
        // No-op in production
        return;
    }
    
    document.getElementById('scanButton').addEventListener('click', function() {
        const qrReader = document.getElementById('qr-reader');
        
        if (qrReader.style.display === 'none') {
            qrReader.style.display = 'block';
            
            html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader", { fps: 10, qrbox: 250 }
            );
            
            html5QrcodeScanner.render((decodedText) => {
                html5QrcodeScanner.clear();
                qrReader.style.display = 'none';
                
                // Navigate to the item
                window.location.href = decodedText;
            });
            
            this.textContent = 'Scanner schließen';
        } else {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
            }
            qrReader.style.display = 'none';
            this.textContent = 'QR-Code scannen';
        }
    });

    function saveFilterState() {
        localStorage.setItem('inventarSystemFilters', JSON.stringify(activeFilters));
    }
    
    function loadFilterState() {
        const savedFilters = localStorage.getItem('inventarSystemFilters');
        if (savedFilters) {
            try {
                // Parse saved filters
                const parsedFilters = JSON.parse(savedFilters);
                
                // Restore to active filters
                if (parsedFilters.filter1) activeFilters.filter1 = parsedFilters.filter1;
                if (parsedFilters.filter2) activeFilters.filter2 = parsedFilters.filter2;
                if (parsedFilters.filter3) activeFilters.filter3 = parsedFilters.filter3;
            } catch (e) {
                console.error("Error loading saved filters:", e);
            }
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Load saved filters
        loadFilterState();
        
        // Fetch user status to get current username
        fetch('/user_status')
            .then(response => response.json())
            .then(data => {
                currentUsername = data.username;
                // Now load items with username information
                loadItems();
            })
            .catch(error => {
                console.error('Error fetching user status:', error);
                loadItems(); // Load items anyway in case of error
            });

        // Add event listener for code search input
        const codeSearchInput = document.getElementById('code-search');
        if (codeSearchInput) {
            codeSearchInput.addEventListener('input', function() {
                // Use a small delay to avoid excessive filtering while typing
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    searchByCode();
                }, 300);
            });
        }
    });

    // Global variables to store active filters
    let activeFilters = {
        filter1: [],
        filter2: [],
        filter3: []
    };

    function loadItems() {
        fetch("{{ url_for('get_items') }}")
            .then(response => response.json())
            .then(data => {
                const itemsContainer = document.querySelector('#items-container');
                // Creating a Set to store unique filter values
                const filter1Values = new Set();
                const filter2Values = new Set();
                const filter3Values = new Set();
                
                // Clear the container first
                itemsContainer.innerHTML = '';
                
                if (!data.items || data.items.length === 0) {
                    itemsContainer.innerHTML = '<div class="no-items-message">Keine Objekte gefunden</div>';
                    return;
                }
                
                data.items.forEach(item => {
                    try {
                        const card = document.createElement('div');
                        card.classList.add('item-card');
                        
                        // Add class to make card clickable 
                        card.classList.add('clickable-card');
                        
                        // Add highlight class if this is the item we're looking for
                        if (highlightItemId && item._id === highlightItemId) {
                            card.classList.add('highlight-item');
                            setTimeout(() => {
                                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 500);
                        }
                        
                        // Process and store filter values with consistent handling
                        const filter1Array = Array.isArray(item.Filter) ? item.Filter : (item.Filter ? [item.Filter] : []);
                        const filter2Array = Array.isArray(item.Filter2) ? item.Filter2 : (item.Filter2 ? [item.Filter2] : []);
                        const filter3Array = Array.isArray(item.Filter3) ? item.Filter3 : (item.Filter3 ? [item.Filter3] : []);
                        
                        // Store arrays on the card as data attributes
                        card.dataset.filter1 = JSON.stringify(filter1Array);
                        card.dataset.filter2 = JSON.stringify(filter2Array);
                        card.dataset.filter3 = JSON.stringify(filter3Array);
                        card.dataset.code = (item.Code_4 !== undefined && item.Code_4 !== null) ? 
                                            String(item.Code_4).trim() : '';
                        
                        // Add filter values to their respective sets - all values should be strings
                        filter1Array.forEach(value => {
                            if (value && typeof value === 'string' && value.trim() !== '') {
                                filter1Values.add(value);
                            }
                        });
                        
                        filter2Array.forEach(value => {
                            if (value && typeof value === 'string' && value.trim() !== '') {
                                filter2Values.add(value);
                            }
                        });
                        
                        filter3Array.forEach(value => {
                            if (value && typeof value === 'string' && value.trim() !== '') {
                                filter3Values.add(value);
                            }
                        });

                        // Display first filter value or dash if none exist
                        const filter1Display = filter1Array.length > 0 ? filter1Array[0] : '-';
                        const filter2Display = filter2Array.length > 0 ? filter2Array[0] : '-';
                        const filter3Display = filter3Array.length > 0 ? filter3Array[0] : '-';
                        
                        // Additional filter values indicator
                        const filter1More = filter1Array.length > 1 ? ` (+${filter1Array.length - 1} mehr)` : '';
                        const filter2More = filter2Array.length > 1 ? ` (+${filter2Array.length - 1} mehr)` : '';
                        const filter3More = filter3Array.length > 1 ? ` (+${filter3Array.length - 1} mehr)` : '';

                        const imagesHtml = item.Images.map((image, index) => `<img src="{{ url_for('uploaded_file', filename='') }}${image}" alt="${item.Name}" class="item-image" data-index="${index}" style="display: ${index === 0 ? 'block' : 'none'};">`).join('');
                        
                        // Check if item is borrowed by current user
                        const isBorrowedByMe = !item.Verfuegbar && item.User === currentUsername;
                        
                        // Add borrower info badge if item is borrowed
                        let borrowerBadge = '';
                        if (!item.Verfuegbar && item.BorrowerInfo) {
                            borrowerBadge = `
                                <div class="borrower-badge">
                                    Ausgeliehen von: <strong>${item.BorrowerInfo.username}</strong>
                                    ${item.BorrowerInfo.borrowTime ? '<br><span class="borrow-time">Seit: ' + item.BorrowerInfo.borrowTime + '</span>' : ''}
                                </div>`;
                        }

                        card.innerHTML = `
                            <div class="card-content" data-item-id="${item._id}">
                                <h3>${item.Name}</h3>
                                <p><strong>Ort:</strong> ${item.Ort || '-'}</p>
                                <p><strong>Unterrichtsfach:</strong> ${filter1Display}${filter1More}</p>
                                <p><strong>Jahrgangsstufe:</strong> ${filter2Display}${filter2More}</p>
                                <p><strong>Thema:</strong> ${filter3Display}${filter3More}</p>
                                <div class="image-container">
                                    ${imagesHtml}
                                    <button class="prev-image-button" onclick="prevImage(event)">&#10094;</button>
                                    <button class="next-image-button" onclick="nextImage(event)">&#10095;</button>
                                </div>
                                ${borrowerBadge}
                            </div>
                            <div class="actions">
                                ${item.Verfuegbar ? 
                                    `<form method="POST" action="{{ url_for('ausleihen', id='') }}${item._id}">
                                        <button class="ausleihen" type="submit">Ausleihen</button>
                                    </form>` 
                                : isBorrowedByMe ?
                                    `<form method="POST" action="{{ url_for('zurueckgeben', id='') }}${item._id}">
                                        <button class="ausleihen" type="submit">Zurückgeben</button>
                                    </form>`
                                :
                                    `<button class="ausleihen disabled-button" disabled>Ausgeliehen</button>`
                                }
                                <a href="#" class="edit-button" onclick="editItem('${item._id}', event)">Bearbeiten</a>
                                <a href="#" class="duplicate-button" onclick="duplicateItem('${item._id}', event)">Duplizieren</a>
                                <a href="#" class="delete-button" onclick="confirmDelete('${item._id}', '${item.Name}', event)">Delete</a>
                            </div>
                        `;
                        itemsContainer.appendChild(card);

                        // Add QR code download link to each card
                        const qrLink = document.createElement('a');
                        qrLink.href = `{{ url_for('get_qr_code', id='') }}${item._id}`;
                        qrLink.className = 'qr-download-button';
                        qrLink.textContent = 'QR-Code';
                        
                        // Add the QR code link to the actions div
                        const actionsDiv = card.querySelector('.actions');
                        actionsDiv.appendChild(qrLink);
                        
                        // Add direct click event listeners to the card content area
                        const cardContent = card.querySelector('.card-content');
                        if (cardContent) {
                            cardContent.addEventListener('click', function(e) {
                                // Don't trigger if clicking on buttons or form elements
                                if (e.target.tagName === 'BUTTON' || 
                                    e.target.tagName === 'A' || 
                                    e.target.tagName === 'INPUT' ||
                                    e.target.closest('button') || 
                                    e.target.closest('a') || 
                                    e.target.closest('.image-container')) {
                                    return;
                                }
                                
                                // Stop event from bubbling up
                                e.stopPropagation();
                                
                                
                                // Get full item data with correct image paths
                                const modalItemData = {...item};
                                modalItemData.Images = item.Images.map(img => "{{ url_for('uploaded_file', filename='') }}" + img);
                                
                                openItemModal(modalItemData);
                            });
                        }
                    } catch (err) {
                        console.error('Error processing item:', err, item);
                    }
                });
                
                // Populate filter options
                populateFilterOptions('filter1-options', [...filter1Values].sort(), 1);
                populateFilterOptions('filter2-options', [...filter2Values].sort(), 2);
                populateFilterOptions('filter3-options', [...filter3Values].sort(), 3);
                
                // Center the first card
                const cardWidth = itemsContainer.querySelector('.item-card')?.offsetWidth || 0;
                if (cardWidth > 0) {
                    itemsContainer.scrollLeft = (itemsContainer.scrollWidth - cardWidth) / 2;
                }
                
                // Apply filters
                applyFilters();
            })
            .catch(error => {
                console.error('Error fetching items:', error);
                const itemsContainer = document.querySelector('#items-container');
                itemsContainer.innerHTML = 
                    '<div class="error-message">Fehler beim Laden der Objekte. Bitte versuchen Sie es später erneut.</div>';
            });
    }

    function searchByCode() {
        const searchInput = document.getElementById('code-search');
        const rawSearchTerm = searchInput.value;
        codeSearchTerm = rawSearchTerm.trim().toLowerCase();
        
        // Add visual feedback when searching
        searchInput.classList.add('searching');
        
        // Reset highlighting before applying filters
        const itemsContainer = document.querySelector('#items-container');
        const allCards = itemsContainer.querySelectorAll('.item-card');
        allCards.forEach(card => {
            card.classList.remove('highlight-item', 'code-match', 'exact-code-match');
        });
        
        // Apply filters which will handle highlighting
        applyFilters(true); // Pass true to indicate this is a direct search
        
        // Remove visual feedback after a delay
        setTimeout(() => {
            searchInput.classList.remove('searching');
        }, 500);
    }

    function applyFilters(isDirectSearch = false) {
        const itemsContainer = document.querySelector('#items-container');
        const items = itemsContainer.querySelectorAll('.item-card');
        
        let visibleCount = 0;
        let codeMatchCount = 0;
        let exactMatchCount = 0;
        let firstMatchedCard = null;
        let exactMatchCard = null;
        
        // Process search term
        const searchTerm = codeSearchTerm ? codeSearchTerm.trim().toLowerCase() : '';
        const isCodeSearch = searchTerm.length > 0;
        
        items.forEach(item => {
            const itemFilter1 = item.dataset.filter1;
            const itemFilter2 = item.dataset.filter2;
            const itemFilter3 = item.dataset.filter3;
            const rawCode = item.dataset.code || '';
            const itemCode = rawCode.trim().toLowerCase();
            
            // Check if item matches all active filters
            const matchesFilter1 = checkFilterMatch(activeFilters.filter1, itemFilter1);
            const matchesFilter2 = checkFilterMatch(activeFilters.filter2, itemFilter2);
            const matchesFilter3 = checkFilterMatch(activeFilters.filter3, itemFilter3);
            const passesAllFilters = matchesFilter1 && matchesFilter2 && matchesFilter3;
            
            // Check for code match (special logic for exact matches)
            let matchesCodeSearch = !isCodeSearch || itemCode.includes(searchTerm);
            let exactCodeMatch = isCodeSearch && itemCode === searchTerm;
            
            if (passesAllFilters && matchesCodeSearch) {
                // Show item if it matches all filters and code search
                item.style.display = 'block';
                visibleCount++;
                
                // Add appropriate highlight classes for code matches
                if (exactCodeMatch) {
                    item.classList.add('highlight-item', 'exact-code-match');
                    exactMatchCount++;
                    if (!exactMatchCard) {
                        exactMatchCard = item;
                    }
                } else if (isCodeSearch && itemCode.includes(searchTerm)) {
                    item.classList.add('code-match');
                    codeMatchCount++;
                    if (!firstMatchedCard) {
                        firstMatchedCard = item;
                    }
                }
            } else {
                // Hide non-matching items
                item.style.display = 'none';
            }
        });
        
        // Handle scrolling and highlighting for code searches
        if (isCodeSearch && visibleCount > 0 && (codeMatchCount > 0 || exactMatchCount > 0)) {
            setTimeout(() => {
                // Prefer exact match, fallback to partial match
                const cardToHighlight = exactMatchCard || firstMatchedCard;
                
                if (cardToHighlight) {
                    // Fixed scrolling logic to center the card properly
                    centerCardInView(cardToHighlight, itemsContainer);
                    
                    // Add stronger attention-grabbing animation
                    applyAttentionAnimation(cardToHighlight);
                }
            }, 300);
        } else if (isDirectSearch && isCodeSearch && visibleCount === 0) {
            debugLog(`No matches found for search term "${searchTerm}"`, {
                allCodes: Array.from(items).map(item => item.dataset.code?.trim() || 'empty')
            });
        }
    }

    // Helper function to center a card in the container view
    function centerCardInView(card, container) {
        // Make sure the card is visible first
        card.style.display = 'block';
        
        // Get positions and dimensions
        const containerRect = container.getBoundingClientRect();
        const cardRect = card.getBoundingClientRect();
        
        // Calculate scroll position to center the card
        const scrollPosition = card.offsetLeft - (containerRect.width/2) + (cardRect.width/2);
        
        // Debug the centering calculation
        if (isDebug) {
            debugLog('Card positioning details:', {
                cardName: card.querySelector('h3')?.textContent,
                containerWidth: containerRect.width,
                cardWidth: cardRect.width,
                cardLeft: card.offsetLeft,
                calculatedScrollPosition: scrollPosition
            });
        }
        
        // Smooth scroll to position
        container.scrollTo({
            left: scrollPosition,
            behavior: 'smooth'
        });
    }

    // Helper function to apply attention animation to a card
    function applyAttentionAnimation(card) {
        // First remove any existing animations
        card.getAnimations().forEach(anim => anim.cancel());
        
        // Apply a more pronounced animation
        card.animate([
            { transform: 'scale(1)', boxShadow: '0 0 15px rgba(40, 167, 69, 0.7)' },
            { transform: 'scale(1.08)', boxShadow: '0 0 25px rgba(40, 167, 69, 1)' },
            { transform: 'scale(1)', boxShadow: '0 0 15px rgba(40, 167, 69, 0.7)' }
        ], {
            duration: 800,
            iterations: 3,
            easing: 'ease-in-out'
        });
        
        // Also flash the background for better visibility
        card.animate([
            { backgroundColor: 'white' },
            { backgroundColor: 'rgba(40, 167, 69, 0.1)' },
            { backgroundColor: 'white' }
        ], {
            duration: 800,
            iterations: 3,
            easing: 'ease-in-out'
        });
    }

    // Debug utility to show dataset values
    function debugCardData(card) {
        if (!isDebug) return;
        
        const itemName = card.querySelector('h3')?.textContent || 'unknown';
        debugLog(`Card data for "${itemName}":`, {
            code: card.dataset.code,
            filter1: card.dataset.filter1,
            filter2: card.dataset.filter2,
            filter3: card.dataset.filter3,
            isVisible: card.style.display !== 'none'
        });
    }

    // Add missing scroll functions
    function scrollPrev() {
        const container = document.querySelector('#items-container');
        const cardWidth = container.querySelector('.item-card')?.offsetWidth || 300;
        const gap = 20; // Match the gap in CSS
        
        // Scroll one card width to the left + gap
        container.scrollBy({
            left: -1 * (cardWidth + gap),
            behavior: 'smooth'
        });
    }

    function scrollNext() {
        const container = document.querySelector('#items-container');
        const cardWidth = container.querySelector('.item-card')?.offsetWidth || 300;
        const gap = 20; // Match the gap in CSS
        
        // Scroll one card width to the right + gap
        container.scrollBy({
            left: cardWidth + gap,
            behavior: 'smooth'
        });
    }

    // Add functions for image navigation in item cards
    function prevImage(event) {
        event.stopPropagation(); // Prevent card click event
        const container = event.target.closest('.image-container');
        const images = container.querySelectorAll('.item-image');
        let currentIndex = Array.from(images).findIndex(img => img.style.display === 'block');
        
        images[currentIndex].style.display = 'none';
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        images[currentIndex].style.display = 'block';
    }

    function nextImage(event) {
        event.stopPropagation(); // Prevent card click event
        const container = event.target.closest('.image-container');
        const images = container.querySelectorAll('.item-image');
        let currentIndex = Array.from(images).findIndex(img => img.style.display === 'block');
        
        images[currentIndex].style.display = 'none';
        currentIndex = (currentIndex + 1) % images.length;
        images[currentIndex].style.display = 'block';
    }

    function confirmDelete(itemId, itemName, event) {
        event.preventDefault();
        
        const confirmMessage = itemName 
            ? `Sind Sie sicher, dass Sie "${itemName}" löschen möchten?` 
            : "Sind Sie sicher, dass Sie diesen Artikel löschen möchten?";
        
        if (confirm(confirmMessage)) {
            window.location.href = `{{ url_for('delete_item', id='') }}${itemId}`;
        }
    }

    function duplicateItem(itemId, event) {
        event.preventDefault();
        event.stopPropagation();

        document.getElementById('item-modal').style.display = 'none';

        fetch(`/get_item/${itemId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load item data');
                }
                return response.json();
            })
            .then(data => {
                showEditItemForm(data.item, true);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Fehler beim Laden der Objektdaten');
            });
    }

    // Add the missing populateFilterOptions function
    function populateFilterOptions(containerId, filterValues, filterNum) {
        const container = document.getElementById(containerId);
        if (!container) {
            debugLog(`Container not found: ${containerId}`);
            return;
        }
        
        container.innerHTML = ''; // Clear previous options
        
        // First group values by category/prefix if they exist
        const groupedValues = {};
        
        // Process filter values to identify groups
        filterValues.forEach(value => {
            if (!value) return; // Skip empty values
            
            let group = 'Default';
            let displayValue = value;
            
            // Check if value contains grouping delimiter
            if (typeof value === 'string' && value.includes(':')) {
                [group, displayValue] = value.split(':', 2);
            }
            
            // Initialize group array if needed
            if (!groupedValues[group]) {
                groupedValues[group] = [];
            }
            
            // Add value to group
            groupedValues[group].push(displayValue);
        });
        
        // Now create DOM elements for each group
        Object.keys(groupedValues).sort().forEach(group => {
            // Skip empty groups
            if (!groupedValues[group].length) return;
            
            // Create option group
            const groupDiv = document.createElement('div');
            groupDiv.className = 'filter-option-group';
            
            // Add group header if not default
            if (group !== 'Default') {
                const header = document.createElement('div');
                header.className = 'filter-group-header';
                header.textContent = group;
                groupDiv.appendChild(header);
            }
            
            // Add each filter option in this group
            groupedValues[group].sort().forEach(value => {
                // Create filter option
                const optionDiv = document.createElement('div');
                optionDiv.className = 'filter-option';
                
                // Create unique ID for checkbox
                const safeValue = value.replace(/[^a-zA-Z0-9]/g, '_');
                const safeGroup = group.replace(/[^a-zA-Z0-9]/g, '_');
                const id = `filter${filterNum}-${safeGroup}-${safeValue}`;
                
                // Create checkbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = id;
                checkbox.value = value;
                
                // Store group info for filtering
                if (group !== 'Default') {
                    checkbox.dataset.group = group;
                }
                
                // Check if this value is already active
                const filterValue = group !== 'Default' ? `${group}:${value}` : value;
                checkbox.checked = activeFilters[`filter${filterNum}`].includes(filterValue);
                
                // Add change handler
                checkbox.onchange = () => {
                    updateFilter(filterNum, value, checkbox.checked, 
                        group !== 'Default' ? group : '');
                };
                
                // Create label
                const label = document.createElement('label');
                label.htmlFor = id;
                label.textContent = value;
                
                // Add to DOM
                optionDiv.appendChild(checkbox);
                optionDiv.appendChild(label);
                groupDiv.appendChild(optionDiv);
            });
            
            // Add group to container
            container.appendChild(groupDiv);
        });
        
        debugLog(`Populated ${filterValues.length} options for filter ${filterNum}`);
    }

    // Add the missing checkFilterMatch function
    function checkFilterMatch(activeFilterValues, itemFilterValuesJSON) {
        // If no active filters, all items match
        if (!activeFilterValues || activeFilterValues.length === 0) {
            return true;
        }
        
        try {
            // Parse item filter values
            const itemFilterValues = JSON.parse(itemFilterValuesJSON || '[]');
            
            // If item has no values, it can't match any filters
            if (!itemFilterValues || itemFilterValues.length === 0) {
                return false;
            }
            
            // Check if ANY active filter values match ANY item filter values
            for (const activeFilter of activeFilterValues) {
                // Extract value from activeFilter (remove group prefix if exists)
                const activeValue = activeFilter.includes(':') 
                    ? activeFilter.split(':')[1] 
                    : activeFilter;
                
                // Check if any item filter value matches this active filter
                if (itemFilterValues.includes(activeValue)) {
                    return true;
                }
            }
            
            // No match found
            return false;
        } catch (err) {
            console.error("Error in checkFilterMatch:", err);
            debugLog("Error in checkFilterMatch:", {
                error: err.message,
                activeFilters: activeFilterValues,
                itemFilters: itemFilterValuesJSON
            });
            return false;
        }
    }

    // Also add missing clearCodeSearch function
    function clearCodeSearch() {
        const searchInput = document.getElementById('code-search');
        searchInput.value = '';
        codeSearchTerm = '';
        
        // Reset highlighting
        const itemsContainer = document.querySelector('#items-container');
        const allCards = itemsContainer.querySelectorAll('.item-card');
        allCards.forEach(card => {
            card.classList.remove('highlight-item', 'code-match', 'exact-code-match');
        });
        
        // Apply filters to show all matching items
        applyFilters();
    }
</script>

<style>
body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    margin: 0;
    padding: 0;
}

.container {
    background-color: #fff;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    width: 80%;
    max-width: 1200px;
    margin: 20px auto;
}

h1, h2 {
    text-align: center;
}

.filter-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    margin-bottom: 20px;
}

.filter-group {
    position: relative;
    min-width: 200px;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
}

.filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.filter-toggle, .clear-filter {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 3px;
    padding: 3px 8px;
    cursor: pointer;
}

.clear-filter {
    font-size: 0.8rem;
    color: #6c757d;
}

.filter-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    max-height: 300px; /* Increased height */
    overflow-y: auto;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 100;
    padding: 8px;
}

.filter-options {
    padding: 10px;
}

.filter-option {
    margin-bottom: 5px;
    display: flex;
    align-items: center;
}

.filter-option input[type="checkbox"] {
    width: 16px;
    height: 16px;
    margin-right: 8px;
    cursor: pointer;
}

.filter-option:hover {
    background-color: #f5f5f5;
}

.filter-option label {
    margin-left: 5px;
    cursor: pointer;
}

.filter-option-group {
    margin-bottom: 12px;
    border-bottom: 1px solid #eee;
    padding-bottom: 8px;
}

.filter-group-header {
    font-weight: bold;
    margin-bottom: 5px;
    color: #495057;
    font-size: 0.9rem;
}

.selected-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    min-height: 30px;
}

.filter-tag {
    display: inline-flex;
    align-items: center;
    background-color: #e9ecef;
    border-radius: 15px;
    padding: 3px 10px;
    font-size: 0.8rem;
}

.filter-tag-group {
    color: #6c757d;
    font-size: 0.8em;
    font-style: italic;
    margin-right: 2px;
}

.filter-tag-remove {
    background: none;
    border: none;
    color: #6c757d;
    margin-left: 5px;
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
}

.items-container {
    display: flex;
    overflow-x: auto; /* Change from hidden to auto */
    gap: 20px;
    padding: 20px 0;
    scroll-snap-type: x mandatory;
    position: relative; /* Added for better scroll positioning */
    scroll-behavior: smooth; /* Added for smoother scrolling */
}

.item-card {
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    padding: 20px;
    max-width: 300px;
    flex-shrink: 0;
    scroll-snap-align: center;
    cursor: pointer;
    transition: transform 0.2s;
}

.item-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.item-card h3 {
    margin-top: 0;
}

.item-card .description {
    max-height: 100px;
    overflow-y: auto;
}

.item-card .image-container {
    position: relative;
    max-width: 300px;
    margin: 10px 0;
}

.item-card .item-image {
    width: 100%;
    height: auto;
    max-height: 300px; /* Set a maximum height for the images */
    display: none;
    object-fit: cover;
}

.item-card .item-image:first-child {
    display: block;
}

.prev-image-button, .next-image-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background-color: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    cursor: pointer;
    padding: 5px;
    border-radius: 5px;
}

.prev-image-button {
    left: -30px;
}

.next-image-button {
    right: -30px;
}

.actions {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 10px;
}

.actions form, 
.actions a {
    flex: 1 1 calc(33% - 5px);
    min-width: fit-content;
}

.actions form button,
.actions a {
    width: 100%;
    font-size: 0.85rem;
    padding: 8px 5px;
    text-align: center;
}

button.ausleihen {
    flex: 1;
    padding: 10px;
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

button.ausleihen:hover {
    background-color: #0056b3;
}

a.delete-button {
    flex: 1;
    padding: 10px;
    background-color: #dc3545;
    color: #fff;
    text-align: center;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    text-decoration: none;
}

a.delete-button:hover {
    background-color: #c82333;
}

.upload-form {
    margin-top: 20px;
}

.form-group {
    margin-bottom: 15px;
}

label {
    display: block;
    margin-bottom: 5px;
}

input[type="text"],
textarea,
input[type="file"] {
    width: 100%;
    padding: 8px;
    box-sizing: border-box;
}

.flash {
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 5px;
}

.flash.success {
    background-color: #d4edda;
    color: #155724;
}

.flash.error {
    background-color: #f8d7da;
    color: #721c24;
}

.navigation-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
}

.navigation-buttons .prev-button,
 .navigation-buttons .next-button {
    background-color: #007bff;
    color: #fff;
    border: none;
    cursor: pointer;
    padding: 10px;
    border-radius: 5px;
}

.navigation-buttons .prev-button:hover,
.navigation-buttons .next-button:hover {
    background-color: #0056b3;
}

.qr-scanner {
    margin-top: 20px;
    text-align: center;
}

@media (max-width: 768px) {
    .form-row {
        flex-direction: column;
        gap: 10px;
    }
    
    .modal-content {
        width: 95%;
        padding: 15px;
    }
}

@media (max-width: 480px) {
    .container {
        width: 98%;
        padding: 10px;
    }
    .item-card {
        min-width: 200px;
    }
}

.qr-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 20px;
}

.scan-button {
    padding: 10px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-bottom: 10px;
}

.scan-button:hover {
    background-color: #0056b3;
}

#qr-reader {
    margin: 0 auto;
    max-width: 100%;
}

.qr-download-button {
    display: inline-block;
    margin-left: 5px;
    padding: 5px 10px;
    background-color: #28a745;
    color: white;
    text-decoration: none;
    border-radius: 3px;
    font-size: 0.8em;
}

.qr-notification {
    background-color: #d4edda;
    color: #155724;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 5px;
    text-align: center;
    transition: opacity 1s ease;
}

.qr-download {
    display: inline-block;
    padding: 5px 15px;
    background-color: #28a745;
    color: white;
    text-decoration: none;
    border-radius: 3px;
    margin-left: 10px;
}

.highlight-item {
    border: 3px solid gold !important;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.7) !important;
    position: relative;
    z-index: 10;
    animation: highlight-pulse 2s infinite;
}

.code-match {
    border: 2px solid #17a2b8 !important;
    box-shadow: 0 0 15px rgba(23, 162, 184, 0.5) !important;
    position: relative;
    z-index: 5;
}

.exact-code-match {
    border: 3px solid #28a745 !important;
    box-shadow: 0 0 20px rgba(40, 167, 69, 0.7) !important;
    animation: highlight-pulse 2s infinite;
    position: relative;
    z-index: 11; /* Higher than regular highlight */
}

@keyframes highlight-pulse {
    0% { box-shadow: 0 0 15px rgba(40, 167, 69, 0.7); }
    50% { box-shadow: 0 0 30px rgba(40, 167, 69, 1); transform: scale(1.03); }
    100% { box-shadow: 0 0 15px rgba(40, 167, 69, 0.7); }
}

.disabled-button {
    background-color: #6c757d;
    cursor: not-allowed;
    opacity: 0.65;
}

.borrow-limit-banner {
    background-color: #ffc107;
    color: #212529;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 5px;
    text-align: center;
}

.item-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    overflow-y: auto;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
}

.modal-content {
    position: relative;
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border-radius: 8px;
    width: 80%;
    max-width: 900px;
    animation: slideIn 0.3s ease;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    overflow: hidden;
}

@keyframes slideIn {
    from {transform: translateY(-20px); opacity: 0;}
    to {transform: translateY(0); opacity: 1;}
}

.close-modal {
    position: absolute;
    top: 15px;
    right: 20px;
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    z-index: 10;
}

.close-modal:hover {
    color: #000;
}

.modal-image-container {
    text-align: center;
    margin: 20px 0;
    position: relative;
    max-height: 500px;
    overflow: hidden;
}

.modal-image {
    max-width: 100%;
    max-height: 450px;
    border-radius: 5px;
    object-fit: contain;
}

.modal-image-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    padding: 15px;
    background-color: rgba(0,0,0,0.5);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 18px;
    opacity: 0.8;
    transition: opacity 0.3s;
}

.modal-image-nav:hover {
    opacity: 1;
    background-color: rgba(0,0,0,0.7);
}

.modal-prev-image {
    left: 15px;
}

.modal-next-image {
    right: 15px;
}

.modal-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.detail-group {
    margin-bottom: 15px;
}

.detail-label {
    font-weight: bold;
    margin-bottom: 5px;
}

.detail-value {
    padding: 5px 0;
}

.modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    justify-content: flex-end;
}

.modal-actions .ausleihen,
.modal-actions .delete-button,
.modal-actions .qr-download-button {
    padding: 10px 20px;
}

.full-width {
    grid-column: 1 / -1;
}

.borrower-badge {
    background-color: #fff3cd;
    color: #856404;
    border-left: 4px solid #ffc107;
    padding: 8px;
    margin: 10px 0;
    font-size: 0.85em;
    border-radius: 4px;
}

.borrow-time {
    font-size: 0.9em;
    color: #6c757d;
    font-style: italic;
    display: block;
    margin-top: 3px;
}

.borrower-info-panel {
    margin: 15px 0;
    padding: 15px;
    background-color: #fff3cd;
    border-left: 4px solid #ffc107;
    border-radius: 4px;
}

.borrower-info-panel h4 {
    color: #856404;
    margin-top: 0;
    margin-bottom: 10px;
    font-size: 1.1em;
}

.borrower-name {
    font-weight: bold;
    margin-bottom: 5px;
}

.status-borrowed {
    color: #dc3545;
    font-weight: bold;
}

#borrowing-details-modal .modal-content {
    max-width: 600px;
}

.borrowing-details {
    padding: 20px 0;
    line-height: 1.6;
}

.borrowing-details p {
    margin: 10px 0;
}

.borrowing-details-btn {
    padding: 10px 20px;
    background-color: #17a2b8;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9em;
}

.borrowing-details-btn:hover {
    background-color: #138496;
}

.edit-button {
    flex: 1;
    padding: 10px;
    background-color: #ffc107;
    color: #212529;
    text-align: center;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    text-decoration: none;
}

.edit-button:hover {
    background-color: #e0a800;
}

.form-row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}

.form-row .form-group {
    flex: 1;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

.save-button {
    padding: 10px 20px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.save-button:hover {
    background-color: #218838;
}

.cancel-button {
    padding: 10px 20px;
    background-color: #6c757d;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.cancel-button:hover {
    background-color: #5a6268;
}

@media (max-width: 768px) {
    .form-row {
        flex-direction: column;
        gap: 10px;
    }
    
    .modal-content {
        width: 95%;
        padding: 15px;
    }
}

.existing-images-container {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 10px;
    margin-bottom: 15px;
}

.existing-image-item {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 10px;
    text-align: center;
    width: 150px;
}

.edit-thumbnail {
    width: 120px;
    height: 120px;
    object-fit: cover;
    margin-bottom: 8px;
    border-radius: 4px;
}

.image-keep-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.image-keep-controls label {
    font-size: 0.9em;
}

.multi-filter {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 15px;
}

.filter-inputs h3 {
    margin-top: 20px;
    margin-bottom: 10px;
    font-size: 16px;
    color: #495057;
}

.clickable-card {
    cursor: pointer;
    position: relative;
    transition: transform 0.2s, box-shadow 0.2s;
}

.clickable-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 20px rgba(0, 123, 255, 0.3);
}

.card-content {
    cursor: pointer;
    z-index: 1;
    position: relative;
}

.duplicate-button {
    flex: 1;
    padding: 10px;
    background-color: #17a2b8;
    color: white;
    text-align: center;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    text-decoration: none;
}

.duplicate-button:hover {
    background-color: #138496;
}

.search-container {
    display: flex;
    gap: 5px;
    margin-top: 5px;
}

#code-search {
    flex: 1;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.search-button {
    padding: 8px 12px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.search-button:hover {
    background-color: #0056b3;
}

.search-field {
    min-width: 250px;
}

/* Retain search feedback styles */
#code-search.searching {
    background-color: #fff3cd;
    transition: background-color 0.3s;
    border: 2px solid #ffc107;
    box-shadow: 0 0 8px rgba(255, 193, 7, 0.5);
}

/* Add styles for error and empty state messages */
.error-message, .no-items-message {
    padding: 20px;
    text-align: center;
    width: 100%;
    color: #721c24;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 5px;
    margin: 20px 0;
}

.no-items-message {
    color: #383d41;
    background-color: #e2e3e5;
    border-color: #d6d8db;
}
</style>
{% endblock %}