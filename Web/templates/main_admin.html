<!--
   Copyright 2025 Maximilian Gründinger

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
{% extends "base.html" %}

{% block title %}Inventarsystem{% endblock %}

{% block content %}
<style>
    /* Main container and layout styles */
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
    }

    .container {
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        width: 80%;
        max-width: 1200px;
        margin: 20px auto;
    }

    h1, h2 {
        text-align: center;
    }

    /* Filter styles */
    .filter-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        margin-bottom: 20px;
    }

    .filter-group {
        position: relative;
        min-width: 200px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
    }

    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .filter-toggle, .clear-filter {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 3px;
        padding: 3px 8px;
        cursor: pointer;
    }

    .clear-filter {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .filter-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        z-index: 100;
        padding: 8px;
    }

    .filter-options {
        padding: 10px;
    }

    .filter-option {
        margin-bottom: 5px;
        display: flex;
        align-items: center;
    }

    .filter-option input[type="checkbox"] {
        width: 16px;
        height: 16px;
        margin-right: 8px;
        cursor: pointer;
    }

    .filter-option:hover {
        background-color: #f5f5f5;
    }

    .filter-option label {
        margin-left: 5px;
        cursor: pointer;
    }

    .filter-option-group {
        margin-bottom: 12px;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
    }

    .filter-group-header {
        font-weight: bold;
        margin-bottom: 5px;
        color: #495057;
        font-size: 0.9rem;
    }

    .selected-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        min-height: 30px;
    }

    .filter-tag {
        display: inline-flex;
        align-items: center;
        background-color: #e9ecef;
        border-radius: 15px;
        padding: 3px 10px;
        font-size: 0.8rem;
    }

    .filter-tag-group {
        color: #6c757d;
        font-size: 0.8em;
        font-style: italic;
        margin-right: 2px;
    }

    .filter-tag-remove {
        background: none;
        border: none;
        color: #6c757d;
        margin-left: 5px;
        cursor: pointer;
        font-size: 1rem;
        line-height: 1;
    }

    /* Search styles */
    .search-container {
        display: flex;
        gap: 5px;
        margin-top: 5px;
    }

    #code-search {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .search-button {
        padding: 8px 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .search-button:hover {
        background-color: #0056b3;
    }

    .search-field {
        min-width: 250px;
    }

    #code-search.searching {
        background-color: #fff3cd;
        transition: background-color 0.3s;
        border: 2px solid #ffc107;
        box-shadow: 0 0 8px rgba(255, 193, 7, 0.5);
    }

    /* QR Scanner styles */
    .qr-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 20px;
    }

    .scan-button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-bottom: 10px;
    }

    .scan-button:hover {
        background-color: #0056b3;
    }

    /* Item display styles */
    .items-container {
        display: flex;
        overflow-x: auto;
        gap: 20px;
        padding: 20px 0;
        scroll-snap-type: x mandatory;
        position: relative;
        scroll-behavior: smooth;
    }

    .item-card {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        max-width: 300px;
        flex-shrink: 0;
        scroll-snap-align: center;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .item-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .item-card h3 {
        margin-top: 0;
    }

    .item-card .description {
        max-height: 100px;
        overflow-y: auto;
    }

    .item-card .image-container {
        position: relative;
        max-width: 300px;
        margin: 10px 0;
    }

    .item-card .item-image {
        width: 100%;
        height: auto;
        max-height: 300px;
        display: none;
        object-fit: cover;
    }

    .item-card .item-image:first-child {
        display: block;
    }

    /* Navigation buttons */
    .navigation-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
    }

    .navigation-buttons .prev-button,
    .navigation-buttons .next-button {
        background-color: #007bff;
        color: #fff;
        border: none;
        cursor: pointer;
        padding: 10px;
        border-radius: 5px;
    }

    .navigation-buttons .prev-button:hover,
    .navigation-buttons .next-button:hover {
        background-color: #0056b3;
    }

    /* Modal styles */
    .item-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 5px;
        max-height: 70vh;
        overflow-y: auto;
    }

    .close-modal {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close-modal:hover,
    .close-modal:focus {
        color: black;
        text-decoration: none;
    }

    /* Form styles */
    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }

    .form-group textarea {
        min-height: 80px;
        resize: vertical;
    }

    .form-row {
        display: flex;
        gap: 15px;
    }

    .form-row .form-group {
        flex: 1;
    }

    .form-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }

    .save-button, .cancel-button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
    }

    .save-button {
        background-color: #28a745;
        color: white;
    }

    .save-button:hover {
        background-color: #218838;
    }

    .cancel-button {
        background-color: #6c757d;
        color: white;
    }

    .cancel-button:hover {
        background-color: #545b62;
    }

    .add-new-btn {
        background-color: #17a2b8;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.8em;
        margin-top: 5px;
    }

    .add-new-btn:hover {
        background-color: #138496;
    }

    /* Filter inputs for forms */
    .filter-inputs {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f8f9fa;
    }

    .filter-inputs h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #495057;
    }

    .multi-filter {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .filter-dropdown-select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
    }

    /* Highlight and status styles */
    .highlight-item {
        border: 3px solid gold !important;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.7) !important;
        position: relative;
        z-index: 10;
        animation: highlight-pulse 2s infinite;
    }

    .code-match {
        border: 2px solid #17a2b8 !important;
        box-shadow: 0 0 15px rgba(23, 162, 184, 0.5) !important;
        position: relative;
        z-index: 5;
    }

    .exact-code-match {
        border: 3px solid #28a745 !important;
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.7) !important;
        animation: highlight-pulse 2s infinite;
        position: relative;
        z-index: 11;
    }

    @keyframes highlight-pulse {
        0% { box-shadow: 0 0 15px rgba(40, 167, 69, 0.7); }
        50% { box-shadow: 0 0 30px rgba(40, 167, 69, 1); transform: scale(1.03); }
        100% { box-shadow: 0 0 15px rgba(40, 167, 69, 0.7); }
    }

    /* Messages */
    .error-message, .no-items-message {
        padding: 20px;
        text-align: center;
        width: 100%;
        color: #721c24;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 5px;
        margin: 20px 0;
    }

    /* Action Button Styles */
    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-start;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
        flex-wrap: wrap;
    }

    .modal-actions form {
        margin: 0;
    }

    .ausleihen, .edit-button, .delete-button, .details-button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.9rem;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        transition: all 0.3s ease;
        min-width: 100px;
    }

    /* Ausleihen/Zurückgeben Button */
    .ausleihen {
        background-color: #28a745;
        color: white;
        border: 2px solid #28a745;
    }

    .ausleihen:hover {
        background-color: #218838;
        border-color: #1e7e34;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }

    .ausleihen:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
    }

    /* Edit Button */
    .edit-button {
        background-color: #007bff;
        color: white;
        border: 2px solid #007bff;
    }

    .edit-button:hover {
        background-color: #0056b3;
        border-color: #004085;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        color: white;
        text-decoration: none;
    }

    .edit-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
    }

    /* Delete Button */
    .delete-button {
        background-color: #dc3545;
        color: white;
        border: 2px solid #dc3545;
    }

    .delete-button:hover {
        background-color: #c82333;
        border-color: #bd2130;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        color: white;
        text-decoration: none;
    }

    .delete-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }

    /* Details Button */
    .details-button {
        background-color: #17a2b8;
        color: white;
        border: 2px solid #17a2b8;
    }

    .details-button:hover {
        background-color: #138496;
        border-color: #117a8b;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
        color: white;
        text-decoration: none;
    }

    .details-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
    }

    /* Disabled Button */
    .disabled-button {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        color: #fff !important;
        cursor: not-allowed !important;
        opacity: 0.6;
    }

    .disabled-button:hover {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        transform: none !important;
        box-shadow: none !important;
    }

    /* Modal Details Styling */
    .modal-details {
        margin: 20px 0;
    }

    .detail-group {
        display: flex;
        margin-bottom: 10px;
        align-items: flex-start;
    }

    .detail-group.full-width {
        flex-direction: column;
        margin-bottom: 15px;
    }

    .detail-label {
        font-weight: bold;
        color: #495057;
        min-width: 150px;
        margin-right: 10px;
    }

    .detail-value {
        color: #212529;
        flex: 1;
        word-wrap: break-word;
    }

    .detail-group.full-width .detail-label {
        margin-bottom: 5px;
    }

    .detail-group.full-width .detail-value {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        white-space: pre-wrap;
    }

    .status-borrowed {
        color: #dc3545;
        font-weight: bold;
    }

    /* Modal Image Styling */
    .modal-image-container {
        position: relative;
        text-align: center;
        margin: 20px 0;
        max-height: 400px;
        overflow: hidden;
        border-radius: 8px;
        background-color: #f8f9fa;
    }

    .modal-image {
        max-width: 100%;
        max-height: 400px;
        object-fit: contain;
        border-radius: 4px;
    }

    .modal-image-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        padding: 15px 20px;
        font-size: 18px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.3s ease;
    }

    .modal-image-nav:hover {
        background-color: rgba(0, 0, 0, 0.9);
    }

    .modal-prev-image {
        left: 10px;
    }

    .modal-next-image {
        right: 10px;
    }

    .image-counter {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    /* Borrower Info Panel */
    .borrower-info-panel {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .borrower-info-panel h4 {
        color: #856404;
        margin: 0 0 10px 0;
        font-size: 1.1rem;
    }

    .borrower-name, .borrow-time {
        margin: 5px 0;
        color: #856404;
        font-weight: 500;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .filter-container {
            flex-direction: column;
        }
        
        .form-row {
            flex-direction: column;
        }
        
        .multi-filter {
            grid-template-columns: 1fr;
        }
    }

    /* Book information display styles */
    .book-info-container {
        margin-top: 10px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
        min-height: 40px;
    }

    .book-info {
        padding: 15px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-bottom: 10px;
    }

    .book-info h4 {
        color: #333;
        margin: 0 0 10px 0;
        font-size: 1.2em;
        font-weight: bold;
    }

    .book-info p {
        margin: 5px 0;
        color: #666;
        line-height: 1.4;
    }

    .book-thumbnail {
        max-width: 120px;
        max-height: 180px;
        float: right;
        margin: 0 0 10px 15px;
        border: 1px solid #ddd;
        border-radius: 3px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .book-description {
        clear: both;
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #eee;
    }

    .book-description h5 {
        color: #333;
        margin: 0 0 8px 0;
        font-size: 1em;
        font-weight: bold;
    }

    .book-description p {
        max-height: 150px;
        overflow-y: auto;
        padding: 5px;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 3px;
        font-size: 0.9em;
        line-height: 1.5;
    }

    /* Import button styling */
    .import-book-button {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        margin-top: 15px;
        transition: background-color 0.2s ease;
        display: block;
        width: 100%;
    }

    .import-book-button:hover {
        background-color: #218838;
    }

    .import-book-button:active {
        background-color: #1e7e34;
    }

    /* ISBN input group styling */
    .isbn-input-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .isbn-input-group input {
        flex: 1;
    }

    .fetch-isbn-button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        white-space: nowrap;
        transition: background-color 0.2s ease;
    }

    .fetch-isbn-button:hover {
        background-color: #0056b3;
    }

    /* Loading spinner */
    .loading-spinner {
        color: #007bff;
        font-style: italic;
        text-align: center;
        padding: 20px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }

    .loading-spinner::after {
        content: "...";
        animation: dots 1.5s steps(5, end) infinite;
    }

    @keyframes dots {
        0%, 20% { 
            color: rgba(0,0,0,0);
            text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);
        }
        40% { 
            color: #007bff;
            text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);
        }
        60% { 
            text-shadow: .25em 0 0 #007bff, .5em 0 0 rgba(0,0,0,0);
        }
        80%, 100% { 
            text-shadow: .25em 0 0 #007bff, .5em 0 0 #007bff;
        }
    }

    /* Error message styling */
    .error-message {
        color: #721c24;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        padding: 12px;
        margin: 10px 0;
        text-align: center;
        font-weight: 500;
    }

    /* Success message styling */
    .import-success-message {
        color: #155724;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 4px;
        padding: 12px;
        margin: 10px 0;
        text-align: center;
        font-weight: bold;
        animation: fadeInOut 3s ease;
    }

    @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(-10px); }
        10%, 90% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-10px); }
    }

    /* Code validation styling */
    .code-checking {
        background-color: #fff3cd !important;
        border-color: #ffc107 !important;
        position: relative;
    }

    .code-checking::after {
        content: "Prüfe...";
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.8em;
        color: #856404;
        font-style: italic;
    }

    .code-valid {
        background-color: #d4edda !important;
        border-color: #28a745 !important;
        color: #155724 !important;
    }

    .code-invalid {
        background-color: #f8d7da !important;
        border-color: #dc3545 !important;
        color: #721c24 !important;
    }

    /* Duplicate code popup styling */
    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        animation: overlayFadeIn 0.3s ease;
    }

    @keyframes overlayFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .duplicate-code-popup {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        text-align: center;
        position: relative;
        animation: popupSlideIn 0.3s ease;
    }

    @keyframes popupSlideIn {
        from { 
            opacity: 0; 
            transform: scale(0.8) translateY(-20px); 
        }
        to { 
            opacity: 1; 
            transform: scale(1) translateY(0); 
        }
    }

    .popup-content h3 {
        color: #dc3545;
        margin: 0 0 15px 0;
        font-size: 1.3em;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .popup-content h3::before {
        content: "⚠️";
        font-size: 1.2em;
    }

    .popup-content p {
        color: #333;
        margin: 15px 0;
        line-height: 1.5;
        font-size: 1em;
    }

    .popup-content .duplicate-code {
        font-weight: bold;
        color: #dc3545;
        background-color: #f8d7da;
        padding: 5px 10px;
        border-radius: 3px;
        font-family: monospace;
        font-size: 1.1em;
    }

    .popup-close-button {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        margin-top: 20px;
        transition: background-color 0.2s ease;
    }

    .popup-close-button:hover {
        background-color: #5a6268;
    }

    .popup-close-x {
        position: absolute;
        top: 10px;
        right: 15px;
        background: none;
        border: none;
        font-size: 24px;
        color: #999;
        cursor: pointer;
        padding: 5px;
        line-height: 1;
    }

    .popup-close-x:hover {
        color: #333;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .isbn-input-group {
            flex-direction: column;
            gap: 8px;
        }

        .fetch-isbn-button {
            width: 100%;
        }

        .book-thumbnail {
            float: none;
            display: block;
            margin: 10px auto;
        }

        .duplicate-code-popup {
            margin: 20px;
            width: calc(100% - 40px);
            padding: 20px;
        }

        .popup-content h3 {
            font-size: 1.1em;
        }
    }

    @media (max-width: 480px) {
        .book-info {
            padding: 10px;
        }

        .book-description p {
            max-height: 100px;
            font-size: 0.8em;
        }

        .duplicate-code-popup {
            padding: 15px;
        }

        .popup-content h3 {
            font-size: 1em;
        }

        .popup-content p {
            font-size: 0.9em;
        }
    }

    /* Item card action buttons */
    .actions {
        display: flex;
        gap: 8px;
        justify-content: flex-start;
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #dee2e6;
        flex-wrap: wrap;
    }

    .actions form {
        margin: 0;
        flex: 1;
        min-width: 80px;
    }

    .actions .ausleihen,
    .actions .edit-button,
    .actions .delete-button {
        width: 100%;
        font-size: 0.8rem;
        padding: 8px 12px;
        min-width: auto;
    }

    /* Borrower badge */
    .borrower-badge {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
        padding: 8px;
        margin-top: 10px;
        font-size: 0.85rem;
        color: #856404;
    }

    .borrower-badge strong {
        color: #533f03;
    }

    .borrow-time {
        font-size: 0.8rem;
        opacity: 0.8;
    }

    /* Image navigation buttons in item cards */
    .image-container {
        position: relative;
        margin: 10px 0;
        text-align: center;
    }

    .prev-image-button,
    .next-image-button {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
        border: none;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
        border-radius: 3px;
        transition: background-color 0.3s ease;
    }

    .prev-image-button:hover,
    .next-image-button:hover {
        background-color: rgba(0, 0, 0, 0.8);
    }

    .prev-image-button {
        left: 5px;
    }

    .next-image-button {
        right: 5px;
    }

    .item-image {
        max-width: 100%;
        max-height: 200px;
        object-fit: contain;
        border-radius: 4px;
    }

    /* ...existing code... */
</style>

<div class="container">
    <div class="content">
        <h1>Inventar Objekte</h1>
        <div class="filter-container">
            <div class="filter-group">
                <div class="filter-header">
                    <label>Unterrichtsfach:</label>
                    <button type="button" class="filter-toggle" onclick="toggleFilterDropdown('filter1-dropdown')">▼</button>
                    <button type="button" class="clear-filter" onclick="clearFilter(1)">Clear</button>
                </div>
                <div class="selected-filters" id="selected-filter1"></div>
                <div class="filter-dropdown" id="filter1-dropdown">
                    <div class="filter-options" id="filter1-options">
                        <!-- Filter options will be dynamically loaded here -->
                    </div>
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-header">
                    <label>Jahrgangsstufe:</label>
                    <button type="button" class="filter-toggle" onclick="toggleFilterDropdown('filter2-dropdown')">▼</button>
                    <button type="button" class="clear-filter" onclick="clearFilter(2)">Clear</button>
                </div>
                <div class="selected-filters" id="selected-filter2"></div>
                <div class="filter-dropdown" id="filter2-dropdown">
                    <div class="filter-options" id="filter2-options">
                        <!-- Filter options will be dynamically loaded here -->
                    </div>
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-header">
                    <label>Thema:</label>
                    <button type="button" class="filter-toggle" onclick="toggleFilterDropdown('filter3-dropdown')">▼</button>
                    <button type="button" class="clear-filter" onclick="clearFilter(3)">Clear</button>
                </div>
                <div class="selected-filters" id="selected-filter3"></div>
                <div class="filter-dropdown" id="filter3-dropdown">
                    <div class="filter-options" id="filter3-options">
                        <!-- Filter options will be dynamically loaded here -->
                    </div>
                </div>
            </div>

            <div class="filter-group search-field">
                <div class="filter-header">
                    <label for="code-search">Code suchen:</label>
                    <button type="button" class="clear-filter" onclick="clearCodeSearch()">Clear</button>
                </div>
                <div class="search-container">
                    <input type="text" id="code-search" placeholder="Code eingeben..." autocomplete="off">
                    <button type="button" class="search-button" onclick="searchByCode()">
                        <i class="fas fa-search"></i> Suchen
                    </button>
                </div>
            </div>
        </div>
        <div class="qr-container">
            <button id="scanButton" class="scan-button">Barcode scannen</button>
            <div id="qr-reader" style="width: 500px; display: none;"></div>
        </div>

        <div id="items-container" class="items-container">
            <!-- Items will be dynamically loaded here -->
        </div>
        <div class="navigation-buttons">
            <button class="prev-button" onclick="scrollPrev()">&#10094;</button>
            <button class="next-button" onclick="scrollNext()">&#10095;</button>
        </div>
    </div>
    <div id="item-modal" class="item-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="modal-content-wrapper">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Add the edit modal form -->
    <div id="edit-modal" class="item-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeEditModal()">&times;</span>
            <h2>Objekt bearbeiten</h2>
            <form id="edit-item-form" method="POST" enctype="multipart/form-data">
                <input type="hidden" id="edit-item-id" name="id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-name">Name:</label>
                        <input type="text" id="edit-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-location">Ort:</label>
                        <select id="edit-location" name="ort" required>
                            <option value="">-- Bitte Ort auswählen --</option>
                            <!-- Options will be loaded by JavaScript -->
                        </select>
                        <button type="button" class="add-new-btn" id="edit-add-new-location-btn">
                            Neuen Ort hinzufügen
                        </button>
                        <div id="edit-new-location-container" style="display: none; margin-top: 10px;">
                            <input type="text" id="edit-new-location-input" placeholder="Neuen Ort eingeben">
                            <button type="button" onclick="addNewLocation('edit')">Hinzufügen</button>
                            <button type="button" onclick="cancelAddLocation('edit')">Abbrechen</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-description">Beschreibung:</label>
                    <textarea id="edit-description" name="beschreibung" required></textarea>
                </div>
                
                <!-- Updated filter inputs for edit form with dropdowns -->
                <div class="filter-inputs">
                    <h3>Unterrichtsfach:</h3>
                    <div class="multi-filter">
                        <div class="form-group">
                            <label for="edit-filter1-1">Wert 1:</label>
                            <select id="edit-filter1-1" name="filter" class="filter-dropdown-select">
                                <option value="">-- Bitte auswählen --</option>
                                <!-- Options will be loaded by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-filter1-2">Wert 2:</label>
                            <select id="edit-filter1-2" name="filter" class="filter-dropdown-select">
                                <option value="">-- Optional --</option>
                                <!-- Options will be loaded by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-filter1-3">Wert 3:</label>
                            <select id="edit-filter1-3" name="filter" class="filter-dropdown-select">
                                <option value="">-- Optional --</option>
                                <!-- Options will be loaded by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-filter1-4">Wert 4:</label>
                            <select id="edit-filter1-4" name="filter" class="filter-dropdown-select">
                                <option value="">-- Optional --</option>
                                <!-- Options will be loaded by JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <h3>Jahrgangsstufe:</h3>
                    <div class="multi-filter">
                        <div class="form-group">
                            <label for="edit-filter2-1">Wert 1:</label>
                            <select id="edit-filter2-1" name="filter2" class="filter-dropdown-select">
                                <option value="">-- Bitte auswählen --</option>
                                <!-- Options will be loaded by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-filter2-2">Wert 2:</label>
                            <select id="edit-filter2-2" name="filter2" class="filter-dropdown-select">
                                <option value="">-- Optional --</option>
                                <!-- Options will be loaded by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-filter2-3">Wert 3:</label>
                            <select id="edit-filter2-3" name="filter2" class="filter-dropdown-select">
                                <option value="">-- Optional --</option>
                                <!-- Options will be loaded by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-filter2-4">Wert 4:</label>
                            <select id="edit-filter2-4" name="filter2" class="filter-dropdown-select">
                                <option value="">-- Optional --</option>
                                <!-- Options will be loaded by JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <h3>Thema:</h3>
                    <div class="multi-filter">
                        <div class="form-group">
                            <label for="edit-filter3-1">Wert 1:</label>
                            <input type="text" id="edit-filter3-1" name="filter3">
                        </div>
                        <div class="form-group">
                            <label for="edit-filter3-2">Wert 2:</label>
                            <input type="text" id="edit-filter3-2" name="filter3">
                        </div>
                        <div class="form-group">
                            <label for="edit-filter3-3">Wert 3:</label>
                            <input type="text" id="edit-filter3-3" name="filter3">
                        </div>
                        <div class="form-group">
                            <label for="edit-filter3-4">Wert 4:</label>
                            <input type="text" id="edit-filter3-4" name="filter3">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-year">Anschaffungsjahr:</label>
                    <input type="date" id="edit-year" name="anschaffungsjahr">
                </div>
                <div class="form-group">
                    <label for="edit-cost">Anschaffungskosten:</label>
                    <input id="edit-cost" name="anschaffungskosten">
                </div>
                <div class="form-group">
                    <label for="edit-code4">Code:</label>
                    <input id="edit-code4" name="code_4">
                </div>
                
                <!-- New section for managing images -->
                <div class="form-group">
                    <label>Vorhandene Bilder:</label>
                    <div id="edit-existing-images" class="existing-images-container">
                        <!-- Existing images will be added here dynamically -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-new-images">
                        <span>Neue Bilder hinzufügen:</span>
                        <span>(Bilder werden vom Original übernommen)</span>
                    </label>
                    <input type="file" id="edit-new-images" name="new_images" accept="image/*" multiple>
                    <!-- Add image preview container -->
                    <div class="image-preview-container" id="edit-image-preview-container"></div>
                </div>
                
                <div class="form-group">
                    <label for="edit-isbn">ISBN:</label>
                    <div class="isbn-input-group">
                        <input type="text" id="edit-isbn" name="isbn" placeholder="ISBN eingeben...">
                        <button type="button" class="fetch-isbn-button" onclick="fetchBookInfo('edit')">Buchinformationen abrufen</button>
                    </div>
                    <div id="edit-book-info-container" class="book-info-container"></div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="save-button">Speichern</button>
                    <button type="button" class="cancel-button" onclick="closeEditModal()">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Initialize template variables before any JavaScript code -->
<script>
    // Create a global object to hold server-side template values
    window.serverVars = {
        highlightItemId: {% if highlight_item is defined and highlight_item %}"{{ highlight_item }}"{% else %}null{% endif %}
    };
    
    window.isDebug = false; // Set to true only for development environment
</script>
<script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
<script>
    // Initialize QR Code scanner and global variables
    let html5QrcodeScanner = null;
    let codeSearchTerm = '';
    let currentUsername = '';
    let allItems = []; // Cache for all items
    
    // Get the highlight item ID from the pre-processed server variables
    let highlightItemId = window.serverVars.highlightItemId;
    
    // Global variables to store active filters (SINGLE DECLARATION)
    let activeFilters = {
        filter1: [],
        filter2: [],
        filter3: []
    };
    
    // Simplified no-op version of debug function for production
    function debugLog() {
        // No-op in production
        return;
    }
    
    document.getElementById('scanButton').addEventListener('click', function() {
        const qrReader = document.getElementById('qr-reader');
        
        if (qrReader.style.display === 'none') {
            qrReader.style.display = 'block';
            
            html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader", { fps: 10, qrbox: 250 }
            );
            
            html5QrcodeScanner.render((decodedText) => {
                html5QrcodeScanner.clear();
                qrReader.style.display = 'none';
                
                // Instead of navigating to the URL, put the scanned code in the search box
                const searchInput = document.getElementById('code-search');
                if (searchInput) {
                    searchInput.value = decodedText;
                    // Trigger search automatically
                    searchByCode();
                }
                
                // Reset the button text
                document.getElementById('scanButton').textContent = 'Barcode scannen';
            });
            
            this.textContent = 'Barcode Scanner schließen';
        } else {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
            }
            qrReader.style.display = 'none';
            this.textContent = 'Barcode scannen';
        }
    });

    function rebuildFilter3Options() {
        if (!allItems || allItems.length === 0) return;
        
        // Get current filter 1 and filter 2 selections
        const filter1Selections = activeFilters.filter1;
        const filter2Selections = activeFilters.filter2;
        
        // If both filters are empty, show all filter3 values
        if (filter1Selections.length === 0 && filter2Selections.length === 0) {
            // Get all unique filter3 values
            const allFilter3Values = new Set();
            allItems.forEach(item => {
                const filter3Array = Array.isArray(item.Filter3) ? item.Filter3 : 
                                     (item.Filter3 ? [item.Filter3] : []);
                
                filter3Array.forEach(value => {
                    if (value && typeof value === 'string' && value.trim() !== '') {
                        allFilter3Values.add(value);
                    }
                });
            });
            
            // Populate filter 3 dropdown with all values
            populateFilterOptions('filter3-options', [...allFilter3Values].sort(), 3);
            return;
        }
        
        // Filter items based on filter1 and filter2 selections
        const filteredItems = allItems.filter(item => {
            // Check if item passes Filter 1
            const filter1Array = Array.isArray(item.Filter) ? item.Filter : (item.Filter ? [item.Filter] : []);
            const filter1Match = filter1Selections.length === 0 || 
                filter1Selections.some(filter => {
                    // Extract value from filter (remove group prefix if exists)
                    const filterValue = filter.includes(':') ? filter.split(':')[1] : filter;
                    return filter1Array.includes(filterValue);
                });
            
            // Check if item passes Filter 2
            const filter2Array = Array.isArray(item.Filter2) ? item.Filter2 : (item.Filter2 ? [item.Filter2] : []);
            const filter2Match = filter2Selections.length === 0 || 
                filter2Selections.some(filter => {
                    // Extract value from filter (remove group prefix if exists)
                    const filterValue = filter.includes(':') ? filter.split(':')[1] : filter;
                    return filter2Array.includes(filterValue);
                });
            
            return filter1Match && filter2Match;
        });
        
        // Get unique Filter 3 values from filtered items
        const availableFilter3Values = new Set();
        filteredItems.forEach(item => {
            const filter3Array = Array.isArray(item.Filter3) ? item.Filter3 : (item.Filter3 ? [item.Filter3] : []);
            filter3Array.forEach(value => {
                if (value && typeof value === 'string' && value.trim() !== '') {
                    availableFilter3Values.add(value);
                }
            });
        });
        
        // Keep track of current filter 3 selections that are still valid
        const validFilter3Selections = [];
        activeFilters.filter3.forEach(filter => {
            // Extract value from filter (remove group prefix if exists)
            const filterValue = filter.includes(':') ? filter.split(':')[1] : filter;
            if (availableFilter3Values.has(filterValue)) {
                validFilter3Selections.push(filter);
            }
        });
        
        // Update active filter 3 selections (remove invalid ones)
        if (validFilter3Selections.length !== activeFilters.filter3.length) {
            activeFilters.filter3 = validFilter3Selections;
            updateSelectedFiltersDisplay(3);
            // No need to call applyFilters() here as it will be called after this function
        }
        
        // Populate filter 3 dropdown with only available values
        populateFilterOptions('filter3-options', [...availableFilter3Values].sort(), 3);
    }

    function rebuildFilter2Options() {
        if (!allItems || allItems.length === 0) return;
        
        // Get current filter 1 selections
        const filter1Selections = activeFilters.filter1;
        
        // If filter1 is empty, show all filter2 values
        if (filter1Selections.length === 0) {
            // Get all unique filter2 values
            const allFilter2Values = new Set();
            allItems.forEach(item => {
                const filter2Array = Array.isArray(item.Filter2) ? item.Filter2 : 
                                     (item.Filter2 ? [item.Filter2] : []);
                
                filter2Array.forEach(value => {
                    if (value && typeof value === 'string' && value.trim() !== '') {
                        allFilter2Values.add(value);
                    }
                });
            });
            
            // Populate filter 2 dropdown with all values
            populateFilterOptions('filter2-options', [...allFilter2Values].sort(), 2);
            return;
        }
        
        // Filter items based on filter1 selections
        const filteredItems = allItems.filter(item => {
            // Check if item passes Filter 1
            const filter1Array = Array.isArray(item.Filter) ? item.Filter : (item.Filter ? [item.Filter] : []);
            return filter1Selections.some(filter => {
                // Extract value from filter (remove group prefix if exists)
                const filterValue = filter.includes(':') ? filter.split(':')[1] : filter;
                return filter1Array.includes(filterValue);
            });
        });
        
        // Get unique Filter 2 values from filtered items
        const availableFilter2Values = new Set();
        filteredItems.forEach(item => {
            const filter2Array = Array.isArray(item.Filter2) ? item.Filter2 : (item.Filter2 ? [item.Filter2] : []);
            filter2Array.forEach(value => {
                if (value && typeof value === 'string' && value.trim() !== '') {
                    availableFilter2Values.add(value);
                }
            });
        });
        
        // Keep track of current filter 2 selections that are still valid
        const validFilter2Selections = [];
        activeFilters.filter2.forEach(filter => {
            // Extract value from filter (remove group prefix if exists)
            const filterValue = filter.includes(':') ? filter.split(':')[1] : filter;
            if (availableFilter2Values.has(filterValue)) {
                validFilter2Selections.push(filter);
            }
        });
        
        // Update active filter 2 selections (remove invalid ones)
        if (validFilter2Selections.length !== activeFilters.filter2.length) {
            activeFilters.filter2 = validFilter2Selections;
            updateSelectedFiltersDisplay(2);
            // No need to call applyFilters() here as it will be called after this function
        }
        
        // Populate filter 2 dropdown with only available values
        populateFilterOptions('filter2-options', [...availableFilter2Values].sort(), 2);
    }

    function saveFilterState() {
        localStorage.setItem('inventarSystemFilters', JSON.stringify(activeFilters));
    }
    
    function loadFilterState() {
        const savedFilters = localStorage.getItem('inventarSystemFilters');
        if (savedFilters) {
            try {
                // Parse saved filters
                const parsedFilters = JSON.parse(savedFilters);
                
                // Restore to active filters
                if (parsedFilters.filter1) activeFilters.filter1 = parsedFilters.filter1;
                if (parsedFilters.filter2) activeFilters.filter2 = parsedFilters.filter2;
                if (parsedFilters.filter3) activeFilters.filter3 = parsedFilters.filter3;
                
                // We'll rebuild Filter 3 options after items are loaded
            } catch (e) {
                console.error("Error loading saved filters:", e);
            }
        }
    }
    
    function clearFilterState() {
        localStorage.removeItem('inventarSystemFilters');
        // Reset active filters
        activeFilters = {
            filter1: [],
            filter2: [],
            filter3: []
        };
    }
    
    // Load predefined filter values for dropdowns
    function loadPredefinedFilterValues(filterNumber) {
        fetch(`/get_predefined_filter_values/${filterNumber}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // For edit modal dropdowns
                const editFilterSelects = [
                    document.getElementById(`edit-filter${filterNumber}-1`),
                    document.getElementById(`edit-filter${filterNumber}-2`),
                    document.getElementById(`edit-filter${filterNumber}-3`),
                    document.getElementById(`edit-filter${filterNumber}-4`)
                ];
                
                editFilterSelects.forEach(select => {
                    if (select) {
                        // Clear existing options except the first one
                        while (select.children.length > 1) {
                            select.removeChild(select.lastChild);
                        }
                        
                        // Add new options - data.values contains the array
                        data.values.forEach(filter => {
                            if (filter && filter.trim() !== '') {
                                const option = document.createElement('option');
                                option.value = filter;
                                option.textContent = filter;
                                select.appendChild(option);
                            }
                        });
                    }
                });
            })
            .catch(error => {
                console.error(`Error loading predefined filter ${filterNumber} values:`, error);
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Load saved filters
        loadFilterState();
        
        // Load predefined filter values for dropdowns
        loadPredefinedFilterValues(1);
        loadPredefinedFilterValues(2);
        
        // Set up edit form submission
        setupEditFormSubmission();
        
        // Set up add new location buttons
        const editAddLocationBtn = document.getElementById('edit-add-new-location-btn');
        if (editAddLocationBtn) {
            editAddLocationBtn.addEventListener('click', function() {
                const container = document.getElementById('edit-new-location-container');
                container.style.display = container.style.display === 'none' ? 'block' : 'none';
            });
        }
        
        // Find and attach event listener to all logout links
        const logoutLinks = document.querySelectorAll('a[href*="logout"]');
        logoutLinks.forEach(link => {
            link.addEventListener('click', function() {
                clearFilterState(); // Clear filters when logging out
            });
        });
        
        // Fetch user status to get current username
        fetch('/user_status')
            .then(response => response.json())
            .then(data => {
                currentUsername = data.username;
                // Now load items with username information
                loadItems();
            })
            .catch(error => {
                console.error('Error fetching user status:', error);
                loadItems(); // Load items anyway in case of error
            });

        // Add event listener for code search input
        const codeSearchInput = document.getElementById('code-search');
        if (codeSearchInput) {
            codeSearchInput.addEventListener('input', function() {
                // Use a small delay to avoid excessive filtering while typing
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    searchByCode();
                }, 300);
            });
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const itemModal = document.getElementById('item-modal');
            const editModal = document.getElementById('edit-modal');
            
            if (event.target === itemModal) {
                itemModal.style.display = 'none';
            }
            if (event.target === editModal) {
                editModal.style.display = 'none';
            }
        };

        // Set up code validation for edit form
        const editCodeField = document.getElementById('edit-code4');
        if (editCodeField) {
            editCodeField.addEventListener('blur', function() {
                const itemIdField = document.getElementById('edit-item-id');
                const excludeId = itemIdField ? itemIdField.value : null;
                validateCodeField(this, excludeId);
            });
        }
    });

    // Function to load items from server
    function loadItems() {
        fetch("{{ url_for('get_items') }}")
            .then(response => response.json())
            .then(data => {
                const itemsContainer = document.querySelector('#items-container');
                // Creating a Set to store unique filter values
                const filter1Values = new Set();
                const filter2Values = new Set();
                const filter3Values = new Set();
                
                // Store all items data globally for filter rebuilding
                allItems = data.items || [];
                
                // Clear the container first
                itemsContainer.innerHTML = '';
                
                if (!data.items || data.items.length === 0) {
                    itemsContainer.innerHTML = '<div class="no-items-message">Keine Objekte gefunden</div>';
                    return;
                }

                // Sort items by name in ascending order (A-Z)
                data.items.sort((a, b) => {
                    const nameA = a.Name ? a.Name.toLowerCase() : '';
                    const nameB = b.Name ? b.Name.toLowerCase() : '';
                    return nameA.localeCompare(nameB);
                });
                
                data.items.forEach(item => {
                    try {
                        const card = document.createElement('div');
                        card.classList.add('item-card');
                        card.classList.add('clickable-card');
                        
                        // Add highlight class if this is the item we're looking for
                        if (highlightItemId && item._id === highlightItemId) {
                            card.classList.add('highlight-item');
                            setTimeout(() => {
                                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 500);
                        }
                        
                        // Process and store filter values
                        const filter1Array = Array.isArray(item.Filter) ? item.Filter : (item.Filter ? [item.Filter] : []);
                        const filter2Array = Array.isArray(item.Filter2) ? item.Filter2 : (item.Filter2 ? [item.Filter2] : []);
                        const filter3Array = Array.isArray(item.Filter3) ? item.Filter3 : (item.Filter3 ? [item.Filter3] : []);
                        
                        // Store arrays on the card as data attributes
                        card.dataset.filter1 = JSON.stringify(filter1Array);
                        card.dataset.filter2 = JSON.stringify(filter2Array);
                        card.dataset.filter3 = JSON.stringify(filter3Array);
                        card.dataset.code = (item.Code_4 !== undefined && item.Code_4 !== null) ? 
                          String(item.Code_4).trim() : '';
        
                        // Add filter values to their respective sets
                        filter1Array.forEach(value => {
                            if (value && typeof value === 'string' && value.trim() !== '') {
                                filter1Values.add(value);
                            }
                        });
        
                        filter2Array.forEach(value => {
                            if (value && typeof value === 'string' && value.trim() !== '') {
                                filter2Values.add(value);
                            }
                        });
        
                        filter3Array.forEach(value => {
                            if (value && typeof value === 'string' && value.trim() !== '') {
                                filter3Values.add(value);
                            }
                        });

                        // Display first filter value or dash if none exist
                        const filter1Display = filter1Array.length > 0 ? filter1Array[0] : '-';
                        const filter2Display = filter2Array.length > 0 ? filter2Array[0] : '-';
                        const filter3Display = filter3Array.length > 0 ? filter3Array[0] : '-';
                        
                        // Additional filter values indicator
                        const filter1More = filter1Array.length > 1 ? ` (+${filter1Array.length - 1} mehr)` : '';
                        const filter2More = filter2Array.length > 1 ? ` (+${filter2Array.length - 1} mehr)` : '';
                        const filter3More = filter3Array.length > 1 ? ` (+${filter3Array.length - 1} mehr)` : '';

                        const imagesHtml = item.Images.map((image, index) => `<img src="{{ url_for('uploaded_file', filename='') }}${image}" alt="${item.Name}" class="item-image" data-index="${index}" style="display: ${index === 0 ? 'block' : 'none'};">`).join('');
                        
                        // Check if item is borrowed by current user
                        const isBorrowedByMe = !item.Verfuegbar && item.User === currentUsername;
                        
                        // Add borrower info badge if item is borrowed
                        let borrowerBadge = '';
                        if (!item.Verfuegbar && item.BorrowerInfo) {
                            borrowerBadge = `
                                <div class="borrower-badge">
                                    Ausgeliehen von: <strong>${item.BorrowerInfo.username}</strong>
                                    ${item.BorrowerInfo.borrowTime ? '<br><span class="borrow-time">Seit: ' + item.BorrowerInfo.borrowTime + '</span>' : ''}
                                </div>`;
                        }

                        card.innerHTML = `
                            <div class="card-content" data-item-id="${item._id}">
                                <h3>${item.Name}</h3>
                                <p><strong>Ort:</strong> ${item.Ort || '-'}</p>
                                <p><strong>Unterrichtsfach:</strong> ${filter1Display}${filter1More}</p>
                                <p><strong>Jahrgangsstufe:</strong> ${filter2Display}${filter2More}</p>
                                <p><strong>Thema:</strong> ${filter3Display}${filter3More}</p>
                                <p><strong>Barcode:</strong> ${item.Code_4 || '-'}</p>
                                <div class="image-container">
                                    ${imagesHtml}
                                    <button class="prev-image-button" onclick="prevImage(event)">&#10094;</button>
                                    <button class="next-image-button" onclick="nextImage(event)">&#10095;</button>
                                </div>
                                ${borrowerBadge}
                            </div>
                            <div class="actions">
                                ${item.Verfuegbar ? 
                                    `<form method="POST" action="{{ url_for('ausleihen', id='') }}${item._id}">
                                        <button class="ausleihen" type="submit">Ausleihen</button>
                                    </form>` 
                                : isBorrowedByMe ?
                                    `<form method="POST" action="{{ url_for('zurueckgeben', id='') }}${item._id}">
                                        <button class="ausleihen" type="submit">Zurückgeben</button>
                                    </form>`
                                :
                                    `<button class="ausleihen disabled-button" disabled>Ausgeliehen</button>`
                                }
                                <a href="{{ url_for('delete_item', id='') }}${item._id}" onclick="return confirm('Sind Sie sicher, dass Sie dieses Objekt löschen möchten?')">
                                    <button class="delete-button">Löschen</button>
                                </a>
                                <button class="edit-button" onclick="openEditModal('${item._id}')">Bearbeiten</button>
                            </div>
                        `;
                        itemsContainer.appendChild(card);
                        
                        // Add click event listeners to the card content area
                        const cardContent = card.querySelector('.card-content');
                        if (cardContent) {
                            cardContent.addEventListener('click', function(e) {
                                if (e.target.tagName === 'BUTTON' || 
                                    e.target.tagName === 'A' || 
                                    e.target.tagName === 'INPUT' ||
                                    e.target.closest('button') || 
                                    e.target.closest('a') || 
                                    e.target.closest('.image-container')) {
                                    return;
                                }
                                
                                e.stopPropagation();
                                
                                const modalItemData = {...item};
                                modalItemData.Images = item.Images.map(img => "{{ url_for('uploaded_file', filename='') }}" + img);
                                
                                openItemModal(modalItemData);
                            });
                        }
                    } catch (err) {
                        console.error('Error processing item:', err, item);
                    }
                });
                
                // Populate filter options
                populateFilterOptions('filter1-options', [...filter1Values].sort(), 1);
                populateFilterOptions('filter2-options', [...filter2Values].sort(), 2);
                populateFilterOptions('filter3-options', [...filter3Values].sort(), 3);
                
                itemsContainer.scrollLeft = 0;
                applyFilters();

                // Rebuild filters if needed
                if (activeFilters.filter1.length > 0) {
                    rebuildFilter2Options();
                }
                if (activeFilters.filter1.length > 0 || activeFilters.filter2.length > 0) {
                    rebuildFilter3Options();
                }
            })
            .catch(error => {
                console.error('Error fetching items:', error);
                const itemsContainer = document.querySelector('#items-container');
                itemsContainer.innerHTML = 
                    '<div class="error-message">Fehler beim Laden der Objekte. Bitte versuchen Sie es später erneut.</div>';
            });
    }

    function searchByCode() {
        const searchInput = document.getElementById('code-search');
        const rawSearchTerm = searchInput.value;
        codeSearchTerm = rawSearchTerm.trim().toLowerCase();
        
        searchInput.classList.add('searching');
        
        const itemsContainer = document.querySelector('#items-container');
        const allCards = itemsContainer.querySelectorAll('.item-card');
        allCards.forEach(card => {
            card.classList.remove('highlight-item', 'code-match', 'exact-code-match');
        });
        
        applyFilters(true);
        
        setTimeout(() => {
            searchInput.classList.remove('searching');
        }, 500);
    }

    function applyFilters(isDirectSearch = false) {
        const itemsContainer = document.querySelector('#items-container');
        const items = itemsContainer.querySelectorAll('.item-card');
        
        let visibleCount = 0;
        let codeMatchCount = 0;
        let exactMatchCount = 0;
        let firstMatchedCard = null;
        let exactMatchCard = null;
        
        const searchTerm = codeSearchTerm ? codeSearchTerm.trim().toLowerCase() : '';
        const isCodeSearch = searchTerm.length > 0;
        
        items.forEach(item => {
            const itemFilter1 = item.dataset.filter1;
            const itemFilter2 = item.dataset.filter2;
            const itemFilter3 = item.dataset.filter3;
            const rawCode = item.dataset.code || '';
            const itemCode = rawCode.trim().toLowerCase();
            
            const matchesFilter1 = checkFilterMatch(activeFilters.filter1, itemFilter1);
            const matchesFilter2 = checkFilterMatch(activeFilters.filter2, itemFilter2);
            const matchesFilter3 = checkFilterMatch(activeFilters.filter3, itemFilter3);
            const passesAllFilters = matchesFilter1 && matchesFilter2 && matchesFilter3;
            
            let matchesCodeSearch = !isCodeSearch || itemCode.includes(searchTerm);
            let exactCodeMatch = isCodeSearch && itemCode === searchTerm;
            
            if (passesAllFilters && matchesCodeSearch) {
                item.style.display = 'block';
                visibleCount++;
                
                if (exactCodeMatch) {
                    item.classList.add('highlight-item', 'exact-code-match');
                    exactMatchCount++;
                    if (!exactMatchCard) {
                        exactMatchCard = item;
                    }
                } else if (isCodeSearch && itemCode.includes(searchTerm)) {
                    item.classList.add('code-match');
                    codeMatchCount++;
                    if (!firstMatchedCard) {
                        firstMatchedCard = item;
                    }
                }
            } else {
                item.style.display = 'none';
            }
        });
        
        if (isCodeSearch && visibleCount > 0 && (codeMatchCount > 0 || exactMatchCount > 0)) {
            setTimeout(() => {
                const cardToHighlight = exactMatchCard || firstMatchedCard;
                
                if (cardToHighlight) {
                    centerCardInView(cardToHighlight, itemsContainer);
                    applyAttentionAnimation(cardToHighlight);
                }
            }, 300);
        }
    }

    function checkFilterMatch(activeFilters, itemFilterData) {
        if (activeFilters.length === 0) return true;
        
        let itemFilterArray;
        try {
            itemFilterArray = JSON.parse(itemFilterData || '[]');
        } catch {
            itemFilterArray = [];
        }
        
        return activeFilters.some(filter => {
            const filterValue = filter.includes(':') ? filter.split(':')[1] : filter;
            return itemFilterArray.includes(filterValue);
        });
    }

    function centerCardInView(card, container) {
        card.style.display = 'block';
        
        const containerRect = container.getBoundingClientRect();
        const cardRect = card.getBoundingClientRect();
        
        const scrollPosition = card.offsetLeft - (containerRect.width/2) + (cardRect.width/2);
        
        container.scrollTo({
            left: scrollPosition,
            behavior: 'smooth'
        });
    }

    function applyAttentionAnimation(card) {
        card.getAnimations().forEach(anim => anim.cancel());
        
        card.animate([
            { transform: 'scale(1)', boxShadow: '0 0 15px rgba(40, 167, 69, 0.7)' },
            { transform: 'scale(1.08)', boxShadow: '0 0 25px rgba(40, 167, 69, 1)' },
            { transform: 'scale(1)', boxShadow: '0 0 15px rgba(40, 167, 69, 0.7)' }
        ], {
            duration: 800,
            iterations: 3,
            easing: 'ease-in-out'
        });
        
        card.animate([
            { backgroundColor: 'white' },
            { backgroundColor: 'rgba(40, 167, 69, 0.1)' },
            { backgroundColor: 'white' }
        ], {
            duration: 800,
            iterations: 3,
            easing: 'ease-in-out'
        });
    }

    function clearCodeSearch() {
        const searchInput = document.getElementById('code-search');
        searchInput.value = '';
        codeSearchTerm = '';
        
        const itemsContainer = document.querySelector('#items-container');
        const allCards = itemsContainer.querySelectorAll('.item-card');
        allCards.forEach(card => {
            card.classList.remove('highlight-item', 'code-match', 'exact-code-match');
        });
        
        applyFilters();
    }

    function openItemModal(item) {
        const modal = document.getElementById('item-modal');
        const modalContent = document.getElementById('modal-content-wrapper');
        
        const filter1Array = Array.isArray(item.Filter) ? item.Filter : (item.Filter ? [item.Filter] : []);
        const filter2Array = Array.isArray(item.Filter2) ? item.Filter2 : (item.Filter2 ? [item.Filter2] : []);
        const filter3Array = Array.isArray(item.Filter3) ? item.Filter3 : (item.Filter3 ? [item.Filter3] : []);
        
        const imagesHtml = item.Images ? item.Images.map((image, index) => 
            `<img src="${image}" alt="${item.Name}" class="modal-image" id="modal-image-${index}" 
             style="display: ${index === 0 ? 'block' : 'none'};">`).join('') : '';
        
        const isBorrowed = !item.Verfuegbar;
        
        let borrowerInfoHtml = '';
        if (isBorrowed && item.BorrowerInfo) {
            borrowerInfoHtml = `
                <div class="borrower-info-panel">
                    <h4>Ausleihstatus</h4>
                    <p class="borrower-name">Ausgeliehen von: ${item.BorrowerInfo.username}</p>
                    <p class="borrow-time">Seit: ${item.BorrowerInfo.borrowTime || 'Unbekannt'}</p>
                </div>
            `;
        }
        
        modalContent.innerHTML = `
            <h2>${item.Name}</h2>
            ${borrowerInfoHtml}
            
            <div class="modal-image-container">
                ${imagesHtml}
                ${item.Images && item.Images.length > 1 ? `
                    <button class="modal-image-nav modal-prev-image" onclick="changeModalImage(-1)">&#10094;</button>
                    <button class="modal-image-nav modal-next-image" onclick="changeModalImage(1)">&#10095;</button>
                    <div class="image-counter">1/${item.Images.length}</div>
                ` : ''}
            </div>
            
            <div class="modal-details">
                <div class="detail-group">
                    <div class="detail-label">Ort:</div>
                    <div class="detail-value">${item.Ort || '-'}</div>
                </div>
                
                <div class="detail-group">
                    <div class="detail-label">Status:</div>
                    <div class="detail-value ${isBorrowed ? 'status-borrowed' : ''}">
                        ${isBorrowed ? 'Ausgeliehen' : 'Verfügbar'}
                    </div>
                </div>
                
                <div class="detail-group">
                    <div class="detail-label">Unterrichtsfach:</div>
                    <div class="detail-value">${filter1Array.join(', ') || '-'}</div>
                </div>
                
                <div class="detail-group">
                    <div class="detail-label">Jahrgangsstufe:</div>
                    <div class="detail-value">${filter2Array.join(', ') || '-'}</div>
                </div>
                
                <div class="detail-group">
                    <div class="detail-label">Thema:</div>
                    <div class="detail-value">${filter3Array.join(', ') || '-'}</div>
                </div>
                
                <div class="detail-group">
                    <div class="detail-label">Code:</div>
                    <div class="detail-value">${item.Code_4 || '-'}</div>
                </div>
                
                <div class="detail-group">
                    <div class="detail-label">Anschaffungsjahr:</div>
                    <div class="detail-value">${item.Anschaffungsjahr || '-'}</div>
                </div>
                
                <div class="detail-group">
                    <div class="detail-label">Anschaffungskosten:</div>
                    <div class="detail-value">${item.Anschaffungskosten || '-'}</div>
                </div>
                
                <div class="detail-group full-width">
                    <div class="detail-label">Beschreibung:</div>
                    <div class="detail-value">${item.Beschreibung || '-'}</div>
                </div>
            </div>
            
            <div class="modal-actions">
                ${item.Verfuegbar ? 
                    `<form method="POST" action="/ausleihen/${item._id}">
                        <button class="ausleihen" type="submit">Ausleihen</button>
                    </form>` 
                    : (item.User === currentUsername) ?
                    `<form method="POST" action="/zurueckgeben/${item._id}">
                        <button class="ausleihen" type="submit">Zurückgeben</button>
                    </form>`
                    : `<button class="ausleihen disabled-button" disabled>Ausgeliehen</button>`
                }
                <button class="edit-button" onclick="openEditModal('${item._id}')">Bearbeiten</button>
                <a href="/delete_item/${item._id}" onclick="return confirm('Sind Sie sicher?')">
                    <button class="delete-button">Löschen</button>
                </a>
            </div>
        `;
        
        modal.style.display = 'block';
        
        const closeButton = modal.querySelector('.close-modal');
        closeButton.onclick = function() {
            modal.style.display = 'none';
        };
        
        window.currentModalImageIndex = 0;
        window.totalModalImages = item.Images ? item.Images.length : 0;
    }

    function changeModalImage(direction) {
        const currentIndex = window.currentModalImageIndex;
        const total = window.totalModalImages;
        
        if (total <= 1) return;
        
        document.getElementById(`modal-image-${currentIndex}`).style.display = 'none';
        
        let newIndex = (currentIndex + direction) % total;
        if (newIndex < 0) newIndex = total - 1;
        
        document.getElementById(`modal-image-${newIndex}`).style.display = 'block';
        
        const counter = document.querySelector('.image-counter');
        if (counter) counter.textContent = `${newIndex + 1}/${total}`;
        
        window.currentModalImageIndex = newIndex;
    }
    
    function scrollPrev() {
        const container = document.querySelector('#items-container');
        const cardWidth = container.querySelector('.item-card')?.offsetWidth || 300;
        const gap = 20;
        
        container.scrollBy({
            left: -1 * (cardWidth + gap),
            behavior: 'smooth'
        });
    }

    function scrollNext() {
        const container = document.querySelector('#items-container');
        const cardWidth = container.querySelector('.item-card')?.offsetWidth || 300;
        const gap = 20;
        
        container.scrollBy({
            left: cardWidth + gap,
            behavior: 'smooth'
        });
    }

    function prevImage(event) {
        event.stopPropagation();
        const container = event.target.closest('.image-container');
        const images = container.querySelectorAll('.item-image');
        let currentIndex = Array.from(images).findIndex(img => img.style.display === 'block');
        
        images[currentIndex].style.display = 'none';
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        images[currentIndex].style.display = 'block';
    }

    function nextImage(event) {
        event.stopPropagation();
        const container = event.target.closest('.image-container');
        const images = container.querySelectorAll('.item-image');
        let currentIndex = Array.from(images).findIndex(img => img.style.display === 'block');
        
        images[currentIndex].style.display = 'none';
        currentIndex = (currentIndex + 1) % images.length;
        images[currentIndex].style.display = 'block';
    }
    
    function toggleFilterDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        
        document.querySelectorAll('.filter-dropdown').forEach(dd => {
            if (dd.id !== dropdownId) {
                dd.style.display = 'none';
            }
        });
        
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }

    function clearFilter(filterNum) {
        activeFilters[`filter${filterNum}`] = [];
        document.getElementById(`selected-filter${filterNum}`).innerHTML = '';
        
        const checkboxes = document.querySelectorAll(`#filter${filterNum}-options input[type="checkbox"]`);
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        if (filterNum === 1) {
            rebuildFilter2Options();
            rebuildFilter3Options();
        } else if (filterNum === 2) {
            rebuildFilter3Options();
        }
        
        saveFilterState();
        applyFilters();
    }

    function updateFilter(filterNum, value, isChecked, group = '') {
        const filterKey = `filter${filterNum}`;
        const filterValue = group ? `${group}:${value}` : value;
        
        if (isChecked) {
            if (!activeFilters[filterKey].includes(filterValue)) {
                activeFilters[filterKey].push(filterValue);
            }
        } else {
            activeFilters[filterKey] = activeFilters[filterKey].filter(v => v !== filterValue);
        }
        
        updateSelectedFiltersDisplay(filterNum);
        
        if (filterNum === 1) {
            rebuildFilter2Options();
            rebuildFilter3Options();
        } else if (filterNum === 2) {
            rebuildFilter3Options();
        }
        
        saveFilterState();
        applyFilters();
    }

    function updateSelectedFiltersDisplay(filterNum) {
        const container = document.getElementById(`selected-filter${filterNum}`);
        container.innerHTML = '';
        
        activeFilters[`filter${filterNum}`].forEach(filter => {
            let displayValue = filter;
            let groupName = '';
            
            if (filter.includes(':')) {
                [groupName, displayValue] = filter.split(':');
            }
            
            const tag = document.createElement('div');
            tag.className = 'filter-tag';
            
            let tagContent = '';
            if (groupName) {
                tagContent += `<span class="filter-tag-group">${groupName}:</span>`;
            }
            
            tagContent += displayValue;
            tagContent += `<button class="filter-tag-remove" onclick="removeFilter(${filterNum}, '${filter}')">&times;</button>`;
            
            tag.innerHTML = tagContent;
            container.appendChild(tag);
        });
    }

    function removeFilter(filterNum, filter) {
        const filterKey = `filter${filterNum}`;
        
        activeFilters[filterKey] = activeFilters[filterKey].filter(f => f !== filter);
        
        updateSelectedFiltersDisplay(filterNum);
        
        let value = filter;
        let group = '';
        
        if (filter.includes(':')) {
            [group, value] = filter.split(':');
        }
        
        const checkboxes = document.querySelectorAll(`#filter${filterNum}-options input[type="checkbox"]`);
        checkboxes.forEach(checkbox => {
            if ((checkbox.value === value) && 
                ((!group && !checkbox.dataset.group) || 
                 (group && checkbox.dataset.group === group))) {
                checkbox.checked = false;
            }
        });
        
        if (filterNum === 1) {
            rebuildFilter2Options();
            rebuildFilter3Options();
        } else if (filterNum === 2) {
            rebuildFilter3Options();
        }
        
        saveFilterState();
        applyFilters();
    }

    function populateFilterOptions(containerId, filterValues, filterNum) {
        const container = document.getElementById(containerId);
        if (!container) {
            return;
        }
        
        container.innerHTML = '';
        
        const groupedValues = {};
        
        filterValues.forEach(value => {
            if (!value) return;
            
            let group = 'Default';
            let displayValue = value;
            
            if (typeof value === 'string' && value.includes(':')) {
                [group, displayValue] = value.split(':', 2);
            }
            
            if (!groupedValues[group]) {
                groupedValues[group] = [];
            }
            
            groupedValues[group].push(displayValue);
        });
        
        Object.keys(groupedValues).sort().forEach(group => {
            if (!groupedValues[group].length) return;
            
            if (Object.keys(groupedValues).length > 1 && group !== 'Default') {
                const groupHeader = document.createElement('div');
                groupHeader.className = 'filter-group-header';
                groupHeader.textContent = group;
                container.appendChild(groupHeader);
            }
            
            const groupContainer = document.createElement('div');
            groupContainer.className = 'filter-option-group';
            
            groupedValues[group].sort().forEach(value => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'filter-option';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = value;
                checkbox.dataset.group = group !== 'Default' ? group : '';
                
                const filterValue = group !== 'Default' ? `${group}:${value}` : value;
                checkbox.checked = activeFilters[`filter${filterNum}`].includes(filterValue);
                
                checkbox.addEventListener('change', function() {
                    updateFilter(filterNum, value, this.checked, group !== 'Default' ? group : '');
                });
                
                const label = document.createElement('label');
                label.textContent = value;
                label.prepend(checkbox);
                
                optionDiv.appendChild(label);
                groupContainer.appendChild(optionDiv);
            });
            
            container.appendChild(groupContainer);
        });
    }

    // Edit modal functions
    function openEditModal(itemId) {
        // Find the item data from allItems array
        const item = allItems.find(i => i._id === itemId);
        if (!item) {
            console.error('Item not found:', itemId);
            return;
        }

        // Populate the edit form with current item data
        document.getElementById('edit-item-id').value = item._id;
        document.getElementById('edit-name').value = item.Name || '';
        document.getElementById('edit-description').value = item.Beschreibung || '';
        document.getElementById('edit-code4').value = item.Code_4 || '';
        document.getElementById('edit-year').value = item.Anschaffungsjahr || '';
        document.getElementById('edit-cost').value = item.Anschaffungskosten || '';

        // Load location options
        loadLocationOptions();

        // Set the current location
        setTimeout(() => {
            const locationSelect = document.getElementById('edit-location');
            if (locationSelect && item.Ort) {
                locationSelect.value = item.Ort;
            }
        }, 100);

        // Handle filter arrays - set current values
        const filter1Array = Array.isArray(item.Filter) ? item.Filter : (item.Filter ? [item.Filter] : []);
        const filter2Array = Array.isArray(item.Filter2) ? item.Filter2 : (item.Filter2 ? [item.Filter2] : []);
        const filter3Array = Array.isArray(item.Filter3) ? item.Filter3 : (item.Filter3 ? [item.Filter3] : []);

        // Set filter dropdowns (up to 4 each)
        for (let i = 1; i <= 4; i++) {
            // Filter 1
            const filter1Select = document.getElementById(`edit-filter1-${i}`);
            if (filter1Select) {
                filter1Select.value = filter1Array[i-1] || '';
            }
            
            // Filter 2
            const filter2Select = document.getElementById(`edit-filter2-${i}`);
            if (filter2Select) {
                filter2Select.value = filter2Array[i-1] || '';
            }
            
            // Filter 3
            const filter3Select = document.getElementById(`edit-filter3-${i}`);
            if (filter3Select) {
                filter3Select.value = filter3Array[i-1] || '';
            }
        }

        // Show the modal
        document.getElementById('edit-modal').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('edit-modal').style.display = 'none';
    }

    function loadLocationOptions() {
        fetch('/get_predefined_locations')
            .then(response => response.json())
            .then(data => {
                const locationSelect = document.getElementById('edit-location');
                if (locationSelect && data.locations) {
                    // Clear existing options except the first one
                    while (locationSelect.children.length > 1) {
                        locationSelect.removeChild(locationSelect.lastChild);
                    }
                    
                    // Add location options
                    data.locations.forEach(location => {
                        const option = document.createElement('option');
                        option.value = location;
                        option.textContent = location;
                        locationSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading locations:', error);
            });
    }

    function addNewLocation(context) {
        const inputField = document.getElementById(`${context}-new-location-input`);
        const newLocation = inputField.value.trim();
        
        if (!newLocation) {
            alert('Bitte geben Sie einen Ortsnamen ein.');
            return;
        }
        
        // Send request to add new location
        fetch('/add_location', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ location: newLocation })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload location options
                loadLocationOptions();
                
                // Hide the new location input
                document.getElementById(`${context}-new-location-container`).style.display = 'none';
                inputField.value = '';
                
                // Set the newly added location as selected
                setTimeout(() => {
                    const locationSelect = document.getElementById(`${context}-location`);
                    if (locationSelect) {
                        locationSelect.value = newLocation;
                    }
                }, 100);
            } else {
                alert('Fehler beim Hinzufügen des Ortes: ' + (data.message || 'Unbekannter Fehler'));
            }
        })
        .catch(error => {
            console.error('Error adding location:', error);
            alert('Fehler beim Hinzufügen des Ortes.');
        });
    }
    
    function cancelAddLocation(context) {
        const container = document.getElementById(`${context}-new-location-container`);
        const inputField = document.getElementById(`${context}-new-location-input`);
        
        container.style.display = 'none';
        inputField.value = '';
    }

    // Set up form submission handler for edit form
    function setupEditFormSubmission() {
        const editForm = document.getElementById('edit-item-form');
        if (editForm) {
            editForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(editForm);
                const itemId = document.getElementById('edit-item-id').value;
                
                // Set the form action to the edit endpoint
                formData.append('_method', 'PUT'); // Some frameworks use this for PUT requests
                
                fetch(`/edit_item/${itemId}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Network response was not ok');
                })
                .then(data => {
                    if (data.success) {
                        // Close modal and reload items
                        closeEditModal();
                        loadItems();
                        
                        // Show success message
                        alert('Objekt wurde erfolgreich aktualisiert!');
                    } else {
                        alert('Fehler beim Speichern: ' + (data.message || 'Unbekannter Fehler'));
                    }
                })
                .catch(error => {
                    console.error('Error updating item:', error);
                    alert('Fehler beim Speichern des Objekts.');
                });
            });
        }
    }

    // Function to fetch book information (for ISBN lookup)
    function fetchBookInfo(context) {
        const isbnField = document.getElementById(`${context}-isbn`);
        const isbn = isbnField.value.trim();
        
        if (!isbn) {
            alert('Bitte geben Sie eine ISBN ein.');
            return;
        }
        
        const infoContainer = document.getElementById(`${context}-book-info-container`);
        infoContainer.innerHTML = '<div style="padding: 10px; text-align: center;">Lade Buchinformationen...</div>';
        
        fetch('/fetch_book_info', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ isbn: isbn })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.book_info) {
                const bookInfo = data.book_info;
                
                // Auto-fill form fields if they're empty
                const nameField = document.getElementById(`${context}-name`);
                const descField = document.getElementById(`${context}-description`);
                
                if (nameField && !nameField.value && bookInfo.title) {
                    nameField.value = bookInfo.title;
                }
                
                if (descField && !descField.value && bookInfo.description) {
                    descField.value = bookInfo.description;
                }
                
                // Display book information
                let bookHtml = `
                    <div class="book-info">
                        <h4>${bookInfo.title || 'Unbekannt'}</h4>
                        ${bookInfo.thumbnail ? `<img src="${bookInfo.thumbnail}" alt="Buchcover" class="book-thumbnail">` : ''}
                        <p><strong>Autor(en):</strong> ${bookInfo.authors ? bookInfo.authors.join(', ') : 'Unbekannt'}</p>
                        <p><strong>Verlag:</strong> ${bookInfo.publisher || 'Unbekannt'}</p>
                        <p><strong>Erscheinungsdatum:</strong> ${bookInfo.publishedDate || 'Unbekannt'}</p>
                        <p><strong>Seiten:</strong> ${bookInfo.pageCount || 'Unbekannt'}</p>
                        <p><strong>Kategorien:</strong> ${bookInfo.categories ? bookInfo.categories.join(', ') : 'Unbekannt'}</p>
                `;
                
                if (bookInfo.description) {
                    bookHtml += `
                        <div class="book-description">
                            <h5>Beschreibung:</h5>
                            <p>${bookInfo.description}</p>
                        </div>
                    `;
                }
                
                bookHtml += `
                        <button type="button" class="import-book-button" onclick="importBookInfo('${context}')">
                            Buchinformationen übernehmen
                        </button>
                    </div>
                `;
                
                infoContainer.innerHTML = bookHtml;
                
                // Store book info for later use
                window.currentBookInfo = bookInfo;
            } else {
                infoContainer.innerHTML = `
                    <div style="padding: 10px; color: #dc3545; border: 1px solid #f5c6cb; background-color: #f8d7da; border-radius: 4px;">
                        Keine Buchinformationen gefunden oder Fehler beim Abrufen der Daten.
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching book info:', error);
            infoContainer.innerHTML = `
                <div style="padding: 10px; color: #dc3545; border: 1px solid #f5c6cb; background-color: #f8d7da; border-radius: 4px;">
                    Fehler beim Abrufen der Buchinformationen.
                </div>
            `;
        });
    }
    
    function importBookInfo(context) {
        if (!window.currentBookInfo) {
            alert('Keine Buchinformationen zum Importieren verfügbar.');
            return;
        }
        
        const bookInfo = window.currentBookInfo;
        
        // Fill form fields
        const nameField = document.getElementById(`${context}-name`);
        const descField = document.getElementById(`${context}-description`);
        
        if (nameField && bookInfo.title) {
            nameField.value = bookInfo.title;
        }
        
        if (descField && bookInfo.description) {
            descField.value = bookInfo.description;
        }
        
        // Clear the book info display
        const infoContainer = document.getElementById(`${context}-book-info-container`);
        infoContainer.innerHTML = '<div style="padding: 10px; color: #28a745; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px;">Buchinformationen wurden übernommen!</div>';
        
        // Clear the timeout if it exists
        if (window.clearBookInfoTimeout) {
            clearTimeout(window.clearBookInfoTimeout);
        }
        
        // Clear the success message after 3 seconds
        window.clearBookInfoTimeout = setTimeout(() => {
            infoContainer.innerHTML = '';
        }, 3000);
    }
</script>
{% endblock %}